
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>kadi.commands.validate &#8212; kadi 7.8.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/bootstrap-astropy.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/plot_directive.css" />
    
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <script type="text/javascript" src="../../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../../_static/copybutton.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../../index.html"><span id="logotext1">Ska!</span><span id="logotext2">Kadi</span><span id="logotext3"></span></a>
  <ul>
    
    <li><a class="home" title="Homepage" href="https://sot.github.io/">
        <span id="logotext1">ska</span><span id="logotext2">tools</span>
    </a></li>
    <li><a title="General Index" href="../../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../../index.html">kadi 7.8.0 documentation</a>
	 &#187;
      </li>
      <li><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for kadi.commands.validate</h1><div class="highlight"><pre>
<span></span><span class="c1"># Licensed under a 3-clause BSD style license - see LICENSE.rst</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Validate kadi command states against telemetry.</span>

<span class="sd">This is a set of classes that validate the kadi command states against</span>
<span class="sd">Chandra telemetry.  The classes are designed to be run either standalone</span>
<span class="sd">or from the command-line application ``kadi_validate_states`` (defined in</span>
<span class="sd">``kadi.scripts.validate_states``).</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">import</span> <span class="nn">jinja2</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">plotly.graph_objects</span> <span class="k">as</span> <span class="nn">pgo</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">ska_tdb</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">cheta.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">NoTelemetryError</span><span class="p">,</span>
    <span class="n">get_ofp_states</span><span class="p">,</span>
    <span class="n">get_telem_table</span><span class="p">,</span>
    <span class="n">logical_intervals</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">cxotime</span> <span class="kn">import</span> <span class="n">CxoTime</span><span class="p">,</span> <span class="n">CxoTimeLike</span>

<span class="kn">import</span> <span class="nn">kadi</span>
<span class="kn">import</span> <span class="nn">kadi.commands</span>
<span class="kn">from</span> <span class="nn">kadi.commands.states</span> <span class="kn">import</span> <span class="n">interpolate_states</span><span class="p">,</span> <span class="n">reduce_states</span>
<span class="kn">from</span> <span class="nn">kadi.commands.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">add_figure_regions</span><span class="p">,</span>
    <span class="n">compress_time_series</span><span class="p">,</span>
    <span class="n">convert_state_code_to_raw_val</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;PlotAttrs&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Validate&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ValidatePitch&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ValidateRoll&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ValidateSimpos&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ValidateObsid&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ValidateDither&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ValidatePcadMode&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ValidateLETG&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ValidateHETG&quot;</span><span class="p">,</span>
    <span class="s2">&quot;get_command_sheet_exclude_intervals&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># URL to download exclude Times google sheet</span>
<span class="c1"># See https://stackoverflow.com/questions/33713084 (2nd answer)</span>
<span class="n">EXCLUDE_INTERVALS_SHEET_URL</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;https://docs.google.com/spreadsheets/d/</span><span class="si">{doc_id}</span><span class="s2">/export?&quot;</span>
    <span class="s2">&quot;format=csv&quot;</span>
    <span class="s2">&quot;&amp;id=</span><span class="si">{doc_id}</span><span class="s2">&quot;</span>
    <span class="s2">&quot;&amp;gid=</span><span class="si">{gid}</span><span class="s2">&quot;</span>
<span class="p">)</span>


<div class="viewcode-block" id="PlotAttrs"><a class="viewcode-back" href="../../../api_validation.html#kadi.commands.validate.PlotAttrs">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">PlotAttrs</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot attributes for a Validate subclass.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    title : str</span>
<span class="sd">        Plot title.</span>
<span class="sd">    ylabel : str</span>
<span class="sd">        Y-axis label.</span>
<span class="sd">    range : list, optional</span>
<span class="sd">        Y-axis range.</span>
<span class="sd">    max_delta_time : float, optional</span>
<span class="sd">        Maximum time delta before a new data point is plotted.</span>
<span class="sd">    max_delta_val : float, default 0</span>
<span class="sd">        Maximum value delta before a new data point is plotted.</span>
<span class="sd">    max_gap_time : float, default 300</span>
<span class="sd">        Maximum gap in time before a plot gap is inserted.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">ylabel</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">range</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">max_delta_time</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">max_delta_val</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">max_gap_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">300</span></div>


<div class="viewcode-block" id="Validate"><a class="viewcode-back" href="../../../api_validation.html#kadi.commands.validate.Validate">[docs]</a><span class="k">class</span> <span class="nc">Validate</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate kadi command states against telemetry base class.</span>

<span class="sd">    Class attributes are as follows:</span>

<span class="sd">    state_name : str</span>
<span class="sd">        Name of state to validate.</span>
<span class="sd">    stop : CxoTime</span>
<span class="sd">        Stop time.</span>
<span class="sd">    days : float</span>
<span class="sd">        Number of days to validate.</span>
<span class="sd">    state_keys_extra : list, optional</span>
<span class="sd">        Extra state keys needed for validation.</span>
<span class="sd">    plot_attrs : PlotAttrs</span>
<span class="sd">        Attributes for plot.</span>
<span class="sd">    msids : list</span>
<span class="sd">        MSIDs to fetch for telemetry.</span>
<span class="sd">    max_delta_val : float</span>
<span class="sd">        Maximum value delta to signal a violation.</span>
<span class="sd">    max_gap : float</span>
<span class="sd">        Maximum gap in telemetry before breaking an interval (sec).</span>
<span class="sd">    min_violation_duration : float</span>
<span class="sd">        Minimum duration of a violation (sec).</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    stop</span>
<span class="sd">        stop time for validation</span>
<span class="sd">    days</span>
<span class="sd">        number of days for validation</span>
<span class="sd">    no_exclude</span>
<span class="sd">        if True then do not exclude any data (for testing)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">subclasses</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Abstract attributes (no elegant solution as of Python 3.11)</span>
    <span class="n">state_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">stop</span><span class="p">:</span> <span class="n">CxoTime</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">days</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">state_keys_extra</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">plot_attrs</span><span class="p">:</span> <span class="n">PlotAttrs</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">msids</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">max_delta_val</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">max_gap</span> <span class="o">=</span> <span class="mi">300</span>
    <span class="n">min_violation_duration</span> <span class="o">=</span> <span class="mf">32.81</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">days</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="n">no_exclude</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Base class for validation&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="n">CxoTime</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">days</span> <span class="o">=</span> <span class="n">days</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">:</span> <span class="n">CxoTime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="n">days</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">day</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_exclude</span> <span class="o">=</span> <span class="n">no_exclude</span>

        <span class="c1"># Get the exclude intervals from the google sheet along with any auto-generated</span>
        <span class="c1"># ones. This creates self.exclude_intervals which is a Table. By virtue of `tlm`</span>
        <span class="c1"># and `states` properties that get used, this also creates self.tlm and</span>
        <span class="c1"># self.states.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_exclude_intervals</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init_subclass__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init_subclass__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">state_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">subclasses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">cached_property</span>
    <span class="k">def</span> <span class="nf">tlm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Fetching telemetry for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">msids</span><span class="si">}</span><span class="s2"> between </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="o">.</span><span class="n">date</span><span class="si">}</span><span class="s2"> and&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="o">.</span><span class="n">date</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">_tlm</span> <span class="o">=</span> <span class="n">get_telem_table</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_tlm</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NoTelemetryError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No telemetry for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">msids</span><span class="si">}</span><span class="s2"> between </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="o">.</span><span class="n">date</span><span class="si">}</span><span class="s2"> and&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="o">.</span><span class="n">date</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">_tlm</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">times</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tlm</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">msid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate classes have first MSID as primary telemetry. Override as needed.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">msids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">cached_property</span>
    <span class="k">def</span> <span class="nf">states</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">state_name</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_keys_extra</span> <span class="ow">or</span> <span class="p">[])</span>
        <span class="n">_states</span> <span class="o">=</span> <span class="n">get_states</span><span class="p">(</span>
            <span class="n">start</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tlm</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">stop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tlm</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">state_keys</span><span class="o">=</span><span class="n">state_keys</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">_states</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">cached_property</span>
    <span class="k">def</span> <span class="nf">exclude_intervals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Intervals that are excluded from state validation.</span>

<span class="sd">        This includes manually excluded times from the Command Events sheet</span>
<span class="sd">        (e.g. within a few minutes of an IU-reset), or auto-generated</span>
<span class="sd">        state-specific intervals like not validating pitch when in NMM.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_exclude_intervals</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
            <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;stop&quot;</span><span class="p">,</span> <span class="s2">&quot;states&quot;</span><span class="p">,</span> <span class="s2">&quot;comment&quot;</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">_exclude_intervals</span>

<div class="viewcode-block" id="Validate.add_exclude_intervals"><a class="viewcode-back" href="../../../api_validation.html#kadi.commands.validate.Validate.add_exclude_intervals">[docs]</a>    <span class="k">def</span> <span class="nf">add_exclude_intervals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Base method to exclude intervals, starting with intervals defined in the</span>
<span class="sd">        Chandra Command Events Google Sheet.</span>

<span class="sd">        This method gets called at the end of self.tlm.</span>

<span class="sd">        Subclasses can override this method to add additional intervals to exclude,</span>
<span class="sd">        making sure to call super().add_exclude_intervals() first.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">exclude_intervals</span> <span class="o">=</span> <span class="n">get_command_sheet_exclude_intervals</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">exclude_intervals</span><span class="p">:</span>
            <span class="n">states</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;states&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;states&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_name</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_exclude_interval</span><span class="p">(</span>
                    <span class="n">start</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">],</span>
                    <span class="n">stop</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;stop&quot;</span><span class="p">],</span>
                    <span class="n">comment</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;comment&quot;</span><span class="p">],</span>
                    <span class="n">source</span><span class="o">=</span><span class="s2">&quot;Command Events sheet&quot;</span><span class="p">,</span>
                <span class="p">)</span></div>

<div class="viewcode-block" id="Validate.add_exclude_interval"><a class="viewcode-back" href="../../../api_validation.html#kadi.commands.validate.Validate.add_exclude_interval">[docs]</a>    <span class="k">def</span> <span class="nf">add_exclude_interval</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">start</span><span class="p">:</span> <span class="n">CxoTimeLike</span><span class="p">,</span>
        <span class="n">stop</span><span class="p">:</span> <span class="n">CxoTimeLike</span><span class="p">,</span>
        <span class="n">comment</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">pad_start</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pad_stop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Auto-generated&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add an interval to the exclude_intervals table</span>

<span class="sd">        The ``start`` / ``stop`` times are padded by ``pad_start`` and</span>
<span class="sd">        ``pad_stop`` (which are a Quantity objects with time units).</span>

<span class="sd">        ``manual`` is a boolean that is used to indicate whether the interval was</span>
<span class="sd">        manually specified in the command sheet. Non-manual intervals are annotated</span>
<span class="sd">        in the table accordingly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># For testing, we can skip all exclude intervals to generate violations</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_exclude</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">CxoTime</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pad_start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">start</span> <span class="o">-</span> <span class="n">pad_start</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="n">CxoTime</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pad_stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">+</span> <span class="n">pad_stop</span>

        <span class="c1"># Ensure interval is contained within validation interval.</span>
        <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="ow">or</span> <span class="n">stop</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">stop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>

        <span class="n">exclude</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="n">start</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
            <span class="s2">&quot;stop&quot;</span><span class="p">:</span> <span class="n">stop</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
            <span class="s2">&quot;states&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_name</span><span class="p">,</span>
            <span class="s2">&quot;comment&quot;</span><span class="p">:</span> <span class="n">comment</span><span class="p">,</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">source</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">state_name</span><span class="si">}</span><span class="s2">: excluding interval </span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">stop</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">comment</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exclude_intervals</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span><span class="n">exclude</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exclude_intervals</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Validate.exclude_ofp_intervals_except"><a class="viewcode-back" href="../../../api_validation.html#kadi.commands.validate.Validate.exclude_ofp_intervals_except">[docs]</a>    <span class="k">def</span> <span class="nf">exclude_ofp_intervals_except</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states_expected</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Exclude intervals where OFP (on-board flight program) is not in the expected</span>
<span class="sd">        state.</span>

<span class="sd">        This includes a padding of 30 minutes after SAFE mode and 5 minutes for non-NRML</span>
<span class="sd">        states other than SAFE like STUP, SYON, SYSF etc.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ofp_states</span> <span class="o">=</span> <span class="n">get_ofp_states</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">ofp_states</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">states_expected</span><span class="p">:</span>
                <span class="n">pad_stop</span> <span class="o">=</span> <span class="mi">30</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">min</span> <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;SAFE&quot;</span> <span class="k">else</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">min</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_exclude_interval</span><span class="p">(</span>
                    <span class="n">start</span><span class="o">=</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;datestart&quot;</span><span class="p">],</span>
                    <span class="n">stop</span><span class="o">=</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;datestop&quot;</span><span class="p">],</span>
                    <span class="n">pad_stop</span><span class="o">=</span><span class="n">pad_stop</span><span class="p">,</span>
                    <span class="n">comment</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;CONLOFP=</span><span class="si">{</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span></div>

<div class="viewcode-block" id="Validate.exclude_srdc_intervals"><a class="viewcode-back" href="../../../api_validation.html#kadi.commands.validate.Validate.exclude_srdc_intervals">[docs]</a>    <span class="k">def</span> <span class="nf">exclude_srdc_intervals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check for SRDC&#39;s and exclude them from validation.&quot;&quot;&quot;</span>
        <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">min</span>  <span class="c1"># Catch SRDC start just before interval</span>
        <span class="n">cmds</span> <span class="o">=</span> <span class="n">kadi</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">get_cmds</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="n">tlmsid</span><span class="o">=</span><span class="s2">&quot;COACTSX&quot;</span><span class="p">)</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">cmds</span><span class="p">[</span><span class="s2">&quot;coacts1&quot;</span><span class="p">],</span> <span class="p">[</span><span class="mi">142</span><span class="p">,</span> <span class="mi">143</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">cmds</span><span class="p">[</span><span class="n">ok</span><span class="p">]:</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">CxoTime</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_exclude_interval</span><span class="p">(</span>
                <span class="n">start</span><span class="o">=</span><span class="n">date</span><span class="p">,</span>
                <span class="n">stop</span><span class="o">=</span><span class="n">date</span> <span class="o">+</span> <span class="mi">13</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">min</span><span class="p">,</span>
                <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;SRDC&quot;</span><span class="p">,</span>
            <span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tlm_vals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the reference telemetry value for this Validation subclass</span>

<span class="sd">        That means the quantity derived from telemetry that gets compared to</span>
<span class="sd">        the states that come from kadi commands. This might be a single MSID</span>
<span class="sd">        (e.g. for pitch) or it might be something more complicated (e.g. for</span>
<span class="sd">        pointing which comes from 3 quaternion components).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">cached_property</span>
    <span class="k">def</span> <span class="nf">states_at_times</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the states that correspond to the telemetry times&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">interpolate_states</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="p">)</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">cached_property</span>
    <span class="k">def</span> <span class="nf">state_vals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">states_at_times</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">state_name</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">cached_property</span>
    <span class="k">def</span> <span class="nf">violations</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Table</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_violations</span><span class="p">()</span>

<div class="viewcode-block" id="Validate.get_violations_mask"><a class="viewcode-back" href="../../../api_validation.html#kadi.commands.validate.Validate.get_violations_mask">[docs]</a>    <span class="k">def</span> <span class="nf">get_violations_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the violations mask for this validation class</span>

<span class="sd">        This is the default implementation for most validation classes which just checks</span>
<span class="sd">        that the telemetry value is within ``max_delta_val`` of the state value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tlm_vals</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_vals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_delta_val</span>
        <span class="k">return</span> <span class="n">bad</span></div>

<div class="viewcode-block" id="Validate.get_violations"><a class="viewcode-back" href="../../../api_validation.html#kadi.commands.validate.Validate.get_violations">[docs]</a>    <span class="k">def</span> <span class="nf">get_violations</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Table</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the violations mask for this validation class</span>

<span class="sd">        This is the main method for each validation class. It returns a Table</span>
<span class="sd">        with the columns ``start`` and ``stop`` which are date strings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">violations_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_violations_mask</span><span class="p">()</span>
        <span class="n">mask_ok</span> <span class="o">=</span> <span class="n">get_overlap_mask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exclude_intervals</span><span class="p">)</span>
        <span class="n">violations_mask</span><span class="p">[</span><span class="n">mask_ok</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">intervals</span> <span class="o">=</span> <span class="n">logical_intervals</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="p">,</span> <span class="n">violations_mask</span><span class="p">,</span> <span class="n">max_gap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_gap</span><span class="p">,</span> <span class="n">complete_intervals</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">intervals</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_violation_duration</span>
        <span class="n">intervals</span> <span class="o">=</span> <span class="n">intervals</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">intervals</span><span class="p">[</span><span class="s2">&quot;datestart&quot;</span><span class="p">]</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;stop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">intervals</span><span class="p">[</span><span class="s2">&quot;datestop&quot;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">out</span></div>

    <span class="k">def</span> <span class="nf">get_plot_figure</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pgo</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
        <span class="n">state_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_vals</span>
        <span class="n">tlm_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tlm_vals</span>
        <span class="n">times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tlm</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">pgo</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;Telem&quot;</span><span class="p">,</span> <span class="s2">&quot;#1f77b4&quot;</span><span class="p">,</span> <span class="n">tlm_vals</span><span class="p">),</span>  <span class="c1"># muted blue</span>
            <span class="p">(</span><span class="s2">&quot;State&quot;</span><span class="p">,</span> <span class="s2">&quot;#ff7f0e&quot;</span><span class="p">,</span> <span class="n">state_vals</span><span class="p">),</span>  <span class="c1"># safety orange</span>
        <span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Compressing </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> data for state </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">state_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">tm</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">compress_time_series</span><span class="p">(</span>
                <span class="n">times</span><span class="p">,</span>
                <span class="n">vals</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_attrs</span><span class="o">.</span><span class="n">max_delta_val</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_attrs</span><span class="o">.</span><span class="n">max_delta_time</span><span class="p">,</span>
                <span class="n">max_gap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_attrs</span><span class="o">.</span><span class="n">max_gap_time</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> scatter plot for state </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">state_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Note: would be nice to use Scattergl here since performance is good,</span>
            <span class="c1"># but it seems to have a bug where connectgaps=False does not work,</span>
            <span class="c1"># sometimes.</span>
            <span class="c1"># env CHETA_FETCH_DATA_GAP=&quot;--start=2022:300 --stop=2022:301&quot; \</span>
            <span class="c1">#   python -m kadi.scripts.validate_states \</span>
            <span class="c1">#     --days=4 --stop=2022:301:01:00:00 --state hetg</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">pgo</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="n">x</span><span class="o">=</span><span class="n">CxoTime</span><span class="p">(</span><span class="n">tm</span><span class="p">)</span><span class="o">.</span><span class="n">datetime64</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines+markers&quot;</span><span class="p">,</span>
                <span class="n">line</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">color</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span>
                <span class="n">opacity</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span>
                <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;opacity&quot;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">},</span>
                <span class="n">hovertemplate</span><span class="o">=</span><span class="s2">&quot;%{x|%Y:%j:%H:%M:%S} %</span><span class="si">{y}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Date&quot;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_attrs</span><span class="o">.</span><span class="n">ylabel</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_attrs</span><span class="o">.</span><span class="n">range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="nb">range</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_attrs</span><span class="o">.</span><span class="n">range</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">()</span>

        <span class="n">add_figure_regions</span><span class="p">(</span>
            <span class="n">fig</span><span class="p">,</span>
            <span class="n">figure_start</span><span class="o">=</span><span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">figure_stop</span><span class="o">=</span><span class="n">times</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">region_starts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exclude_intervals</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">],</span>
            <span class="n">region_stops</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exclude_intervals</span><span class="p">[</span><span class="s2">&quot;stop&quot;</span><span class="p">],</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
            <span class="n">opacity</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">add_figure_regions</span><span class="p">(</span>
            <span class="n">fig</span><span class="p">,</span>
            <span class="n">figure_start</span><span class="o">=</span><span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">figure_stop</span><span class="o">=</span><span class="n">times</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">region_starts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">violations</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">],</span>
            <span class="n">region_stops</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">violations</span><span class="p">[</span><span class="s2">&quot;stop&quot;</span><span class="p">],</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
            <span class="n">opacity</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span>

    <span class="k">def</span> <span class="nf">get_plot_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_plot_figure</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating HTML for state </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">state_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">to_html</span><span class="p">(</span>
            <span class="n">full_html</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">include_plotlyjs</span><span class="o">=</span><span class="s2">&quot;cdn&quot;</span><span class="p">,</span>
            <span class="n">default_width</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
            <span class="n">default_height</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">html</span>

<div class="viewcode-block" id="Validate.get_context"><a class="viewcode-back" href="../../../api_validation.html#kadi.commands.validate.Validate.get_context">[docs]</a>    <span class="k">def</span> <span class="nf">get_context</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the standard context for a jinja2 template.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_attrs</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2"> (state name = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">state_name</span><span class="si">!r}</span><span class="s2">)&quot;</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">context</span><span class="p">[</span><span class="s2">&quot;plot_html&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_plot_html</span><span class="p">()</span>
        <span class="n">context</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">title</span>
        <span class="n">context</span><span class="p">[</span><span class="s2">&quot;state_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_name</span>
        <span class="n">context</span><span class="p">[</span><span class="s2">&quot;violations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">violations</span>
        <span class="n">context</span><span class="p">[</span><span class="s2">&quot;exclude_intervals&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exclude_intervals</span>
        <span class="k">return</span> <span class="n">context</span></div>

<div class="viewcode-block" id="Validate.get_html"><a class="viewcode-back" href="../../../api_validation.html#kadi.commands.validate.Validate.get_html">[docs]</a>    <span class="k">def</span> <span class="nf">get_html</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">template_text</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get HTML for validator including section header, violations, and plot</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        context</span>
<span class="sd">            optional dict of context for jinja2 template</span>
<span class="sd">        template_text</span>
<span class="sd">            optional Jinja2 template text</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            HTML string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_context</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">template_text</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">template_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;templates&quot;</span> <span class="o">/</span> <span class="s2">&quot;state_validate.html&quot;</span>
            <span class="n">template_text</span> <span class="o">=</span> <span class="n">template_file</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">jinja2</span><span class="o">.</span><span class="n">Template</span><span class="p">(</span><span class="n">template_text</span><span class="p">)</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">html</span></div></div>


<span class="k">class</span> <span class="nc">ValidateSingleMsid</span><span class="p">(</span><span class="n">Validate</span><span class="p">):</span>
    <span class="nd">@functools</span><span class="o">.</span><span class="n">cached_property</span>
    <span class="k">def</span> <span class="nf">tlm_vals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tlm</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">msid</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">ValidateStateCode</span><span class="p">(</span><span class="n">Validate</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for validation of state with state codes like PCAD_MODE&quot;&quot;&quot;</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">cached_property</span>
    <span class="k">def</span> <span class="nf">state_codes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Table</span><span class="p">:</span>
        <span class="n">tsc</span> <span class="o">=</span> <span class="n">ska_tdb</span><span class="o">.</span><span class="n">msids</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Tsc</span>
        <span class="n">_state_codes</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
            <span class="p">[</span><span class="n">tsc</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;LOW_RAW_COUNT&quot;</span><span class="p">],</span> <span class="n">tsc</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;STATE_CODE&quot;</span><span class="p">]],</span>
            <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;raw_val&quot;</span><span class="p">,</span> <span class="s2">&quot;state_code&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">_state_codes</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;raw_val&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_state_codes</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">cached_property</span>
    <span class="k">def</span> <span class="nf">tlm_vals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">convert_state_code_to_raw_val</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tlm</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">msid</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_codes</span><span class="p">)</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">cached_property</span>
    <span class="k">def</span> <span class="nf">state_vals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">states_interp</span> <span class="o">=</span> <span class="n">interpolate_states</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tlm</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">])</span>
        <span class="n">_state_vals</span> <span class="o">=</span> <span class="n">convert_state_code_to_raw_val</span><span class="p">(</span>
            <span class="n">states_interp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">state_name</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_codes</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">_state_vals</span>

    <span class="k">def</span> <span class="nf">get_plot_figure</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pgo</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_plot_figure</span><span class="p">()</span>
        <span class="n">yaxis</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">tickmode</span><span class="o">=</span><span class="s2">&quot;array&quot;</span><span class="p">,</span>
            <span class="n">tickvals</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_codes</span><span class="p">[</span><span class="s2">&quot;raw_val&quot;</span><span class="p">]),</span>
            <span class="n">ticktext</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_codes</span><span class="p">[</span><span class="s2">&quot;state_code&quot;</span><span class="p">]),</span>
        <span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">yaxis</span><span class="o">=</span><span class="n">yaxis</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span>

    <span class="k">def</span> <span class="nf">make_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">make_plot</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_codes</span><span class="p">[</span><span class="s2">&quot;raw_val&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_codes</span><span class="p">[</span><span class="s2">&quot;state_code&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>


<span class="k">class</span> <span class="nc">ValidatePitchRollBase</span><span class="p">(</span><span class="n">ValidateSingleMsid</span><span class="p">):</span>
    <span class="c1"># This subclass uses a different max_delta_val for each pcad_mode</span>
    <span class="n">max_delta_vals</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">get_violations_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the violations mask for the pitch validation class</span>

<span class="sd">        This is the main method for each validation class. It returns a Table</span>
<span class="sd">        with the columns ``start`` and ``stop`` which are date strings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">pcad_mode</span><span class="p">,</span> <span class="n">max_delta_val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_delta_vals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">states_at_times</span><span class="p">[</span><span class="s2">&quot;pcad_mode&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pcad_mode</span>
            <span class="n">bad</span> <span class="o">|=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tlm_vals</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_vals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_delta_val</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span>

        <span class="k">return</span> <span class="n">bad</span>

    <span class="k">def</span> <span class="nf">add_exclude_intervals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Exclude any intervals where online flight processing is not normal or safe</span>
<span class="sd">        mode&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_exclude_intervals</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exclude_ofp_intervals_except</span><span class="p">(</span><span class="n">states_expected</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;NRML&quot;</span><span class="p">,</span> <span class="s2">&quot;SAFE&quot;</span><span class="p">])</span>

        <span class="c1"># Find any NSUN intervals and exclude the first 45 minutes during which</span>
        <span class="c1"># the maneuver to normal sun occurs.</span>
        <span class="n">states_pcad_mode</span> <span class="o">=</span> <span class="n">reduce_states</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">,</span> <span class="n">state_keys</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;pcad_mode&quot;</span><span class="p">],</span> <span class="n">merge_identical</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states_pcad_mode</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;pcad_mode&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;NSUN&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_exclude_interval</span><span class="p">(</span>
                    <span class="n">state</span><span class="p">[</span><span class="s2">&quot;datestart&quot;</span><span class="p">],</span>
                    <span class="n">state</span><span class="p">[</span><span class="s2">&quot;datestart&quot;</span><span class="p">],</span>
                    <span class="n">pad_stop</span><span class="o">=</span><span class="mi">45</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">min</span><span class="p">,</span>
                    <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;NSUN maneuver&quot;</span><span class="p">,</span>
                <span class="p">)</span>


<div class="viewcode-block" id="ValidatePitch"><a class="viewcode-back" href="../../../api_validation.html#kadi.commands.validate.ValidatePitch">[docs]</a><span class="k">class</span> <span class="nc">ValidatePitch</span><span class="p">(</span><span class="n">ValidatePitchRollBase</span><span class="p">):</span>
    <span class="n">state_name</span> <span class="o">=</span> <span class="s2">&quot;pitch&quot;</span>
    <span class="n">msids</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;pitch_comp&quot;</span><span class="p">]</span>
    <span class="n">state_keys_extra</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;pcad_mode&quot;</span><span class="p">]</span>
    <span class="n">plot_attrs</span> <span class="o">=</span> <span class="n">PlotAttrs</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Pitch&quot;</span><span class="p">,</span>
        <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Pitch (degrees)&quot;</span><span class="p">,</span>
        <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="mi">40</span><span class="p">,</span> <span class="mi">180</span><span class="p">],</span>
        <span class="n">max_delta_time</span><span class="o">=</span><span class="mi">3600</span><span class="p">,</span>  <span class="c1"># sec</span>
        <span class="n">max_delta_val</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>  <span class="c1"># deg</span>
    <span class="p">)</span>
    <span class="n">max_delta_vals</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;NPNT&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>  <span class="c1"># deg</span>
        <span class="s2">&quot;NMAN&quot;</span><span class="p">:</span> <span class="mf">20.0</span><span class="p">,</span>  <span class="c1"># deg</span>
        <span class="s2">&quot;NSUN&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>  <span class="c1"># deg</span>
    <span class="p">}</span></div>


<div class="viewcode-block" id="ValidateRoll"><a class="viewcode-back" href="../../../api_validation.html#kadi.commands.validate.ValidateRoll">[docs]</a><span class="k">class</span> <span class="nc">ValidateRoll</span><span class="p">(</span><span class="n">ValidatePitchRollBase</span><span class="p">):</span>
    <span class="n">state_name</span> <span class="o">=</span> <span class="s2">&quot;off_nom_roll&quot;</span>
    <span class="n">msids</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;roll_comp&quot;</span><span class="p">]</span>
    <span class="n">state_keys_extra</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;pitch&quot;</span><span class="p">,</span> <span class="s2">&quot;pcad_mode&quot;</span><span class="p">]</span>
    <span class="n">plot_attrs</span> <span class="o">=</span> <span class="n">PlotAttrs</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Off-nominal roll&quot;</span><span class="p">,</span>
        <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;off_nom_roll (degrees)&quot;</span><span class="p">,</span>
        <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">],</span>
        <span class="n">max_delta_time</span><span class="o">=</span><span class="mi">3600</span><span class="p">,</span>  <span class="c1"># sec</span>
        <span class="n">max_delta_val</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>  <span class="c1"># deg</span>
    <span class="p">)</span>
    <span class="n">max_delta_vals</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;NPNT&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># deg</span>
        <span class="s2">&quot;NMAN&quot;</span><span class="p">:</span> <span class="mf">12.0</span><span class="p">,</span>  <span class="c1"># deg</span>
        <span class="s2">&quot;NSUN&quot;</span><span class="p">:</span> <span class="mf">4.0</span><span class="p">,</span>  <span class="c1"># deg</span>
    <span class="p">}</span></div>


<div class="viewcode-block" id="ValidateDither"><a class="viewcode-back" href="../../../api_validation.html#kadi.commands.validate.ValidateDither">[docs]</a><span class="k">class</span> <span class="nc">ValidateDither</span><span class="p">(</span><span class="n">ValidateStateCode</span><span class="p">):</span>
    <span class="n">state_name</span> <span class="o">=</span> <span class="s2">&quot;dither&quot;</span>
    <span class="n">msids</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;aodithen&quot;</span><span class="p">]</span>
    <span class="n">plot_attrs</span> <span class="o">=</span> <span class="n">PlotAttrs</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Dither enable&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Dither&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="ValidateDither.add_exclude_intervals"><a class="viewcode-back" href="../../../api_validation.html#kadi.commands.validate.ValidateDither.add_exclude_intervals">[docs]</a>    <span class="k">def</span> <span class="nf">add_exclude_intervals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_exclude_intervals</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exclude_ofp_intervals_except</span><span class="p">([</span><span class="s2">&quot;NRML&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exclude_srdc_intervals</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="ValidatePcadMode"><a class="viewcode-back" href="../../../api_validation.html#kadi.commands.validate.ValidatePcadMode">[docs]</a><span class="k">class</span> <span class="nc">ValidatePcadMode</span><span class="p">(</span><span class="n">ValidateStateCode</span><span class="p">):</span>
    <span class="n">state_name</span> <span class="o">=</span> <span class="s2">&quot;pcad_mode&quot;</span>
    <span class="n">msids</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;aopcadmd&quot;</span><span class="p">]</span>
    <span class="n">plot_attrs</span> <span class="o">=</span> <span class="n">PlotAttrs</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;PCAD mode&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;PCAD mode&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="ValidatePcadMode.add_exclude_intervals"><a class="viewcode-back" href="../../../api_validation.html#kadi.commands.validate.ValidatePcadMode.add_exclude_intervals">[docs]</a>    <span class="k">def</span> <span class="nf">add_exclude_intervals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_exclude_intervals</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exclude_ofp_intervals_except</span><span class="p">([</span><span class="s2">&quot;NRML&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exclude_srdc_intervals</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="ValidateSimpos"><a class="viewcode-back" href="../../../api_validation.html#kadi.commands.validate.ValidateSimpos">[docs]</a><span class="k">class</span> <span class="nc">ValidateSimpos</span><span class="p">(</span><span class="n">ValidateSingleMsid</span><span class="p">):</span>
    <span class="n">state_name</span> <span class="o">=</span> <span class="s2">&quot;simpos&quot;</span>
    <span class="n">msids</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;3tscpos&quot;</span><span class="p">]</span>
    <span class="n">plot_attrs</span> <span class="o">=</span> <span class="n">PlotAttrs</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;TSCPOS (SIM-Z)&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;SIM-Z (steps)&quot;</span><span class="p">,</span> <span class="n">max_delta_val</span><span class="o">=</span><span class="mi">10</span>
    <span class="p">)</span>  <span class="c1"># steps</span>
    <span class="n">max_delta_val</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># steps</span>
    <span class="c1"># Skip over SIM moves and transient out-of-state values</span>
    <span class="n">min_violation_duration</span> <span class="o">=</span> <span class="mi">420</span>  <span class="c1"># seconds</span></div>


<div class="viewcode-block" id="ValidateObsid"><a class="viewcode-back" href="../../../api_validation.html#kadi.commands.validate.ValidateObsid">[docs]</a><span class="k">class</span> <span class="nc">ValidateObsid</span><span class="p">(</span><span class="n">ValidateSingleMsid</span><span class="p">):</span>
    <span class="n">state_name</span> <span class="o">=</span> <span class="s2">&quot;obsid&quot;</span>
    <span class="n">msids</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;cobsrqid&quot;</span><span class="p">]</span>
    <span class="n">plot_attrs</span> <span class="o">=</span> <span class="n">PlotAttrs</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;OBSID&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;OBSID&quot;</span><span class="p">)</span></div>


<span class="k">class</span> <span class="nc">ValidateGrating</span><span class="p">(</span><span class="n">ValidateStateCode</span><span class="p">):</span>
    <span class="n">msids</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;4ootgsel&quot;</span><span class="p">,</span> <span class="s2">&quot;4ootgmtn&quot;</span><span class="p">]</span>
    <span class="n">min_violation_duration</span> <span class="o">=</span> <span class="mi">328</span>  <span class="c1"># seconds</span>

    <span class="k">def</span> <span class="nf">add_exclude_intervals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_exclude_intervals</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exclude_ofp_intervals_except</span><span class="p">([</span><span class="s2">&quot;NRML&quot;</span><span class="p">])</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">cached_property</span>
    <span class="k">def</span> <span class="nf">state_codes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Table</span><span class="p">:</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;INSE&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;INSE_MOVE&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;RETR_MOVE&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;RETR&quot;</span><span class="p">],</span>
        <span class="p">]</span>
        <span class="n">_state_codes</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="n">rows</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;raw_val&quot;</span><span class="p">,</span> <span class="s2">&quot;state_code&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">_state_codes</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">cached_property</span>
    <span class="k">def</span> <span class="nf">tlm_vals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="s2">&quot;RETR&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tlm</span><span class="p">))</span>
        <span class="c1"># use a combination of the select telemetry and the insertion telem to</span>
        <span class="c1"># approximate the appropriate telemetry values</span>
        <span class="c1"># fmt: off</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">tlm</span><span class="p">[</span><span class="s2">&quot;4ootgsel&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_name</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
              <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tlm</span><span class="p">[</span><span class="s2">&quot;4ootgmtn&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;INSE&quot;</span><span class="p">))</span>
        <span class="c1"># fmt: on</span>
        <span class="n">vals</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;INSE&quot;</span>
        <span class="n">_tlm_vals</span> <span class="o">=</span> <span class="n">convert_state_code_to_raw_val</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_codes</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_tlm_vals</span>


<div class="viewcode-block" id="ValidateLETG"><a class="viewcode-back" href="../../../api_validation.html#kadi.commands.validate.ValidateLETG">[docs]</a><span class="k">class</span> <span class="nc">ValidateLETG</span><span class="p">(</span><span class="n">ValidateGrating</span><span class="p">):</span>
    <span class="n">state_name</span> <span class="o">=</span> <span class="s2">&quot;letg&quot;</span>
    <span class="n">plot_attrs</span> <span class="o">=</span> <span class="n">PlotAttrs</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;LETG&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;LETG&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ValidateHETG"><a class="viewcode-back" href="../../../api_validation.html#kadi.commands.validate.ValidateHETG">[docs]</a><span class="k">class</span> <span class="nc">ValidateHETG</span><span class="p">(</span><span class="n">ValidateGrating</span><span class="p">):</span>
    <span class="n">state_name</span> <span class="o">=</span> <span class="s2">&quot;hetg&quot;</span>
    <span class="n">plot_attrs</span> <span class="o">=</span> <span class="n">PlotAttrs</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;HETG&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;HETG&quot;</span><span class="p">)</span></div>


<span class="k">class</span> <span class="nc">ValidateSunPosMon</span><span class="p">(</span><span class="n">ValidateStateCode</span><span class="p">):</span>
    <span class="n">state_name</span> <span class="o">=</span> <span class="s2">&quot;sun_pos_mon&quot;</span>
    <span class="n">msids</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;aopssupm&quot;</span><span class="p">]</span>
    <span class="n">plot_attrs</span> <span class="o">=</span> <span class="n">PlotAttrs</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Sun position monitor&quot;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Sun position monitor&quot;</span><span class="p">)</span>
    <span class="n">min_violation_duration</span> <span class="o">=</span> <span class="mi">400</span>

    <span class="k">def</span> <span class="nf">add_exclude_intervals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_exclude_intervals</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exclude_ofp_intervals_except</span><span class="p">([</span><span class="s2">&quot;NRML&quot;</span><span class="p">])</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">cached_property</span>
    <span class="k">def</span> <span class="nf">state_vals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert ENAB (commanded states) to ACT (telemetry).</span>

<span class="sd">        The &quot;ENAB&quot; is an artifact of the backstop history sun position monitor states.</span>
<span class="sd">        This method is otherwise equivalent to the ValidateStateCode method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">states_interp</span> <span class="o">=</span> <span class="n">interpolate_states</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tlm</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">])</span>
        <span class="n">state_vals</span> <span class="o">=</span> <span class="n">states_interp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">state_name</span><span class="p">]</span>
        <span class="n">state_vals</span><span class="p">[</span><span class="n">state_vals</span> <span class="o">==</span> <span class="s2">&quot;ENAB&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ACT&quot;</span>
        <span class="n">state_vals_raw</span> <span class="o">=</span> <span class="n">convert_state_code_to_raw_val</span><span class="p">(</span><span class="n">state_vals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_codes</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">state_vals_raw</span>


<span class="k">def</span> <span class="nf">get_overlap_mask</span><span class="p">(</span><span class="n">times</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">intervals</span><span class="p">:</span> <span class="n">Table</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a bool mask of ``times`` that are within any of the ``intervals``.</span>

<span class="sd">    ``times`` parameter must be an array of CXC seconds (float) times.</span>
<span class="sd">    ``intervals`` must be a Table with columns ``start`` and ``stop``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;bool&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">interval</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">:</span>
        <span class="n">exclude</span> <span class="o">=</span> <span class="p">(</span><span class="n">times</span> <span class="o">&gt;=</span> <span class="n">CxoTime</span><span class="p">(</span><span class="n">interval</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">secs</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
            <span class="n">times</span> <span class="o">&lt;</span> <span class="n">CxoTime</span><span class="p">(</span><span class="n">interval</span><span class="p">[</span><span class="s2">&quot;stop&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">secs</span>
        <span class="p">)</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">exclude</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">mask</span>


<span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_command_sheet_exclude_intervals</span><span class="p">(</span><span class="n">state_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Table</span><span class="p">:</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">EXCLUDE_INTERVALS_SHEET_URL</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">doc_id</span><span class="o">=</span><span class="n">kadi</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">cmd_events_flight_id</span><span class="p">,</span>
        <span class="n">gid</span><span class="o">=</span><span class="n">kadi</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">cmd_events_exclude_intervals_gid</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Getting exclude times from </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to get exclude times sheet: </span><span class="si">{</span><span class="n">req</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">exclude_intervals</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;csv&quot;</span><span class="p">,</span> <span class="n">fill_values</span><span class="o">=</span><span class="p">[])</span>
    <span class="k">return</span> <span class="n">exclude_intervals</span>


<span class="k">def</span> <span class="nf">get_states</span><span class="p">(</span><span class="n">start</span><span class="p">:</span> <span class="n">CxoTimeLike</span><span class="p">,</span> <span class="n">stop</span><span class="p">:</span> <span class="n">CxoTimeLike</span><span class="p">,</span> <span class="n">state_keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Table</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get states exactly covering date range.</span>

<span class="sd">    This is a thin wrapper around kadi.commands.states.get_states() that reduces the</span>
<span class="sd">    output time span slightly to ensure telemetry interpolation works.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    start</span>
<span class="sd">        start date (CxoTime-like)</span>
<span class="sd">    stop</span>
<span class="sd">        stop date (CxoTime-like)</span>
<span class="sd">    state_keys</span>
<span class="sd">        list of state keys to get</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Table</span>
<span class="sd">        States in the interval</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">kadi.commands.states</span> <span class="kn">import</span> <span class="n">get_states</span> <span class="k">as</span> <span class="n">get_states_kadi</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">CxoTime</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
    <span class="n">stop</span> <span class="o">=</span> <span class="n">CxoTime</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using kadi.commands.states to get cmd_states&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Getting commanded states </span><span class="si">{</span><span class="n">state_keys</span><span class="si">!r}</span><span class="s2"> between </span><span class="si">{</span><span class="n">start</span><span class="o">.</span><span class="n">date</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">stop</span><span class="o">.</span><span class="n">date</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="n">states</span> <span class="o">=</span> <span class="n">get_states_kadi</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">state_keys</span><span class="o">=</span><span class="n">state_keys</span><span class="p">)</span>
    <span class="n">states</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CxoTime</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="s2">&quot;datestart&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">secs</span>
    <span class="n">states</span><span class="p">[</span><span class="s2">&quot;tstop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CxoTime</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="s2">&quot;datestop&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">secs</span>

    <span class="c1"># Set start and end state date/times to match telemetry span.  Extend the</span>
    <span class="c1"># state durations by a small amount because of a precision issue converting</span>
    <span class="c1"># to date and back to secs.  (The reference tstop could be just over the</span>
    <span class="c1"># 0.001 precision of date and thus cause an out-of-bounds error when</span>
    <span class="c1"># interpolating state values).</span>
    <span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CxoTime</span><span class="p">(</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">secs</span> <span class="o">-</span> <span class="mf">0.01</span>
    <span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;datestart&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CxoTime</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;tstart&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">date</span>
    <span class="n">states</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;tstop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CxoTime</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span><span class="o">.</span><span class="n">secs</span> <span class="o">+</span> <span class="mf">0.01</span>
    <span class="n">states</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;datestop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CxoTime</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;tstop&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">date</span>

    <span class="k">return</span> <span class="n">states</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/ska.png" alt="Logo"/>
            </a></p><h3>Page Contents</h3>


<form action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2013, Tom Aldcroft.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 6.1.3. &nbsp;
  </p>
</footer>
  </body>
</html>