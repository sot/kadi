
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>kadi.commands.states &#8212; kadi 6.0.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/bootstrap-astropy.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/plot_directive.css" />
    
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../../_static/copybutton.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../../index.html"><span id="logotext1">Ska!</span><span id="logotext2">Kadi</span><span id="logotext3"></span></a>
  <ul>
    
    <li><a class="home" title="Homepage" href="https://sot.github.io/">
        <span id="logotext1">ska</span><span id="logotext2">tools</span>
    </a></li>
    <li><a title="General Index" href="../../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../../index.html">kadi 6.0.0 documentation</a>
	 &#187;
      </li>
      <li><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for kadi.commands.states</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module provides the functions for dynamically determining Chandra commanded states</span>
<span class="sd">based entirely on known history of commands.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">inspect</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span><span class="p">,</span> <span class="n">Column</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>

<span class="kn">from</span> <span class="nn">Chandra.Time</span> <span class="kn">import</span> <span class="n">DateTime</span><span class="p">,</span> <span class="n">date2secs</span><span class="p">,</span> <span class="n">secs2date</span>
<span class="kn">from</span> <span class="nn">cxotime</span> <span class="kn">import</span> <span class="n">CxoTime</span>
<span class="kn">import</span> <span class="nn">Chandra.Maneuver</span>
<span class="kn">from</span> <span class="nn">Quaternion</span> <span class="kn">import</span> <span class="n">Quat</span>
<span class="kn">import</span> <span class="nn">Ska.Sun</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">commands</span>

<span class="c1"># Registry of Transition classes with state transition name as key.  A state transition</span>
<span class="c1"># may be generated by several different transition classes, hence the dict value is a list</span>
<span class="n">TRANSITIONS</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

<span class="c1"># Set of all Transition classes</span>
<span class="n">TRANSITION_CLASSES</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

<span class="c1"># Ordered list of all state keys</span>
<span class="n">STATE_KEYS</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Quaternion componenent names</span>
<span class="n">QUAT_COMPS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;q1&#39;</span><span class="p">,</span> <span class="s1">&#39;q2&#39;</span><span class="p">,</span> <span class="s1">&#39;q3&#39;</span><span class="p">,</span> <span class="s1">&#39;q4&#39;</span><span class="p">]</span>

<span class="c1"># State keys for PCAD-related transitions.  If *any* of these are requested then</span>
<span class="c1"># *all* of them need to be processed to get the correct answer.</span>
<span class="n">PCAD_STATE_KEYS</span> <span class="o">=</span> <span class="p">(</span><span class="n">QUAT_COMPS</span>
                   <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;targ_&#39;</span> <span class="o">+</span> <span class="n">qc</span> <span class="k">for</span> <span class="n">qc</span> <span class="ow">in</span> <span class="n">QUAT_COMPS</span><span class="p">]</span>
                   <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">,</span> <span class="s1">&#39;roll&#39;</span><span class="p">]</span>
                   <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;auto_npnt&#39;</span><span class="p">,</span> <span class="s1">&#39;pcad_mode&#39;</span><span class="p">,</span> <span class="s1">&#39;pitch&#39;</span><span class="p">,</span> <span class="s1">&#39;off_nom_roll&#39;</span><span class="p">])</span>

<span class="c1"># Default state keys (mostly matches classic command states list)</span>
<span class="n">DEFAULT_STATE_KEYS</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;ccd_count&#39;</span><span class="p">,</span> <span class="s1">&#39;clocking&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">,</span> <span class="s1">&#39;dither&#39;</span><span class="p">,</span> <span class="s1">&#39;fep_count&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;hetg&#39;</span><span class="p">,</span> <span class="s1">&#39;letg&#39;</span><span class="p">,</span> <span class="s1">&#39;obsid&#39;</span><span class="p">,</span> <span class="s1">&#39;off_nom_roll&#39;</span><span class="p">,</span> <span class="s1">&#39;pcad_mode&#39;</span><span class="p">,</span> <span class="s1">&#39;pitch&#39;</span><span class="p">,</span> <span class="s1">&#39;power_cmd&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;q1&#39;</span><span class="p">,</span> <span class="s1">&#39;q2&#39;</span><span class="p">,</span> <span class="s1">&#39;q3&#39;</span><span class="p">,</span> <span class="s1">&#39;q4&#39;</span><span class="p">,</span> <span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="s1">&#39;roll&#39;</span><span class="p">,</span> <span class="s1">&#39;si_mode&#39;</span><span class="p">,</span> <span class="s1">&#39;simfa_pos&#39;</span><span class="p">,</span> <span class="s1">&#39;simpos&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;targ_q1&#39;</span><span class="p">,</span> <span class="s1">&#39;targ_q2&#39;</span><span class="p">,</span> <span class="s1">&#39;targ_q3&#39;</span><span class="p">,</span> <span class="s1">&#39;targ_q4&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;vid_board&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="disable_grating_move_duration"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.disable_grating_move_duration">[docs]</a><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">disable_grating_move_duration</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Temporarily disable the grating move duration</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">apply_move_duration</span> <span class="o">=</span> <span class="n">MechMove</span><span class="o">.</span><span class="n">apply_move_duration</span>
    <span class="n">MechMove</span><span class="o">.</span><span class="n">apply_move_duration</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">yield</span>
    <span class="n">MechMove</span><span class="o">.</span><span class="n">apply_move_duration</span> <span class="o">=</span> <span class="n">apply_move_duration</span></div>


<div class="viewcode-block" id="NoTransitionsError"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.NoTransitionsError">[docs]</a><span class="k">class</span> <span class="nc">NoTransitionsError</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;No transitions found within commands&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="TransKeysSet"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.TransKeysSet">[docs]</a><span class="k">class</span> <span class="nc">TransKeysSet</span><span class="p">(</span><span class="nb">set</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Like set() but with more compact str output for table printing&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__and__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">TransKeysSet</span><span class="p">(</span><span class="nb">super</span><span class="p">(</span><span class="n">TransKeysSet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__and__</span><span class="p">(</span><span class="n">other</span><span class="p">))</span></div>


<div class="viewcode-block" id="StateDict"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.StateDict">[docs]</a><span class="k">class</span> <span class="nc">StateDict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dict for state key/val pairs.  When a key value is set the key is stored</span>
<span class="sd">    in the trans_keys attribute.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">StateDict</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trans_keys</span> <span class="o">=</span> <span class="n">TransKeysSet</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">StateDict</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trans_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<div class="viewcode-block" id="StateDict.copy"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.StateDict.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copy without trans_keys&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">StateDict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div></div>


<span class="c1">###################################################################</span>
<span class="c1"># Transition base classes</span>
<span class="c1">###################################################################</span>

<div class="viewcode-block" id="TransitionMeta"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.TransitionMeta">[docs]</a><span class="k">class</span> <span class="nc">TransitionMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Metaclass that adds the class to the TRANSITIONS dict (keyed by state_key),</span>
<span class="sd">    the TRANSITIONS_CLASSES set, and makes the complete list of STATE_KEYS.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="n">mcls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">members</span><span class="p">):</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">TransitionMeta</span><span class="p">,</span> <span class="n">mcls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">mcls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">members</span><span class="p">)</span>

        <span class="c1"># Register transition classes that have a `state_keys` (base classes do</span>
        <span class="c1"># not have this attribute set).</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;state_keys&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">state_key</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">state_keys</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">state_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">STATE_KEYS</span><span class="p">:</span>
                    <span class="n">STATE_KEYS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state_key</span><span class="p">)</span>
                <span class="n">TRANSITIONS</span><span class="p">[</span><span class="n">state_key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

            <span class="n">TRANSITION_CLASSES</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

            <span class="bp">cls</span><span class="o">.</span><span class="n">_auto_update_docstring</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">cls</span></div>


<div class="viewcode-block" id="BaseTransition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.BaseTransition">[docs]</a><span class="k">class</span> <span class="nc">BaseTransition</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">TransitionMeta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base transition class from which all actual transition classes are derived.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="BaseTransition.get_state_changing_commands"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.BaseTransition.get_state_changing_commands">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_state_changing_commands</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">cmds</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get commands that match the required attributes for state changing commands.</span>

<span class="sd">        This depends on two class attributes that are defined in derived classes:</span>

<span class="sd">        ``command_attributes`` (required)</span>
<span class="sd">          dict of {cmd_attr: match_value, ..}, where ``cmd_attr`` is either ``type``</span>
<span class="sd">          or ``tlmsid``, and ``match_value`` is the required value.</span>

<span class="sd">        ``command_params`` (optional)</span>
<span class="sd">          dict of {cmd_attr: match_value, ..}, where ``cmd_attr`` is one of the</span>
<span class="sd">          available command parameters, and ``match_value`` is either the required value</span>
<span class="sd">          or a list of required values (where at least one must match).</span>

<span class="sd">        :param cmds: commands (:class:`~kadi.commands.commands.CommandTable`)</span>

<span class="sd">        :returns: subset of ``cmds`` relevant for this Transition class (CmdList)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># First filter on command attributes.  These</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cmds</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">command_attributes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="n">ok</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cmds</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">==</span> <span class="n">val</span><span class="p">)</span>

        <span class="n">out_cmds</span> <span class="o">=</span> <span class="n">cmds</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span>

        <span class="c1"># Second do command_params.  Note could use `cmds[attr] == val`for &quot;vectorized&quot;</span>
        <span class="c1"># compare, but unrolling the loop here is more efficient since the CmdList class</span>
        <span class="c1"># would internally assemble a pure-Python version of the column first.</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;command_params&#39;</span><span class="p">):</span>
            <span class="n">attrs_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">command_params</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">vals_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">val</span><span class="p">]</span>
                         <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">command_params</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">out_cmds</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">out_cmds</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">attrs_list</span><span class="p">,</span> <span class="n">vals_list</span><span class="p">):</span>
                    <span class="n">ok_idx</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span>
                        <span class="n">ok_idx</span> <span class="o">|=</span> <span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">==</span> <span class="n">val</span><span class="p">)</span>
                    <span class="n">ok</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">ok</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">ok_idx</span>

            <span class="n">out_cmds</span> <span class="o">=</span> <span class="n">out_cmds</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">out_cmds</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_auto_update_docstring</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Put some useful information at the top of docstring.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">docs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">docs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;*State keys*: &#39;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">state_keys</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;command_attributes&#39;</span><span class="p">):</span>
            <span class="n">cmd_attrs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">command_attributes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">cmd_attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;command_params&#39;</span><span class="p">):</span>
                <span class="n">keys_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">command_params</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">vals_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">val</span><span class="p">]</span>
                             <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">command_params</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">keys_list</span><span class="p">,</span> <span class="n">vals_list</span><span class="p">):</span>
                    <span class="n">valstr</span> <span class="o">=</span> <span class="s1">&#39; or &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">)</span>
                    <span class="n">cmd_attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">valstr</span><span class="p">))</span>

            <span class="n">docs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">docs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;*Commands*: &#39;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd_attrs</span><span class="p">))</span>

        <span class="n">others</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">inspect</span><span class="o">.</span><span class="n">ismethod</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;state_keys&#39;</span><span class="p">,</span> <span class="s1">&#39;command_attributes&#39;</span><span class="p">,</span> <span class="s1">&#39;command_params&#39;</span><span class="p">)):</span>
                <span class="k">continue</span>
            <span class="n">others</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">others</span><span class="p">:</span>
            <span class="n">docs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">docs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;*Others*: &#39;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">others</span><span class="p">))</span>

        <span class="c1"># Common 4-space indent</span>
        <span class="n">docs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;    &#39;</span> <span class="o">+</span> <span class="n">doc</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">:</span>
            <span class="c1"># Get rid of initial new line and any trailing whitespace/newlines</span>
            <span class="n">docs</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
            <span class="n">docs</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;    &#39;</span><span class="p">)</span>

        <span class="bp">cls</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span></div>


<div class="viewcode-block" id="FixedTransition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.FixedTransition">[docs]</a><span class="k">class</span> <span class="nc">FixedTransition</span><span class="p">(</span><span class="n">BaseTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Transitions for the case of an attribute that gets set to a fixed</span>
<span class="sd">    value when the command occurs, e.g. pcad_mode=&#39;NMAN&#39; for AONMMODE.</span>

<span class="sd">    Class attributes:</span>

<span class="sd">    :param transition_key: single transition key or list of transition keys</span>
<span class="sd">    :param transition_val: single transition value or list of values</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="FixedTransition.set_transitions"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.FixedTransition.set_transitions">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">set_transitions</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">transitions_dict</span><span class="p">,</span> <span class="n">cmds</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set transitions for a Table of commands ``cmds``.</span>

<span class="sd">        :param transitions_dict: global dict of transitions (updated in-place)</span>
<span class="sd">        :param cmds: commands (CmdList)</span>
<span class="sd">        :param start: start time for states</span>
<span class="sd">        :param stop: stop time for states</span>

<span class="sd">        :returns: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">state_cmds</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_state_changing_commands</span><span class="p">(</span><span class="n">cmds</span><span class="p">)</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">transition_val</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">transition_key</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">vals</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">attrs</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">state_cmds</span><span class="p">:</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">val</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
                <span class="n">transitions_dict</span><span class="p">[</span><span class="n">date</span><span class="p">][</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span></div></div>


<div class="viewcode-block" id="ParamTransition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.ParamTransition">[docs]</a><span class="k">class</span> <span class="nc">ParamTransition</span><span class="p">(</span><span class="n">BaseTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Transitions for the case of an attribute that gets set to a value defined by</span>
<span class="sd">    a command parameter key, e.g. ``obsid`` = ``ID`` parameter of ``COBRQID``</span>
<span class="sd">    command.</span>

<span class="sd">    Class attributes:</span>

<span class="sd">    :param transition_key: single transition key or list of transition keys</span>
<span class="sd">    :param cmd_param_key: command parameter name (str or list of str)</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="ParamTransition.set_transitions"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.ParamTransition.set_transitions">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">set_transitions</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">transitions_dict</span><span class="p">,</span> <span class="n">cmds</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set transitions for a Table of commands ``cmds``.</span>

<span class="sd">        :param transitions_dict: global dict of transitions (updated in-place)</span>
<span class="sd">        :param cmds: commands (CmdList)</span>
<span class="sd">        :param start: start time for states</span>
<span class="sd">        :param stop: stop time for states</span>

<span class="sd">        :returns: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># cmds.rev_pars_dict is either None or a weakref to a dict</span>
        <span class="n">rev_pars_dict</span> <span class="o">=</span> <span class="n">rpd</span><span class="p">()</span> <span class="k">if</span> <span class="p">(</span><span class="n">rpd</span> <span class="o">:=</span> <span class="n">cmds</span><span class="o">.</span><span class="n">rev_pars_dict</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">state_cmds</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_state_changing_commands</span><span class="p">(</span><span class="n">cmds</span><span class="p">)</span>
        <span class="n">param_keys</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">cmd_param_key</span>
        <span class="n">names</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">transition_key</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param_keys</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">param_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">param_keys</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">names</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">state_cmds</span><span class="p">:</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span>
            <span class="n">cmd_idx</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">rev_pars_dict</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">cmd_idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">rev_pars_dict</span><span class="p">[</span><span class="n">cmd</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">]])</span>

            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param_key</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">param_keys</span><span class="p">):</span>
                <span class="n">transitions_dict</span><span class="p">[</span><span class="n">date</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">param_key</span><span class="p">]</span></div></div>


<span class="c1">###################################################################</span>
<span class="c1"># CCDM format and subformat transitions</span>
<span class="c1">###################################################################</span>

<div class="viewcode-block" id="Format1_Transition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.Format1_Transition">[docs]</a><span class="k">class</span> <span class="nc">Format1_Transition</span><span class="p">(</span><span class="n">FixedTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Transition to telemetry format 1&quot;&quot;&quot;</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tlmsid&#39;</span><span class="p">:</span> <span class="s1">&#39;CSELFMT1&#39;</span><span class="p">}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">]</span>
    <span class="n">transition_key</span> <span class="o">=</span> <span class="s1">&#39;format&#39;</span>
    <span class="n">transition_val</span> <span class="o">=</span> <span class="s1">&#39;FMT1&#39;</span></div>


<div class="viewcode-block" id="Format2_Transition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.Format2_Transition">[docs]</a><span class="k">class</span> <span class="nc">Format2_Transition</span><span class="p">(</span><span class="n">FixedTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Transition to telemetry format 2&quot;&quot;&quot;</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tlmsid&#39;</span><span class="p">:</span> <span class="s1">&#39;CSELFMT2&#39;</span><span class="p">}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">]</span>
    <span class="n">transition_key</span> <span class="o">=</span> <span class="s1">&#39;format&#39;</span>
    <span class="n">transition_val</span> <span class="o">=</span> <span class="s1">&#39;FMT2&#39;</span></div>


<div class="viewcode-block" id="Format3_Transition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.Format3_Transition">[docs]</a><span class="k">class</span> <span class="nc">Format3_Transition</span><span class="p">(</span><span class="n">FixedTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Transition to telemetry format 3&quot;&quot;&quot;</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tlmsid&#39;</span><span class="p">:</span> <span class="s1">&#39;CSELFMT3&#39;</span><span class="p">}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">]</span>
    <span class="n">transition_key</span> <span class="o">=</span> <span class="s1">&#39;format&#39;</span>
    <span class="n">transition_val</span> <span class="o">=</span> <span class="s1">&#39;FMT3&#39;</span></div>


<div class="viewcode-block" id="Format4_Transition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.Format4_Transition">[docs]</a><span class="k">class</span> <span class="nc">Format4_Transition</span><span class="p">(</span><span class="n">FixedTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Transition to telemetry format 4&quot;&quot;&quot;</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tlmsid&#39;</span><span class="p">:</span> <span class="s1">&#39;CSELFMT4&#39;</span><span class="p">}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">]</span>
    <span class="n">transition_key</span> <span class="o">=</span> <span class="s1">&#39;format&#39;</span>
    <span class="n">transition_val</span> <span class="o">=</span> <span class="s1">&#39;FMT4&#39;</span></div>


<div class="viewcode-block" id="Format5_Transition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.Format5_Transition">[docs]</a><span class="k">class</span> <span class="nc">Format5_Transition</span><span class="p">(</span><span class="n">FixedTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Transition to telemetry format 5&quot;&quot;&quot;</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tlmsid&#39;</span><span class="p">:</span> <span class="s1">&#39;CSELFMT5&#39;</span><span class="p">}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">]</span>
    <span class="n">transition_key</span> <span class="o">=</span> <span class="s1">&#39;format&#39;</span>
    <span class="n">transition_val</span> <span class="o">=</span> <span class="s1">&#39;FMT5&#39;</span></div>


<div class="viewcode-block" id="Format6_Transition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.Format6_Transition">[docs]</a><span class="k">class</span> <span class="nc">Format6_Transition</span><span class="p">(</span><span class="n">FixedTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Transition to telemetry format 6&quot;&quot;&quot;</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tlmsid&#39;</span><span class="p">:</span> <span class="s1">&#39;CSELFMT6&#39;</span><span class="p">}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">]</span>
    <span class="n">transition_key</span> <span class="o">=</span> <span class="s1">&#39;format&#39;</span>
    <span class="n">transition_val</span> <span class="o">=</span> <span class="s1">&#39;FMT6&#39;</span></div>


<div class="viewcode-block" id="SubFormatEPS_Transition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.SubFormatEPS_Transition">[docs]</a><span class="k">class</span> <span class="nc">SubFormatEPS_Transition</span><span class="p">(</span><span class="n">FixedTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Transition to telemetry EPS subformat&quot;&quot;&quot;</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tlmsid&#39;</span><span class="p">:</span> <span class="s1">&#39;OFMTSEPS&#39;</span><span class="p">}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;subformat&#39;</span><span class="p">]</span>
    <span class="n">transition_key</span> <span class="o">=</span> <span class="s1">&#39;subformat&#39;</span>
    <span class="n">transition_val</span> <span class="o">=</span> <span class="s1">&#39;EPS&#39;</span></div>


<div class="viewcode-block" id="SubFormatNRM_Transition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.SubFormatNRM_Transition">[docs]</a><span class="k">class</span> <span class="nc">SubFormatNRM_Transition</span><span class="p">(</span><span class="n">FixedTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Transition to telemetry NRM subformat&quot;&quot;&quot;</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tlmsid&#39;</span><span class="p">:</span> <span class="s1">&#39;OFMTSNRM&#39;</span><span class="p">}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;subformat&#39;</span><span class="p">]</span>
    <span class="n">transition_key</span> <span class="o">=</span> <span class="s1">&#39;subformat&#39;</span>
    <span class="n">transition_val</span> <span class="o">=</span> <span class="s1">&#39;NORM&#39;</span></div>


<div class="viewcode-block" id="SubFormatPDG_Transition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.SubFormatPDG_Transition">[docs]</a><span class="k">class</span> <span class="nc">SubFormatPDG_Transition</span><span class="p">(</span><span class="n">FixedTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Transition to telemetry PDG subformat&quot;&quot;&quot;</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tlmsid&#39;</span><span class="p">:</span> <span class="s1">&#39;OFMTSPDG&#39;</span><span class="p">}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;subformat&#39;</span><span class="p">]</span>
    <span class="n">transition_key</span> <span class="o">=</span> <span class="s1">&#39;subformat&#39;</span>
    <span class="n">transition_val</span> <span class="o">=</span> <span class="s1">&#39;PDG&#39;</span></div>


<div class="viewcode-block" id="SubFormatSSR_Transition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.SubFormatSSR_Transition">[docs]</a><span class="k">class</span> <span class="nc">SubFormatSSR_Transition</span><span class="p">(</span><span class="n">FixedTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Transition to telemetry SSR subformat&quot;&quot;&quot;</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tlmsid&#39;</span><span class="p">:</span> <span class="s1">&#39;OFMTSSSR&#39;</span><span class="p">}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;subformat&#39;</span><span class="p">]</span>
    <span class="n">transition_key</span> <span class="o">=</span> <span class="s1">&#39;subformat&#39;</span>
    <span class="n">transition_val</span> <span class="o">=</span> <span class="s1">&#39;SSR&#39;</span></div>


<span class="c1">###################################################################</span>
<span class="c1"># Mech transitions</span>
<span class="c1">###################################################################</span>

<div class="viewcode-block" id="MechMove"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.MechMove">[docs]</a><span class="k">class</span> <span class="nc">MechMove</span><span class="p">(</span><span class="n">FixedTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Transitions for mech moves that have non-zero duration.</span>

<span class="sd">    This adds two transitions per matched command:</span>
<span class="sd">    - First one at cmd time with the transition value with ``_MOVE`` appended</span>
<span class="sd">    - Second one at cmd time + move_duration with the straight transition value</span>

<span class="sd">    This inherits from FixedTransition for the case of an attribute that gets</span>
<span class="sd">    set to a fixed value when the command occurs, e.g. pcad_mode=&#39;NMAN&#39; for</span>
<span class="sd">    AONMMODE.</span>

<span class="sd">    Class attributes:</span>

<span class="sd">    :param transition_key: single transition key or list of transition keys</span>
<span class="sd">    :param transition_val: single transition value or list of values</span>
<span class="sd">    :param move_duration: duration of the move (astropy time Quantity)</span>
<span class="sd">    :param apply_move_duration: if True, apply the move duration to states</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">apply_move_duration</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="MechMove.set_transitions"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.MechMove.set_transitions">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">set_transitions</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">transitions_dict</span><span class="p">,</span> <span class="n">cmds</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set transitions for a Table of commands ``cmds``.</span>

<span class="sd">        :param transitions_dict: global dict of transitions (updated in-place)</span>
<span class="sd">        :param cmds: commands (CmdList)</span>
<span class="sd">        :param start: start time for states</span>
<span class="sd">        :param stop: stop time for states</span>

<span class="sd">        :returns: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">state_cmds</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_state_changing_commands</span><span class="p">(</span><span class="n">cmds</span><span class="p">)</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">transition_val</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">transition_key</span>
        <span class="n">move_duration</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">move_duration</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">vals</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">attrs</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">state_cmds</span><span class="p">:</span>
            <span class="n">date_start</span> <span class="o">=</span> <span class="n">CxoTime</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
            <span class="n">date_stop</span> <span class="o">=</span> <span class="n">date_start</span> <span class="o">+</span> <span class="n">move_duration</span>
            <span class="k">for</span> <span class="n">val</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="s1">&#39;grating&#39;</span><span class="p">:</span>
                    <span class="n">transitions_dict</span><span class="p">[</span><span class="n">date_start</span><span class="o">.</span><span class="n">date</span><span class="p">][</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># &#39;letg&#39; or &#39;hetg&#39; insert/retract status, include the move</span>
                    <span class="c1"># interval here</span>
                    <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">apply_move_duration</span><span class="p">:</span>
                        <span class="n">transitions_dict</span><span class="p">[</span><span class="n">date_start</span><span class="o">.</span><span class="n">date</span><span class="p">][</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">+</span> <span class="s1">&#39;_MOVE&#39;</span>
                        <span class="n">transitions_dict</span><span class="p">[</span><span class="n">date_stop</span><span class="o">.</span><span class="n">date</span><span class="p">][</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">transitions_dict</span><span class="p">[</span><span class="n">date_start</span><span class="o">.</span><span class="n">date</span><span class="p">][</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span></div></div>


<div class="viewcode-block" id="HETG_INSR_Transition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.HETG_INSR_Transition">[docs]</a><span class="k">class</span> <span class="nc">HETG_INSR_Transition</span><span class="p">(</span><span class="n">MechMove</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;HETG insertion&quot;&quot;&quot;</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tlmsid&#39;</span><span class="p">:</span> <span class="s1">&#39;4OHETGIN&#39;</span><span class="p">}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;letg&#39;</span><span class="p">,</span> <span class="s1">&#39;hetg&#39;</span><span class="p">,</span> <span class="s1">&#39;grating&#39;</span><span class="p">]</span>
    <span class="n">transition_key</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hetg&#39;</span><span class="p">,</span> <span class="s1">&#39;grating&#39;</span><span class="p">]</span>
    <span class="n">transition_val</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;INSR&#39;</span><span class="p">,</span> <span class="s1">&#39;HETG&#39;</span><span class="p">]</span>
    <span class="n">move_duration</span> <span class="o">=</span> <span class="mi">157</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span></div>


<div class="viewcode-block" id="HETG_RETR_Transition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.HETG_RETR_Transition">[docs]</a><span class="k">class</span> <span class="nc">HETG_RETR_Transition</span><span class="p">(</span><span class="n">MechMove</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;HETG retraction&quot;&quot;&quot;</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tlmsid&#39;</span><span class="p">:</span> <span class="s1">&#39;4OHETGRE&#39;</span><span class="p">}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;letg&#39;</span><span class="p">,</span> <span class="s1">&#39;hetg&#39;</span><span class="p">,</span> <span class="s1">&#39;grating&#39;</span><span class="p">]</span>
    <span class="n">transition_key</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hetg&#39;</span><span class="p">,</span> <span class="s1">&#39;grating&#39;</span><span class="p">]</span>
    <span class="n">transition_val</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RETR&#39;</span><span class="p">,</span> <span class="s1">&#39;NONE&#39;</span><span class="p">]</span>
    <span class="n">move_duration</span> <span class="o">=</span> <span class="mi">153</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span></div>


<div class="viewcode-block" id="LETG_INSR_Transition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.LETG_INSR_Transition">[docs]</a><span class="k">class</span> <span class="nc">LETG_INSR_Transition</span><span class="p">(</span><span class="n">MechMove</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;LETG insertion&quot;&quot;&quot;</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tlmsid&#39;</span><span class="p">:</span> <span class="s1">&#39;4OLETGIN&#39;</span><span class="p">}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;letg&#39;</span><span class="p">,</span> <span class="s1">&#39;hetg&#39;</span><span class="p">,</span> <span class="s1">&#39;grating&#39;</span><span class="p">]</span>
    <span class="n">transition_key</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;letg&#39;</span><span class="p">,</span> <span class="s1">&#39;grating&#39;</span><span class="p">]</span>
    <span class="n">transition_val</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;INSR&#39;</span><span class="p">,</span> <span class="s1">&#39;LETG&#39;</span><span class="p">]</span>
    <span class="n">move_duration</span> <span class="o">=</span> <span class="mi">203</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span></div>


<div class="viewcode-block" id="LETG_RETR_Transition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.LETG_RETR_Transition">[docs]</a><span class="k">class</span> <span class="nc">LETG_RETR_Transition</span><span class="p">(</span><span class="n">MechMove</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;LETG retraction&quot;&quot;&quot;</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tlmsid&#39;</span><span class="p">:</span> <span class="s1">&#39;4OLETGRE&#39;</span><span class="p">}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;letg&#39;</span><span class="p">,</span> <span class="s1">&#39;hetg&#39;</span><span class="p">,</span> <span class="s1">&#39;grating&#39;</span><span class="p">]</span>
    <span class="n">transition_key</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;letg&#39;</span><span class="p">,</span> <span class="s1">&#39;grating&#39;</span><span class="p">]</span>
    <span class="n">transition_val</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RETR&#39;</span><span class="p">,</span> <span class="s1">&#39;NONE&#39;</span><span class="p">]</span>
    <span class="n">move_duration</span> <span class="o">=</span> <span class="mi">203</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span></div>


<div class="viewcode-block" id="SimTscTransition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.SimTscTransition">[docs]</a><span class="k">class</span> <span class="nc">SimTscTransition</span><span class="p">(</span><span class="n">ParamTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;SIM translating science compartment translation&quot;&quot;&quot;</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;SIMTRANS&#39;</span><span class="p">}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;simpos&#39;</span><span class="p">]</span>
    <span class="n">transition_key</span> <span class="o">=</span> <span class="s1">&#39;simpos&#39;</span>
    <span class="n">cmd_param_key</span> <span class="o">=</span> <span class="s1">&#39;pos&#39;</span></div>


<div class="viewcode-block" id="SimFocusTransition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.SimFocusTransition">[docs]</a><span class="k">class</span> <span class="nc">SimFocusTransition</span><span class="p">(</span><span class="n">ParamTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;SIM focus assembly translation&quot;&quot;&quot;</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;SIMFOCUS&#39;</span><span class="p">}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;simfa_pos&#39;</span><span class="p">]</span>
    <span class="n">transition_key</span> <span class="o">=</span> <span class="s1">&#39;simfa_pos&#39;</span>
    <span class="n">cmd_param_key</span> <span class="o">=</span> <span class="s1">&#39;pos&#39;</span></div>


<span class="c1">###################################################################</span>
<span class="c1"># OBC etc transitions</span>
<span class="c1">###################################################################</span>

<div class="viewcode-block" id="ObsidTransition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.ObsidTransition">[docs]</a><span class="k">class</span> <span class="nc">ObsidTransition</span><span class="p">(</span><span class="n">ParamTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Obsid update&quot;&quot;&quot;</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;MP_OBSID&#39;</span><span class="p">}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;obsid&#39;</span><span class="p">]</span>
    <span class="n">transition_key</span> <span class="o">=</span> <span class="s1">&#39;obsid&#39;</span>
    <span class="n">cmd_param_key</span> <span class="o">=</span> <span class="s1">&#39;id&#39;</span></div>


<div class="viewcode-block" id="EclipseEntryTimerTransition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.EclipseEntryTimerTransition">[docs]</a><span class="k">class</span> <span class="nc">EclipseEntryTimerTransition</span><span class="p">(</span><span class="n">ParamTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Eclipse entry timer update&quot;&quot;&quot;</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tlmsid&#39;</span><span class="p">:</span> <span class="s1">&#39;EOECLETO&#39;</span><span class="p">}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;eclipse_timer&#39;</span><span class="p">]</span>
    <span class="n">transition_key</span> <span class="o">=</span> <span class="s1">&#39;eclipse_timer&#39;</span>
    <span class="n">cmd_param_key</span> <span class="o">=</span> <span class="s1">&#39;timecnt&#39;</span></div>


<div class="viewcode-block" id="EclipsePenumbraEntryTransition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.EclipsePenumbraEntryTransition">[docs]</a><span class="k">class</span> <span class="nc">EclipsePenumbraEntryTransition</span><span class="p">(</span><span class="n">FixedTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Eclipse penumbra entry&quot;&quot;&quot;</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ORBPOINT&#39;</span><span class="p">}</span>
    <span class="n">command_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;event_type&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;PENTRY&#39;</span><span class="p">,</span> <span class="s1">&#39;LSPENTRY&#39;</span><span class="p">]}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;eclipse&#39;</span><span class="p">]</span>
    <span class="n">transition_key</span> <span class="o">=</span> <span class="s1">&#39;eclipse&#39;</span>
    <span class="n">transition_val</span> <span class="o">=</span> <span class="s1">&#39;PENUMBRA&#39;</span></div>


<div class="viewcode-block" id="EclipsePenumbraExitTransition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.EclipsePenumbraExitTransition">[docs]</a><span class="k">class</span> <span class="nc">EclipsePenumbraExitTransition</span><span class="p">(</span><span class="n">FixedTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Eclipse penumbra exit&quot;&quot;&quot;</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ORBPOINT&#39;</span><span class="p">}</span>
    <span class="n">command_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;event_type&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;PEXIT&#39;</span><span class="p">,</span> <span class="s1">&#39;LSPEXIT&#39;</span><span class="p">]}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;eclipse&#39;</span><span class="p">]</span>
    <span class="n">transition_key</span> <span class="o">=</span> <span class="s1">&#39;eclipse&#39;</span>
    <span class="n">transition_val</span> <span class="o">=</span> <span class="s1">&#39;DAY&#39;</span></div>


<div class="viewcode-block" id="EclipseUmbraEntryTransition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.EclipseUmbraEntryTransition">[docs]</a><span class="k">class</span> <span class="nc">EclipseUmbraEntryTransition</span><span class="p">(</span><span class="n">FixedTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Eclipse umbra entry&quot;&quot;&quot;</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ORBPOINT&#39;</span><span class="p">}</span>
    <span class="n">command_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;event_type&#39;</span><span class="p">:</span> <span class="s1">&#39;EONIGHT&#39;</span><span class="p">}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;eclipse&#39;</span><span class="p">]</span>
    <span class="n">transition_key</span> <span class="o">=</span> <span class="s1">&#39;eclipse&#39;</span>
    <span class="n">transition_val</span> <span class="o">=</span> <span class="s1">&#39;UMBRA&#39;</span></div>


<div class="viewcode-block" id="EclipseUmbraExitTransition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.EclipseUmbraExitTransition">[docs]</a><span class="k">class</span> <span class="nc">EclipseUmbraExitTransition</span><span class="p">(</span><span class="n">FixedTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Eclipse umbra exit&quot;&quot;&quot;</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ORBPOINT&#39;</span><span class="p">}</span>
    <span class="n">command_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;event_type&#39;</span><span class="p">:</span> <span class="s1">&#39;EODAY&#39;</span><span class="p">}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;eclipse&#39;</span><span class="p">]</span>
    <span class="n">transition_key</span> <span class="o">=</span> <span class="s1">&#39;eclipse&#39;</span>
    <span class="n">transition_val</span> <span class="o">=</span> <span class="s1">&#39;PENUMBRA&#39;</span></div>


<div class="viewcode-block" id="SPMEnableTransition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.SPMEnableTransition">[docs]</a><span class="k">class</span> <span class="nc">SPMEnableTransition</span><span class="p">(</span><span class="n">FixedTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sun position monitor enable&quot;&quot;&quot;</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tlmsid&#39;</span><span class="p">:</span> <span class="s1">&#39;AOFUNCEN&#39;</span><span class="p">}</span>
    <span class="n">command_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;aopcadse&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sun_pos_mon&#39;</span><span class="p">]</span>
    <span class="n">transition_key</span> <span class="o">=</span> <span class="s1">&#39;sun_pos_mon&#39;</span>
    <span class="n">transition_val</span> <span class="o">=</span> <span class="s1">&#39;ENAB&#39;</span></div>


<div class="viewcode-block" id="SPMDisableTransition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.SPMDisableTransition">[docs]</a><span class="k">class</span> <span class="nc">SPMDisableTransition</span><span class="p">(</span><span class="n">FixedTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sun position monitor disable&quot;&quot;&quot;</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tlmsid&#39;</span><span class="p">:</span> <span class="s1">&#39;AOFUNCDS&#39;</span><span class="p">}</span>
    <span class="n">command_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;aopcadsd&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sun_pos_mon&#39;</span><span class="p">]</span>
    <span class="n">transition_key</span> <span class="o">=</span> <span class="s1">&#39;sun_pos_mon&#39;</span>
    <span class="n">transition_val</span> <span class="o">=</span> <span class="s1">&#39;DISA&#39;</span></div>


<div class="viewcode-block" id="SPMEclipseEnableTransition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.SPMEclipseEnableTransition">[docs]</a><span class="k">class</span> <span class="nc">SPMEclipseEnableTransition</span><span class="p">(</span><span class="n">BaseTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Automatic enable of sun position monitor which occurs 11 minutes after eclipse exit,</span>
<span class="sd">    but only if the battery-connect command occurs within 2:05 minutes of eclipse entry.</span>

<span class="sd">    Connect batteries is an event type COMMAND_SW and TLMSID= EOESTECN</span>
<span class="sd">    Eclipse entry is event type ORBPOINT with TYPE=PENTRY or TYPE=LSPENTRY</span>
<span class="sd">    Eclipse exit is event type ORBPOINT with TYPE=PEXIT or TYPE=LSPEXIT</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Command attributes and params are just for docstring, but actual transition</span>
    <span class="c1"># command filtering in set_transitions is more complicated.</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ORBPOINT&#39;</span><span class="p">}</span>
    <span class="n">command_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;event_type&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;PEXIT&#39;</span><span class="p">,</span> <span class="s1">&#39;LSPEXIT&#39;</span><span class="p">]}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sun_pos_mon&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="SPMEclipseEnableTransition.set_transitions"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.SPMEclipseEnableTransition.set_transitions">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">set_transitions</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">transitions_dict</span><span class="p">,</span> <span class="n">cmds</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set transitions for a Table of commands ``cmds``.</span>

<span class="sd">        :param transitions_dict: global dict of transitions (updated in-place)</span>
<span class="sd">        :param cmds: commands (CmdList)</span>
<span class="sd">        :param start: start time for states</span>
<span class="sd">        :param stop: stop time for states</span>

<span class="sd">        :returns: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Preselect only commands that might have an impact here.</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmds</span><span class="p">[</span><span class="s1">&#39;tlmsid&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;EOESTECN&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cmds</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ORBPOINT&#39;</span><span class="p">)</span>
        <span class="n">cmds</span> <span class="o">=</span> <span class="n">cmds</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span>

        <span class="n">connect_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">connect_flag</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">cmds</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cmd</span><span class="p">[</span><span class="s1">&#39;tlmsid&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;EOESTECN&#39;</span><span class="p">:</span>
                <span class="n">connect_time</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">secs</span>

            <span class="k">elif</span> <span class="n">cmd</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ORBPOINT&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cmd</span><span class="p">[</span><span class="s1">&#39;event_type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;PENTRY&#39;</span><span class="p">,</span> <span class="s1">&#39;LSPENTRY&#39;</span><span class="p">):</span>
                    <span class="n">entry_time</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">secs</span>
                    <span class="n">connect_flag</span> <span class="o">=</span> <span class="p">(</span><span class="n">entry_time</span> <span class="o">-</span> <span class="n">connect_time</span> <span class="o">&lt;</span> <span class="mi">125</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">cmd</span><span class="p">[</span><span class="s1">&#39;event_type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;PEXIT&#39;</span><span class="p">,</span> <span class="s1">&#39;LSPEXIT&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">connect_flag</span><span class="p">:</span>
                    <span class="n">scs33</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">11</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">/</span> <span class="mi">86400</span>  <span class="c1"># 11 minutes in days</span>
                    <span class="n">transitions_dict</span><span class="p">[</span><span class="n">scs33</span><span class="o">.</span><span class="n">date</span><span class="p">][</span><span class="s1">&#39;sun_pos_mon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ENAB&#39;</span>
                    <span class="n">connect_flag</span> <span class="o">=</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="SCS84EnableTransition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.SCS84EnableTransition">[docs]</a><span class="k">class</span> <span class="nc">SCS84EnableTransition</span><span class="p">(</span><span class="n">FixedTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;SCS-84 enable&quot;&quot;&quot;</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tlmsid&#39;</span><span class="p">:</span> <span class="s1">&#39;COENASX&#39;</span><span class="p">}</span>
    <span class="n">command_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;coenas1&#39;</span><span class="p">:</span> <span class="mi">84</span><span class="p">}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;scs84&#39;</span><span class="p">]</span>
    <span class="n">transition_key</span> <span class="o">=</span> <span class="s1">&#39;scs84&#39;</span>
    <span class="n">transition_val</span> <span class="o">=</span> <span class="s1">&#39;ENAB&#39;</span>
    <span class="n">default_value</span> <span class="o">=</span> <span class="s1">&#39;DISA&#39;</span></div>


<div class="viewcode-block" id="SCS84DisableTransition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.SCS84DisableTransition">[docs]</a><span class="k">class</span> <span class="nc">SCS84DisableTransition</span><span class="p">(</span><span class="n">FixedTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;SCS-84 disable&quot;&quot;&quot;</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tlmsid&#39;</span><span class="p">:</span> <span class="s1">&#39;CODISASX&#39;</span><span class="p">}</span>
    <span class="n">command_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;codisas1&#39;</span><span class="p">:</span> <span class="mi">84</span><span class="p">}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;scs84&#39;</span><span class="p">]</span>
    <span class="n">transition_key</span> <span class="o">=</span> <span class="s1">&#39;scs84&#39;</span>
    <span class="n">transition_val</span> <span class="o">=</span> <span class="s1">&#39;DISA&#39;</span></div>


<div class="viewcode-block" id="SCS98EnableTransition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.SCS98EnableTransition">[docs]</a><span class="k">class</span> <span class="nc">SCS98EnableTransition</span><span class="p">(</span><span class="n">FixedTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;SCS-98 enable&quot;&quot;&quot;</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tlmsid&#39;</span><span class="p">:</span> <span class="s1">&#39;COENASX&#39;</span><span class="p">}</span>
    <span class="n">command_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;coenas1&#39;</span><span class="p">:</span> <span class="mi">98</span><span class="p">}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;scs98&#39;</span><span class="p">]</span>
    <span class="n">transition_key</span> <span class="o">=</span> <span class="s1">&#39;scs98&#39;</span>
    <span class="n">transition_val</span> <span class="o">=</span> <span class="s1">&#39;ENAB&#39;</span></div>


<div class="viewcode-block" id="SCS98DisableTransition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.SCS98DisableTransition">[docs]</a><span class="k">class</span> <span class="nc">SCS98DisableTransition</span><span class="p">(</span><span class="n">FixedTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;SCS-98 disable&quot;&quot;&quot;</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tlmsid&#39;</span><span class="p">:</span> <span class="s1">&#39;CODISASX&#39;</span><span class="p">}</span>
    <span class="n">command_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;codisas1&#39;</span><span class="p">:</span> <span class="mi">98</span><span class="p">}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;scs98&#39;</span><span class="p">]</span>
    <span class="n">transition_key</span> <span class="o">=</span> <span class="s1">&#39;scs98&#39;</span>
    <span class="n">transition_val</span> <span class="o">=</span> <span class="s1">&#39;DISA&#39;</span></div>


<div class="viewcode-block" id="RadmonEnableTransition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.RadmonEnableTransition">[docs]</a><span class="k">class</span> <span class="nc">RadmonEnableTransition</span><span class="p">(</span><span class="n">FixedTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;RADMON enable&quot;&quot;&quot;</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tlmsid&#39;</span><span class="p">:</span> <span class="s1">&#39;OORMPEN&#39;</span><span class="p">}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;radmon&#39;</span><span class="p">]</span>
    <span class="n">transition_key</span> <span class="o">=</span> <span class="s1">&#39;radmon&#39;</span>
    <span class="n">transition_val</span> <span class="o">=</span> <span class="s1">&#39;ENAB&#39;</span></div>


<div class="viewcode-block" id="RadmonDisableTransition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.RadmonDisableTransition">[docs]</a><span class="k">class</span> <span class="nc">RadmonDisableTransition</span><span class="p">(</span><span class="n">FixedTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;RADMON disable&quot;&quot;&quot;</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tlmsid&#39;</span><span class="p">:</span> <span class="s1">&#39;OORMPDS&#39;</span><span class="p">}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;radmon&#39;</span><span class="p">]</span>
    <span class="n">transition_key</span> <span class="o">=</span> <span class="s1">&#39;radmon&#39;</span>
    <span class="n">transition_val</span> <span class="o">=</span> <span class="s1">&#39;DISA&#39;</span></div>


<div class="viewcode-block" id="OrbitPointTransition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.OrbitPointTransition">[docs]</a><span class="k">class</span> <span class="nc">OrbitPointTransition</span><span class="p">(</span><span class="n">ParamTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Orbit point state based on backstop ephemeris entries&quot;&quot;&quot;</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ORBPOINT&#39;</span><span class="p">}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;orbit_point&#39;</span><span class="p">]</span>
    <span class="n">transition_key</span> <span class="o">=</span> <span class="s1">&#39;orbit_point&#39;</span>
    <span class="n">cmd_param_key</span> <span class="o">=</span> <span class="s1">&#39;event_type&#39;</span></div>


<div class="viewcode-block" id="EphemerisTransition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.EphemerisTransition">[docs]</a><span class="k">class</span> <span class="nc">EphemerisTransition</span><span class="p">(</span><span class="n">ParamTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;On-board ephemeris update values&quot;&quot;&quot;</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tlmsid&#39;</span><span class="p">:</span> <span class="s1">&#39;AOEPHUPS&#39;</span><span class="p">}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;aoephem1&#39;</span><span class="p">,</span> <span class="s1">&#39;aoephem2&#39;</span><span class="p">,</span> <span class="s1">&#39;aoratio&#39;</span><span class="p">,</span> <span class="s1">&#39;aoargper&#39;</span><span class="p">,</span> <span class="s1">&#39;aoeccent&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;ao1minus&#39;</span><span class="p">,</span> <span class="s1">&#39;ao1plus&#39;</span><span class="p">,</span> <span class="s1">&#39;aomotion&#39;</span><span class="p">,</span> <span class="s1">&#39;aoiterat&#39;</span><span class="p">,</span> <span class="s1">&#39;aoorbang&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;aoperige&#39;</span><span class="p">,</span> <span class="s1">&#39;aoascend&#39;</span><span class="p">,</span> <span class="s1">&#39;aosini&#39;</span><span class="p">,</span> <span class="s1">&#39;aoslr&#39;</span><span class="p">,</span> <span class="s1">&#39;aosqrtmu&#39;</span><span class="p">]</span>
    <span class="n">transition_key</span> <span class="o">=</span> <span class="n">state_keys</span>
    <span class="n">cmd_param_key</span> <span class="o">=</span> <span class="n">state_keys</span></div>


<div class="viewcode-block" id="EphemerisUpdateTransition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.EphemerisUpdateTransition">[docs]</a><span class="k">class</span> <span class="nc">EphemerisUpdateTransition</span><span class="p">(</span><span class="n">BaseTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    On-board ephemeris update date.  Mostly useful for the FOT to assist in backstop</span>
<span class="sd">    processing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tlmsid&#39;</span><span class="p">:</span> <span class="s1">&#39;AOEPHUPS&#39;</span><span class="p">}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ephem_update&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="EphemerisUpdateTransition.set_transitions"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.EphemerisUpdateTransition.set_transitions">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">set_transitions</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">transitions_dict</span><span class="p">,</span> <span class="n">cmds</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set transitions for a Table of commands ``cmds``.</span>

<span class="sd">        :param transitions_dict: global dict of transitions (updated in-place)</span>
<span class="sd">        :param cmds: commands (CmdList)</span>
<span class="sd">        :param start: start time for states</span>
<span class="sd">        :param stop: stop time for states</span>

<span class="sd">        :returns: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">state_cmds</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_state_changing_commands</span><span class="p">(</span><span class="n">cmds</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">state_cmds</span><span class="p">:</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span>
            <span class="n">transitions_dict</span><span class="p">[</span><span class="n">date</span><span class="p">][</span><span class="s1">&#39;ephem_update&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span></div></div>


<span class="c1">###################################################################</span>

<div class="viewcode-block" id="SunVectorTransition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.SunVectorTransition">[docs]</a><span class="k">class</span> <span class="nc">SunVectorTransition</span><span class="p">(</span><span class="n">BaseTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add transitions between start/stop every 10 ksec to sample the pitch and off_nominal</span>
<span class="sd">    roll during NPNT.  These are function transitions which check to see that</span>
<span class="sd">    ``pcad_mode == &#39;NPNT&#39;`` before changing the pitch / off_nominal_roll.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="n">PCAD_STATE_KEYS</span>

<div class="viewcode-block" id="SunVectorTransition.set_transitions"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.SunVectorTransition.set_transitions">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">set_transitions</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">transitions_dict</span><span class="p">,</span> <span class="n">cmds</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set transitions for a Table of commands ``cmds``.</span>

<span class="sd">        :param transitions_dict: global dict of transitions (updated in-place)</span>
<span class="sd">        :param cmds: commands (CmdList)</span>
<span class="sd">        :param start: start time for states</span>
<span class="sd">        :param stop: stop time for states</span>

<span class="sd">        :returns: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># np.ceil is used here to get &#39;times&#39; between start/stop at even increments of</span>
        <span class="c1"># &quot;sample_time&quot; so that the commands will be at the same times in an interval even if</span>
        <span class="c1"># a different time range is being updated.</span>
        <span class="n">sample_time</span> <span class="o">=</span> <span class="mi">10000</span>
        <span class="n">tstart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">DateTime</span><span class="p">(</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">secs</span> <span class="o">/</span> <span class="n">sample_time</span><span class="p">)</span> <span class="o">*</span> <span class="n">sample_time</span>
        <span class="n">tstop</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span><span class="o">.</span><span class="n">secs</span>
        <span class="n">times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">tstart</span><span class="p">,</span> <span class="n">tstop</span><span class="p">,</span> <span class="n">sample_time</span><span class="p">)</span>
        <span class="n">dates</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">times</span><span class="p">)</span><span class="o">.</span><span class="n">date</span>

        <span class="c1"># Now with the dates, finally make all the transition dicts which will</span>
        <span class="c1"># call `update_pitch_state` during state processing.</span>
        <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">dates</span><span class="p">:</span>
            <span class="n">transitions_dict</span><span class="p">[</span><span class="n">date</span><span class="p">][</span><span class="s1">&#39;update_sun_vector&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">update_sun_vector_state</span></div>

<div class="viewcode-block" id="SunVectorTransition.update_sun_vector_state"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.SunVectorTransition.update_sun_vector_state">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">update_sun_vector_state</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">transitions</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transition callback method to potentially update the ``pitch`` and</span>
<span class="sd">        ``off_nominal`` states if pcad_mode is NPNT.</span>

<span class="sd">        :param date: date (str)</span>
<span class="sd">        :param transitions: global list of transitions</span>
<span class="sd">        :param state: current state (dict)</span>
<span class="sd">        :param idx: current index into transitions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;pcad_mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;NPNT&#39;</span><span class="p">:</span>
            <span class="n">q_att</span> <span class="o">=</span> <span class="n">Quat</span><span class="p">([</span><span class="n">state</span><span class="p">[</span><span class="n">qc</span><span class="p">]</span> <span class="k">for</span> <span class="n">qc</span> <span class="ow">in</span> <span class="n">QUAT_COMPS</span><span class="p">])</span>
            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;pitch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ska</span><span class="o">.</span><span class="n">Sun</span><span class="o">.</span><span class="n">pitch</span><span class="p">(</span><span class="n">q_att</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">q_att</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>
            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;off_nom_roll&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ska</span><span class="o">.</span><span class="n">Sun</span><span class="o">.</span><span class="n">off_nominal_roll</span><span class="p">(</span><span class="n">q_att</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="DitherEnableTransition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.DitherEnableTransition">[docs]</a><span class="k">class</span> <span class="nc">DitherEnableTransition</span><span class="p">(</span><span class="n">FixedTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Dither enable&quot;&quot;&quot;</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tlmsid&#39;</span><span class="p">:</span> <span class="s1">&#39;AOENDITH&#39;</span><span class="p">}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dither&#39;</span><span class="p">]</span>
    <span class="n">transition_key</span> <span class="o">=</span> <span class="s1">&#39;dither&#39;</span>
    <span class="n">transition_val</span> <span class="o">=</span> <span class="s1">&#39;ENAB&#39;</span></div>


<div class="viewcode-block" id="DitherDisableTransition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.DitherDisableTransition">[docs]</a><span class="k">class</span> <span class="nc">DitherDisableTransition</span><span class="p">(</span><span class="n">FixedTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Dither disable&quot;&quot;&quot;</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tlmsid&#39;</span><span class="p">:</span> <span class="s1">&#39;AODSDITH&#39;</span><span class="p">}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dither&#39;</span><span class="p">]</span>
    <span class="n">transition_key</span> <span class="o">=</span> <span class="s1">&#39;dither&#39;</span>
    <span class="n">transition_val</span> <span class="o">=</span> <span class="s1">&#39;DISA&#39;</span></div>


<div class="viewcode-block" id="DitherParamsTransition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.DitherParamsTransition">[docs]</a><span class="k">class</span> <span class="nc">DitherParamsTransition</span><span class="p">(</span><span class="n">BaseTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Dither parameters&quot;&quot;&quot;</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tlmsid&#39;</span><span class="p">:</span> <span class="s1">&#39;AODITPAR&#39;</span><span class="p">}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dither_phase_pitch&#39;</span><span class="p">,</span> <span class="s1">&#39;dither_phase_yaw&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;dither_ampl_pitch&#39;</span><span class="p">,</span> <span class="s1">&#39;dither_ampl_yaw&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;dither_period_pitch&#39;</span><span class="p">,</span> <span class="s1">&#39;dither_period_yaw&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="DitherParamsTransition.set_transitions"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.DitherParamsTransition.set_transitions">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">set_transitions</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">transitions_dict</span><span class="p">,</span> <span class="n">cmds</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set transitions for a Table of commands ``cmds``.</span>

<span class="sd">        :param transitions_dict: global dict of transitions (updated in-place)</span>
<span class="sd">        :param cmds: commands (CmdList)</span>
<span class="sd">        :param start: start time for states</span>
<span class="sd">        :param stop: stop time for states</span>

<span class="sd">        :returns: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">state_cmds</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_state_changing_commands</span><span class="p">(</span><span class="n">cmds</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">state_cmds</span><span class="p">:</span>
            <span class="n">dither</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dither_phase_pitch&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="s1">&#39;angp&#39;</span><span class="p">]),</span>
                      <span class="s1">&#39;dither_phase_yaw&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="s1">&#39;angy&#39;</span><span class="p">]),</span>
                      <span class="s1">&#39;dither_ampl_pitch&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="s1">&#39;coefp&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">,</span>
                      <span class="s1">&#39;dither_ampl_yaw&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="s1">&#39;coefy&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">,</span>
                      <span class="s1">&#39;dither_period_pitch&#39;</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">cmd</span><span class="p">[</span><span class="s1">&#39;ratep&#39;</span><span class="p">],</span>
                      <span class="s1">&#39;dither_period_yaw&#39;</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">cmd</span><span class="p">[</span><span class="s1">&#39;ratey&#39;</span><span class="p">]}</span>
            <span class="n">transitions_dict</span><span class="p">[</span><span class="n">cmd</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dither</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="NMM_Transition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.NMM_Transition">[docs]</a><span class="k">class</span> <span class="nc">NMM_Transition</span><span class="p">(</span><span class="n">FixedTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Transition to Normal Maneuver Mode&quot;&quot;&quot;</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tlmsid&#39;</span><span class="p">:</span> <span class="s1">&#39;AONMMODE&#39;</span><span class="p">}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="n">PCAD_STATE_KEYS</span>
    <span class="n">transition_key</span> <span class="o">=</span> <span class="s1">&#39;pcad_mode&#39;</span>
    <span class="n">transition_val</span> <span class="o">=</span> <span class="s1">&#39;NMAN&#39;</span></div>


<div class="viewcode-block" id="NPM_Transition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.NPM_Transition">[docs]</a><span class="k">class</span> <span class="nc">NPM_Transition</span><span class="p">(</span><span class="n">FixedTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Transition to Normal Point Mode&quot;&quot;&quot;</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tlmsid&#39;</span><span class="p">:</span> <span class="s1">&#39;AONPMODE&#39;</span><span class="p">}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="n">PCAD_STATE_KEYS</span>
    <span class="n">transition_key</span> <span class="o">=</span> <span class="s1">&#39;pcad_mode&#39;</span>
    <span class="n">transition_val</span> <span class="o">=</span> <span class="s1">&#39;NPNT&#39;</span></div>


<div class="viewcode-block" id="AutoNPMEnableTransition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.AutoNPMEnableTransition">[docs]</a><span class="k">class</span> <span class="nc">AutoNPMEnableTransition</span><span class="p">(</span><span class="n">FixedTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Enable automatic transition to Normal Point Mode&quot;&quot;&quot;</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tlmsid&#39;</span><span class="p">:</span> <span class="s1">&#39;AONM2NPE&#39;</span><span class="p">}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="n">PCAD_STATE_KEYS</span>
    <span class="n">transition_key</span> <span class="o">=</span> <span class="s1">&#39;auto_npnt&#39;</span>
    <span class="n">transition_val</span> <span class="o">=</span> <span class="s1">&#39;ENAB&#39;</span></div>


<div class="viewcode-block" id="AutoNPMDisableTransition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.AutoNPMDisableTransition">[docs]</a><span class="k">class</span> <span class="nc">AutoNPMDisableTransition</span><span class="p">(</span><span class="n">FixedTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Disable automatic transition to Normal Point Mode&quot;&quot;&quot;</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tlmsid&#39;</span><span class="p">:</span> <span class="s1">&#39;AONM2NPD&#39;</span><span class="p">}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="n">PCAD_STATE_KEYS</span>
    <span class="n">transition_key</span> <span class="o">=</span> <span class="s1">&#39;auto_npnt&#39;</span>
    <span class="n">transition_val</span> <span class="o">=</span> <span class="s1">&#39;DISA&#39;</span></div>


<div class="viewcode-block" id="TargQuatTransition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.TargQuatTransition">[docs]</a><span class="k">class</span> <span class="nc">TargQuatTransition</span><span class="p">(</span><span class="n">BaseTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Commanded target quaternion&quot;&quot;&quot;</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;MP_TARGQUAT&#39;</span><span class="p">}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="n">PCAD_STATE_KEYS</span>

<div class="viewcode-block" id="TargQuatTransition.set_transitions"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.TargQuatTransition.set_transitions">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">set_transitions</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">transitions</span><span class="p">,</span> <span class="n">cmds</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set transitions for a Table of commands ``cmds``.</span>

<span class="sd">        :param transitions_dict: global dict of transitions (updated in-place)</span>
<span class="sd">        :param cmds: commands (CmdList)</span>
<span class="sd">        :param start: start time for states</span>
<span class="sd">        :param stop: stop time for states</span>

<span class="sd">        :returns: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">state_cmds</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_state_changing_commands</span><span class="p">(</span><span class="n">cmds</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">state_cmds</span><span class="p">:</span>
            <span class="n">transition</span> <span class="o">=</span> <span class="n">transitions</span><span class="p">[</span><span class="n">cmd</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">qc</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;q1&#39;</span><span class="p">,</span> <span class="s1">&#39;q2&#39;</span><span class="p">,</span> <span class="s1">&#39;q3&#39;</span><span class="p">,</span> <span class="s1">&#39;q4&#39;</span><span class="p">):</span>
                <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;targ_&#39;</span> <span class="o">+</span> <span class="n">qc</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="n">qc</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="ManeuverTransition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.ManeuverTransition">[docs]</a><span class="k">class</span> <span class="nc">ManeuverTransition</span><span class="p">(</span><span class="n">BaseTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Execute maneuver.  This is a relatively complex transition that computes the</span>
<span class="sd">    intermediate quaternion values for the maneuver and inserts downstream transitions to</span>
<span class="sd">    perform attitude quaternion updated accordingly.  At the end of the maneuver it</span>
<span class="sd">    schedules a NPM transition if ``auto_npnt`` is enabled.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tlmsid&#39;</span><span class="p">:</span> <span class="s1">&#39;AOMANUVR&#39;</span><span class="p">}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="n">PCAD_STATE_KEYS</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">set_transitions</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">transitions</span><span class="p">,</span> <span class="n">cmds</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">):</span>
        <span class="n">state_cmds</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_state_changing_commands</span><span class="p">(</span><span class="n">cmds</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">state_cmds</span><span class="p">:</span>
            <span class="n">transitions</span><span class="p">[</span><span class="n">cmd</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]][</span><span class="s1">&#39;maneuver_transition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">callback</span>

<div class="viewcode-block" id="ManeuverTransition.callback"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.ManeuverTransition.callback">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">transitions</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transition function callback to generate downstream transitions to perform the</span>
<span class="sd">        actual maneuver and (usually) transition to NPM at the end of maneuver.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">end_manvr_date</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">add_manvr_transitions</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">transitions</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>

        <span class="c1"># If no target attitude has been defined to this point then we cannot</span>
        <span class="c1"># do state processing for a maneuver, so drop it on the floor.</span>
        <span class="k">if</span> <span class="n">end_manvr_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># If auto-transition to NPM after manvr is enabled (this is</span>
        <span class="c1"># normally the case) then back to NPNT at end of maneuver</span>
        <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;auto_npnt&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ENAB&#39;</span><span class="p">:</span>
            <span class="n">transition</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">end_manvr_date</span><span class="p">,</span> <span class="s1">&#39;pcad_mode&#39;</span><span class="p">:</span> <span class="s1">&#39;NPNT&#39;</span><span class="p">}</span>
            <span class="n">add_transition</span><span class="p">(</span><span class="n">transitions</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">transition</span><span class="p">)</span></div>

<div class="viewcode-block" id="ManeuverTransition.add_manvr_transitions"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.ManeuverTransition.add_manvr_transitions">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">add_manvr_transitions</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">transitions</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This does the main work of adding transitions for a maneuver.  It is</span>
<span class="sd">        called by the ManeuverTransition and NormalSunTransition classes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the current target attitude state</span>
        <span class="n">targ_att</span> <span class="o">=</span> <span class="p">[</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;targ_&#39;</span> <span class="o">+</span> <span class="n">qc</span><span class="p">]</span> <span class="k">for</span> <span class="n">qc</span> <span class="ow">in</span> <span class="n">QUAT_COMPS</span><span class="p">]</span>

        <span class="c1"># Check that target attitude is defined. If start time is between</span>
        <span class="c1"># AOUPTARQ and AOMANUVR command then this will happen. In this case just</span>
        <span class="c1"># drop the maneuver on the floor, consistent with attitude state being</span>
        <span class="c1"># undefined.</span>
        <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="n">targ_att</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Deal with startup transient where spacecraft attitude is not known.</span>
        <span class="c1"># In this case first maneuver is a bogus null maneuver.</span>
        <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;q1&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">qc</span> <span class="ow">in</span> <span class="n">QUAT_COMPS</span><span class="p">:</span>
                <span class="n">state</span><span class="p">[</span><span class="n">qc</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s1">&#39;targ_&#39;</span> <span class="o">+</span> <span class="n">qc</span><span class="p">]</span>

        <span class="c1"># Get current spacecraft attitude</span>
        <span class="n">curr_att</span> <span class="o">=</span> <span class="p">[</span><span class="n">state</span><span class="p">[</span><span class="n">qc</span><span class="p">]</span> <span class="k">for</span> <span class="n">qc</span> <span class="ow">in</span> <span class="n">QUAT_COMPS</span><span class="p">]</span>

        <span class="c1"># Get attitudes for the maneuver at about 5-minute intervals.</span>
        <span class="n">atts</span> <span class="o">=</span> <span class="n">Chandra</span><span class="o">.</span><span class="n">Maneuver</span><span class="o">.</span><span class="n">attitudes</span><span class="p">(</span><span class="n">curr_att</span><span class="p">,</span> <span class="n">targ_att</span><span class="p">,</span>
                                          <span class="n">tstart</span><span class="o">=</span><span class="n">DateTime</span><span class="p">(</span><span class="n">date</span><span class="p">)</span><span class="o">.</span><span class="n">secs</span><span class="p">)</span>

        <span class="c1"># Compute pitch and off-nominal roll at the midpoint of each interval, except</span>
        <span class="c1"># also include the exact last attitude.</span>
        <span class="n">pitches</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([(</span><span class="n">atts</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pitch</span> <span class="o">+</span> <span class="n">atts</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">pitch</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                             <span class="n">atts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pitch</span><span class="p">])</span>
        <span class="n">off_nom_rolls</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([(</span><span class="n">atts</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">off_nom_roll</span> <span class="o">+</span> <span class="n">atts</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">off_nom_roll</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                                   <span class="n">atts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">off_nom_roll</span><span class="p">])</span>

        <span class="c1"># Add transitions for each bit of the maneuver.  Note that this sets the attitude</span>
        <span class="c1"># (q1..q4) at the *beginning* of each state, while setting pitch and</span>
        <span class="c1"># off_nominal_roll at the *midpoint* of each state.  This is for legacy</span>
        <span class="c1"># compatibility with Chandra.cmd_states but might be something to change since it</span>
        <span class="c1"># would probably be better to have the midpoint attitude.</span>
        <span class="k">for</span> <span class="n">att</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">off_nom_roll</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">atts</span><span class="p">,</span> <span class="n">pitches</span><span class="p">,</span> <span class="n">off_nom_rolls</span><span class="p">):</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">att</span><span class="o">.</span><span class="n">time</span><span class="p">)</span><span class="o">.</span><span class="n">date</span>
            <span class="n">transition</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">date</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">qc</span> <span class="ow">in</span> <span class="n">QUAT_COMPS</span><span class="p">:</span>
                <span class="n">transition</span><span class="p">[</span><span class="n">qc</span><span class="p">]</span> <span class="o">=</span> <span class="n">att</span><span class="p">[</span><span class="n">qc</span><span class="p">]</span>
            <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;pitch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pitch</span>
            <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;off_nom_roll&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">off_nom_roll</span>

            <span class="n">q_att</span> <span class="o">=</span> <span class="n">Quat</span><span class="p">([</span><span class="n">att</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">QUAT_COMPS</span><span class="p">])</span>
            <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">q_att</span><span class="o">.</span><span class="n">ra</span>
            <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">q_att</span><span class="o">.</span><span class="n">dec</span>
            <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;roll&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">q_att</span><span class="o">.</span><span class="n">roll</span>

            <span class="n">add_transition</span><span class="p">(</span><span class="n">transitions</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">transition</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">date</span>  <span class="c1"># Date of end of maneuver.</span></div></div>


<div class="viewcode-block" id="NormalSunTransition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.NormalSunTransition">[docs]</a><span class="k">class</span> <span class="nc">NormalSunTransition</span><span class="p">(</span><span class="n">ManeuverTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Same as ``ManeuverTransition`` except that it performs a maneuver</span>
<span class="sd">    to a normal sun pointed attitude (based on a pure-pitch maneuver from</span>
<span class="sd">    current attitude).  It also changes ``pcad_mode`` to NSUN.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tlmsid&#39;</span><span class="p">:</span> <span class="s1">&#39;AONSMSAF&#39;</span><span class="p">}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="n">PCAD_STATE_KEYS</span>

<div class="viewcode-block" id="NormalSunTransition.callback"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.NormalSunTransition.callback">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">transitions</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a transition function callback.  It directly sets the state</span>
<span class="sd">        pcad_mode to NSUN and target quaternion to the expected sun pointed</span>
<span class="sd">        attitude.  It then calls the parent method to add the actual maneuver.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Transition to NSUN</span>
        <span class="n">state</span><span class="p">[</span><span class="s1">&#39;pcad_mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;NSUN&#39;</span>

        <span class="c1"># Setup for maneuver to sun-pointed attitude from current att</span>
        <span class="n">curr_att</span> <span class="o">=</span> <span class="p">[</span><span class="n">state</span><span class="p">[</span><span class="n">qc</span><span class="p">]</span> <span class="k">for</span> <span class="n">qc</span> <span class="ow">in</span> <span class="n">QUAT_COMPS</span><span class="p">]</span>
        <span class="n">targ_att</span> <span class="o">=</span> <span class="n">Chandra</span><span class="o">.</span><span class="n">Maneuver</span><span class="o">.</span><span class="n">NSM_attitude</span><span class="p">(</span><span class="n">curr_att</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">qc</span><span class="p">,</span> <span class="n">targ_q</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">QUAT_COMPS</span><span class="p">,</span> <span class="n">targ_att</span><span class="o">.</span><span class="n">q</span><span class="p">):</span>
            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;targ_&#39;</span> <span class="o">+</span> <span class="n">qc</span><span class="p">]</span> <span class="o">=</span> <span class="n">targ_q</span>

        <span class="c1"># Do the maneuver</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">add_manvr_transitions</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">transitions</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span></div></div>


<span class="c1">###################################################################</span>
<span class="c1"># ACIS transitions</span>
<span class="c1">###################################################################</span>
<div class="viewcode-block" id="decode_power"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.decode_power">[docs]</a><span class="k">def</span> <span class="nf">decode_power</span><span class="p">(</span><span class="n">mnem</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decode number of chips and feps from a ACIS power command</span>
<span class="sd">    Return a dictionary with the number of chips and their identifiers</span>

<span class="sd">    Example:</span>

<span class="sd">    &gt;&gt;&gt; decode_power(&quot;WSPOW08F3E&quot;)</span>
<span class="sd">    {&#39;ccd_count&#39;: 5,</span>
<span class="sd">     &#39;ccds&#39;: &#39;I0 I1 I2 I3 S3 &#39;,</span>
<span class="sd">     &#39;clocking&#39;: 0,</span>
<span class="sd">     &#39;fep_count&#39;: 5,</span>
<span class="sd">     &#39;feps&#39;: &#39;1 2 3 4 5 &#39;,</span>
<span class="sd">     &#39;vid_board&#39;: 1}</span>

<span class="sd">    :param mnem: power command string</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fep_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fep_count&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;ccd_count&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s1">&#39;feps&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="s1">&#39;ccds&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="s1">&#39;vid_board&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;clocking&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

    <span class="c1"># Special case WSPOW000XX to turn off vid_board</span>
    <span class="k">if</span> <span class="n">mnem</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;WSPOW000&#39;</span><span class="p">):</span>
        <span class="n">fep_info</span><span class="p">[</span><span class="s1">&#39;vid_board&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># the hex for the commanding is after the WSPOW</span>
    <span class="n">powstr</span> <span class="o">=</span> <span class="n">mnem</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">powstr</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> in unexpected format&quot;</span> <span class="o">%</span> <span class="n">mnem</span><span class="p">)</span>

    <span class="c1"># convert the hex to decimal and &quot;&amp;&quot; it with 63 (binary 111111)</span>
    <span class="n">fepkey</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">powstr</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">63</span>
    <span class="c1"># count the true binary bits</span>
    <span class="k">for</span> <span class="n">bit</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">fepkey</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">)):</span>
            <span class="n">fep_info</span><span class="p">[</span><span class="s1">&#39;fep_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fep_info</span><span class="p">[</span><span class="s1">&#39;fep_count&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">fep_info</span><span class="p">[</span><span class="s1">&#39;feps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fep_info</span><span class="p">[</span><span class="s1">&#39;feps&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">bit</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>

    <span class="c1"># convert the hex to decimal and right shift by 8 places</span>
    <span class="n">vidkey</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">powstr</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span>

    <span class="c1"># count the true bits</span>
    <span class="k">for</span> <span class="n">bit</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">vidkey</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">)):</span>
            <span class="n">fep_info</span><span class="p">[</span><span class="s1">&#39;ccd_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fep_info</span><span class="p">[</span><span class="s1">&#39;ccd_count&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="c1"># position indicates I or S chip</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">bit</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">):</span>
                <span class="n">fep_info</span><span class="p">[</span><span class="s1">&#39;ccds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fep_info</span><span class="p">[</span><span class="s1">&#39;ccds&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;I&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">bit</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fep_info</span><span class="p">[</span><span class="s1">&#39;ccds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fep_info</span><span class="p">[</span><span class="s1">&#39;ccds&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;S&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">bit</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>

    <span class="k">return</span> <span class="n">fep_info</span></div>


<div class="viewcode-block" id="ACISTransition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.ACISTransition">[docs]</a><span class="k">class</span> <span class="nc">ACISTransition</span><span class="p">(</span><span class="n">BaseTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implement transitions for ACIS states.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ACISPKT&#39;</span><span class="p">}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;clocking&#39;</span><span class="p">,</span> <span class="s1">&#39;power_cmd&#39;</span><span class="p">,</span> <span class="s1">&#39;vid_board&#39;</span><span class="p">,</span> <span class="s1">&#39;fep_count&#39;</span><span class="p">,</span> <span class="s1">&#39;si_mode&#39;</span><span class="p">,</span> <span class="s1">&#39;ccd_count&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="ACISTransition.set_transitions"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.ACISTransition.set_transitions">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">set_transitions</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">transitions</span><span class="p">,</span> <span class="n">cmds</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set transitions for a Table of commands ``cmds``.</span>

<span class="sd">        :param transitions_dict: global dict of transitions (updated in-place)</span>
<span class="sd">        :param cmds: commands (CmdList)</span>
<span class="sd">        :param start: start time for states</span>
<span class="sd">        :param stop: stop time for states</span>

<span class="sd">        :returns: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">state_cmds</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_state_changing_commands</span><span class="p">(</span><span class="n">cmds</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">state_cmds</span><span class="p">:</span>
            <span class="n">tlmsid</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="s1">&#39;tlmsid&#39;</span><span class="p">]</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">tlmsid</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;WSPOW&#39;</span><span class="p">):</span>
                <span class="n">pwr</span> <span class="o">=</span> <span class="n">decode_power</span><span class="p">(</span><span class="n">tlmsid</span><span class="p">)</span>
                <span class="n">transitions</span><span class="p">[</span><span class="n">date</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fep_count</span><span class="o">=</span><span class="n">pwr</span><span class="p">[</span><span class="s1">&#39;fep_count&#39;</span><span class="p">],</span>
                                         <span class="n">ccd_count</span><span class="o">=</span><span class="n">pwr</span><span class="p">[</span><span class="s1">&#39;ccd_count&#39;</span><span class="p">],</span>
                                         <span class="n">vid_board</span><span class="o">=</span><span class="n">pwr</span><span class="p">[</span><span class="s1">&#39;vid_board&#39;</span><span class="p">],</span>
                                         <span class="n">clocking</span><span class="o">=</span><span class="n">pwr</span><span class="p">[</span><span class="s1">&#39;clocking&#39;</span><span class="p">],</span>
                                         <span class="n">power_cmd</span><span class="o">=</span><span class="n">tlmsid</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">tlmsid</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;XCZ0000005&#39;</span><span class="p">,</span> <span class="s1">&#39;XTZ0000005&#39;</span><span class="p">):</span>
                <span class="n">transitions</span><span class="p">[</span><span class="n">date</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">clocking</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">power_cmd</span><span class="o">=</span><span class="n">tlmsid</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">tlmsid</span> <span class="o">==</span> <span class="s1">&#39;WSVIDALLDN&#39;</span><span class="p">:</span>
                <span class="n">transitions</span><span class="p">[</span><span class="n">date</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">vid_board</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ccd_count</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                         <span class="n">power_cmd</span><span class="o">=</span><span class="n">tlmsid</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">tlmsid</span> <span class="o">==</span> <span class="s1">&#39;AA00000000&#39;</span><span class="p">:</span>
                <span class="n">transitions</span><span class="p">[</span><span class="n">date</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">clocking</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">power_cmd</span><span class="o">=</span><span class="n">tlmsid</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">tlmsid</span> <span class="o">==</span> <span class="s1">&#39;WSFEPALLUP&#39;</span><span class="p">:</span>
                <span class="n">transitions</span><span class="p">[</span><span class="n">date</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fep_count</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">power_cmd</span><span class="o">=</span><span class="n">tlmsid</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">tlmsid</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;WC&#39;</span><span class="p">):</span>
                <span class="n">transitions</span><span class="p">[</span><span class="n">date</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">si_mode</span><span class="o">=</span><span class="s1">&#39;CC_&#39;</span> <span class="o">+</span> <span class="n">tlmsid</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">7</span><span class="p">])</span>

            <span class="c1"># Two special-case raw-mode SI modes (https://github.com/sot/cmd_states/issues/23)</span>
            <span class="k">elif</span> <span class="n">tlmsid</span> <span class="o">==</span> <span class="s1">&#39;WT000B5024&#39;</span><span class="p">:</span>
                <span class="n">transitions</span><span class="p">[</span><span class="n">date</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">si_mode</span><span class="o">=</span><span class="s1">&#39;TN_000B4&#39;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">tlmsid</span> <span class="o">==</span> <span class="s1">&#39;WT000B7024&#39;</span><span class="p">:</span>
                <span class="n">transitions</span><span class="p">[</span><span class="n">date</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">si_mode</span><span class="o">=</span><span class="s1">&#39;TN_000B6&#39;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">tlmsid</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;WT&#39;</span><span class="p">):</span>
                <span class="n">transitions</span><span class="p">[</span><span class="n">date</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">si_mode</span><span class="o">=</span><span class="s1">&#39;TE_&#39;</span> <span class="o">+</span> <span class="n">tlmsid</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">7</span><span class="p">])</span></div></div>


<div class="viewcode-block" id="ACISFP_SetPointTransition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.ACISFP_SetPointTransition">[docs]</a><span class="k">class</span> <span class="nc">ACISFP_SetPointTransition</span><span class="p">(</span><span class="n">BaseTransition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implement transitions for ACIS focal plane temperature setpoint state.</span>

<span class="sd">    Looks for ACISPKT commands with TLMSID like ``WSFTNEG&lt;number&gt;``, where the</span>
<span class="sd">    ACIS FP setpoint temperature is ``-&lt;number&gt;``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">command_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ACISPKT&#39;</span><span class="p">}</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;acisfp_setpoint&#39;</span><span class="p">]</span>
    <span class="n">default_value</span> <span class="o">=</span> <span class="o">-</span><span class="mf">121.0</span>

<div class="viewcode-block" id="ACISFP_SetPointTransition.set_transitions"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.ACISFP_SetPointTransition.set_transitions">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">set_transitions</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">transitions</span><span class="p">,</span> <span class="n">cmds</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set transitions for a Table of commands ``cmds``.</span>

<span class="sd">        :param transitions_dict: global dict of transitions (updated in-place)</span>
<span class="sd">        :param cmds: commands (CmdList)</span>
<span class="sd">        :param start: start time for states</span>
<span class="sd">        :param stop: stop time for states</span>

<span class="sd">        :returns: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">state_cmds</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_state_changing_commands</span><span class="p">(</span><span class="n">cmds</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">state_cmds</span><span class="p">:</span>
            <span class="n">tlmsid</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="s1">&#39;tlmsid&#39;</span><span class="p">]</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">tlmsid</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;WSFTNEG&#39;</span><span class="p">):</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\d+)$&#39;</span><span class="p">,</span> <span class="n">tlmsid</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;unable to parse command </span><span class="si">{</span><span class="n">tlmsid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">transitions</span><span class="p">[</span><span class="n">date</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">acisfp_setpoint</span><span class="o">=-</span><span class="nb">float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span></div></div>


<span class="c1">###################################################################</span>
<span class="c1"># State transitions processing code</span>
<span class="c1">###################################################################</span>

<div class="viewcode-block" id="get_transition_classes"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.get_transition_classes">[docs]</a><span class="k">def</span> <span class="nf">get_transition_classes</span><span class="p">(</span><span class="n">state_keys</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get all BaseTransition subclasses in this module corresponding to</span>
<span class="sd">    state keys ``state_keys``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state_keys</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">state_keys</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">state_keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">state_keys</span> <span class="o">=</span> <span class="n">DEFAULT_STATE_KEYS</span>

    <span class="n">trans_classes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span>
        <span class="n">classes</span> <span class="k">for</span> <span class="n">state_key</span><span class="p">,</span> <span class="n">classes</span> <span class="ow">in</span> <span class="n">TRANSITIONS</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">state_key</span> <span class="ow">in</span> <span class="n">state_keys</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">trans_classes</span></div>


<div class="viewcode-block" id="get_transitions_list"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.get_transitions_list">[docs]</a><span class="k">def</span> <span class="nf">get_transitions_list</span><span class="p">(</span><span class="n">cmds</span><span class="p">,</span> <span class="n">state_keys</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">continuity</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For given set of commands ``cmds`` and ``state_keys``, return a list of</span>
<span class="sd">    transitions.</span>

<span class="sd">    A ``transition`` here defines a state transition.  It is a dict with a ``date`` key</span>
<span class="sd">    (date of transition) and key/value pairs corresponding to the state keys that change.</span>

<span class="sd">    If ``state_keys`` is None then all known state keys are included.</span>

<span class="sd">    :param cmds: CmdList with spacecraft commands</span>
<span class="sd">    :param state_keys: desired state keys (None, str, or list)</span>

<span class="sd">    :returns: list of dict (transitions), set of transition classes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># To start, collect transitions in a dict keyed by date.  This auto-initializes</span>
    <span class="c1"># a dict whenever a new date is used, allowing (e.g.) a single step of::</span>
    <span class="c1">#</span>
    <span class="c1">#   transitions_dict[&#39;2017:002:01:02:03.456&#39;][&#39;obsid&#39;] = 23456.</span>
    <span class="n">transitions_dict</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>

    <span class="c1"># If an initial list of transitions is provided in the continuity dict</span>
    <span class="c1"># then apply those.  These would be transitions that occur after the the</span>
    <span class="c1"># continuity time, e.g. in the case continuity in the middle of a maneuver</span>
    <span class="c1"># where we need the remaining attitude and pcad_mode transitions.</span>
    <span class="k">if</span> <span class="n">continuity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;__transitions__&#39;</span> <span class="ow">in</span> <span class="n">continuity</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">transition</span> <span class="ow">in</span> <span class="n">continuity</span><span class="p">[</span><span class="s1">&#39;__transitions__&#39;</span><span class="p">]:</span>
            <span class="n">transitions_dict</span><span class="p">[</span><span class="n">transition</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">transition</span><span class="p">)</span>

    <span class="c1"># Iterate through Transition classes which depend on or affect ``state_keys``</span>
    <span class="c1"># and ask each one to update ``transitions_dict`` in-place to include</span>
    <span class="c1"># transitions from that class.</span>
    <span class="k">for</span> <span class="n">transition_class</span> <span class="ow">in</span> <span class="n">get_transition_classes</span><span class="p">(</span><span class="n">state_keys</span><span class="p">):</span>
        <span class="n">transition_class</span><span class="o">.</span><span class="n">set_transitions</span><span class="p">(</span><span class="n">transitions_dict</span><span class="p">,</span> <span class="n">cmds</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span>

    <span class="c1"># Convert the dict of transitions (keyed by date) into an ordered list of transitions</span>
    <span class="c1"># sorted by date.  A *list* of transitions is needed to allow a transition to</span>
    <span class="c1"># dynamically generate additional (later) transitions, e.g. in the case of a maneuver.</span>
    <span class="n">transitions_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">transitions_dict</span><span class="p">):</span>
        <span class="n">transition</span> <span class="o">=</span> <span class="n">transitions_dict</span><span class="p">[</span><span class="n">date</span><span class="p">]</span>
        <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date</span>
        <span class="n">transitions_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transition</span><span class="p">)</span>

    <span class="c1"># In the rest of this module ``transitions`` is always this *list* of transitions.</span>
    <span class="k">return</span> <span class="n">transitions_list</span></div>


<div class="viewcode-block" id="add_transition"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.add_transition">[docs]</a><span class="k">def</span> <span class="nf">add_transition</span><span class="p">(</span><span class="n">transitions</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">transition</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add ``transition`` to the ``transitions`` list at the first appropriate</span>
<span class="sd">    place after the ``idx`` entry.</span>

<span class="sd">    This is typically used by dynamic transitions that are actually calling a function to</span>
<span class="sd">    generate downstream transitions.  The ManeuverTransition class is the canonical</span>
<span class="sd">    example.</span>

<span class="sd">    :param transitions: global list of transition dicts</span>
<span class="sd">    :param idx: current index into transitions in state processing</span>
<span class="sd">    :param transition: transition to add (dict)</span>

<span class="sd">    :returns: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Prevent adding command before current command since the command</span>
    <span class="c1"># interpreter is a one-pass process.</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">date</span> <span class="o">&lt;</span> <span class="n">transitions</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s1">&#39;date&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;cannot insert transition prior to current command&#39;</span><span class="p">)</span>

    <span class="c1"># Insert transition at first place where new transition date is strictly</span>
    <span class="c1"># less than existing transition date.  This implementation is linear, and</span>
    <span class="c1"># could be improved, though in practice transitions are often inserted</span>
    <span class="c1"># close to the original.</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">transitions</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">date</span> <span class="o">&lt;</span> <span class="n">transitions</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="s1">&#39;date&#39;</span><span class="p">]:</span>
            <span class="n">transitions</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">transition</span><span class="p">)</span>
            <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">transitions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transition</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_states"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.get_states">[docs]</a><span class="k">def</span> <span class="nf">get_states</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">state_keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">continuity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">reduce</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">merge_identical</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">scenario</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get table of states corresponding to intervals when ``state_keys`` parameters</span>
<span class="sd">    are unchanged given the input commands ``cmds`` or ``start`` date.</span>

<span class="sd">    If ``state_keys`` is ``None`` then the default keys</span>
<span class="sd">    ``states.DEFAULT_STATE_KEYS`` is used.  This corresponds to the &quot;classic&quot;</span>
<span class="sd">    Chandra commanded states (obsid, ACIS, PCAD, and mechanisms).  One can also</span>
<span class="sd">    provide a single state key as a a string, e.g. ``state_keys=&#39;obsid&#39;``.</span>

<span class="sd">    If the ``cmds`` argument is not provided then the ``start`` and ``stop`` are</span>
<span class="sd">    used to fetch the commands internally. If the ``stop`` date is not provided</span>
<span class="sd">    then all known commands (including future commands from approved loads) will</span>
<span class="sd">    be included.</span>

<span class="sd">    The output table will contain columns for ``state_keys`` along with</span>
<span class="sd">    ``datestart`` and ``datestop`` columns.  By default the ``reduce_states``</span>
<span class="sd">    function is called (with the supplied value of ``merge_identical``) in order</span>
<span class="sd">    to reduce down to the specified ``state_keys``.</span>

<span class="sd">    If ``reduce`` is ``False`` then ``reduce_states`` is not called and output</span>
<span class="sd">    table may include additional columns for related states.  For instance in</span>
<span class="sd">    order to compute the attitude quaternion state ``q1`` it is necessary to</span>
<span class="sd">    collect a number of other states such as ``pcad_mode`` and target</span>
<span class="sd">    quaternions ``targ_q1`` through ``targ_q4``.  One can call the</span>
<span class="sd">    ``reduce_states()`` function separately to reduce to only the desired state</span>
<span class="sd">    keys.</span>

<span class="sd">    :param start: start of states (optional, DateTime compatible)</span>
<span class="sd">    :param stop: stop of states (optional, DateTime compatible)</span>
<span class="sd">    :param state_keys: state keys of interest (optional, list or str or None)</span>
<span class="sd">    :param cmds: input commands (optional, CmdList, CommandTable)</span>
<span class="sd">    :param continuity: initial state (optional, dict)</span>
<span class="sd">    :param reduce: call reduce_states() on output</span>
<span class="sd">    :param merge_identical: merge identical states (see reduce_states() docs)</span>
<span class="sd">    :param scenario: commands archive scenario to use</span>

<span class="sd">    :returns: astropy Table of states</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Define complete list of column names for output table corresponding to</span>
    <span class="c1"># each state key.  Maintain original order and uniqueness of keys.</span>
    <span class="k">if</span> <span class="n">state_keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">state_keys</span> <span class="o">=</span> <span class="n">DEFAULT_STATE_KEYS</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state_keys</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">state_keys</span><span class="p">]</span>

    <span class="c1"># Go through each transition class which impacts desired state keys and accumulate</span>
    <span class="c1"># all the state keys that the classes touch.  For instance if user requests</span>
    <span class="c1"># state_keys=[&#39;q1&#39;] then we actually need to process all the PCAD_states state keys</span>
    <span class="c1"># and then at the end reduce down to the requested keys.</span>
    <span class="n">orig_state_keys</span> <span class="o">=</span> <span class="n">state_keys</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">state_key</span> <span class="ow">in</span> <span class="n">orig_state_keys</span><span class="p">:</span>
        <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">TRANSITION_CLASSES</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">state_key</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">state_keys</span><span class="p">:</span>
                <span class="n">state_keys</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">state_keys</span><span class="p">)</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="n">_unique</span><span class="p">(</span><span class="n">state_keys</span><span class="p">)</span>

    <span class="c1"># Get commands, either from `cmds` arg or from `start` / `stop`</span>
    <span class="k">if</span> <span class="n">cmds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;must supply either &#39;cmds&#39; argument or &#39;start&#39; argument&quot;</span><span class="p">)</span>
        <span class="n">cmds</span> <span class="o">=</span> <span class="n">commands</span><span class="o">.</span><span class="n">get_cmds</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">scenario</span><span class="o">=</span><span class="n">scenario</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">date</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">stop</span> <span class="ow">or</span> <span class="n">cmds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">date</span>  <span class="c1"># User-supplied stop or last command</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">cmds</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">date</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="n">cmds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span><span class="o">.</span><span class="n">date</span>

    <span class="c1"># Get initial state at start of commands</span>
    <span class="k">if</span> <span class="n">continuity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">continuity</span> <span class="o">=</span> <span class="n">get_continuity</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">state_keys</span><span class="p">,</span> <span class="n">scenario</span><span class="o">=</span><span class="n">scenario</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;did not find transitions&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;no continuity found for </span><span class="si">{</span><span class="n">start</span><span class="si">=}</span><span class="s1">. Need to have state &#39;</span>
                    <span class="sa">f</span><span class="s1">&#39;transitions following first command at </span><span class="si">{</span><span class="n">cmds</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> &#39;</span>
                    <span class="s1">&#39;so use a later start date.&#39;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>

    <span class="c1"># Get transitions, which is a list of dict (state key</span>
    <span class="c1"># and new state value at that date).  This goes through each active</span>
    <span class="c1"># transition class and accumulates transitions.</span>
    <span class="n">transitions</span> <span class="o">=</span> <span class="n">get_transitions_list</span><span class="p">(</span><span class="n">cmds</span><span class="p">,</span> <span class="n">state_keys</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">continuity</span><span class="p">)</span>

    <span class="c1"># List of dict to hold state values.  Datestarts is the corresponding list of</span>
    <span class="c1"># start dates for each state.</span>
    <span class="n">states</span> <span class="o">=</span> <span class="p">[</span><span class="n">StateDict</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">state_keys</span><span class="p">})]</span>
    <span class="n">datestarts</span> <span class="o">=</span> <span class="p">[</span><span class="n">start</span><span class="p">]</span>

    <span class="c1"># Apply initial ``continuity`` values.  Clear the trans_keys set after setting</span>
    <span class="c1"># first state.</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">continuity</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">state_keys</span><span class="p">:</span>
            <span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
    <span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">trans_keys</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="c1"># Do main state transition processing.  Start by making current ``state`` which is a</span>
    <span class="c1"># reference the last state in the list.</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># List of transitions that occur *after* the ``stop`` date but are needed for</span>
    <span class="c1"># continuity.  Classic example is for maneuvers if starting in the middle of a</span>
    <span class="c1"># maneuver, but this also occurs for SPMEnableTransition which puts commands</span>
    <span class="c1"># into the future.  Collect all these transitions and put into</span>
    <span class="c1"># states.meta[&#39;continuity_transitions&#39;].  This is mostly only needed for</span>
    <span class="c1"># get_continuity().</span>
    <span class="n">continuity_transitions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">transition</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">transitions</span><span class="p">):</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">transition</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span>

        <span class="c1"># Some transition classes (e.g. Maneuver) might put in transitions that</span>
        <span class="c1"># extend past the stop time.  Add to a list for potential use in continuity.</span>
        <span class="k">if</span> <span class="n">date</span> <span class="o">&gt;</span> <span class="n">stop</span><span class="p">:</span>
            <span class="n">continuity_transitions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transition</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># If transition is at a new date from current state then break the current state</span>
        <span class="c1"># and make a new one (as a copy of current).  Note that multiple transitions can</span>
        <span class="c1"># be at the same date (from commanding at same date), though that is not the usual</span>
        <span class="c1"># case.</span>
        <span class="k">if</span> <span class="n">date</span> <span class="o">!=</span> <span class="n">datestarts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>  <span class="c1"># TODO: don&#39;t break if not state.trans_keys</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
            <span class="n">datestarts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>

        <span class="c1"># Process the transition.</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">transition</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">ismethod</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="c1"># Special case of a functional transition that calls a function</span>
                <span class="c1"># instead of directly updating the state.  The function might itself</span>
                <span class="c1"># update the state or it might generate downstream transitions.</span>
                <span class="n">value</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">transitions</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;date&#39;</span><span class="p">:</span>
                <span class="c1"># Normal case of just updating current state</span>
                <span class="n">state</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="c1"># Make into an astropy Table and set up datestart/stop columns</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="n">states</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">state_keys</span><span class="p">)</span>
    <span class="n">out</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">Column</span><span class="p">(</span><span class="n">datestarts</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;datestart&#39;</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># Add datestop which is just the previous datestart.</span>
    <span class="n">datestop</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;datestart&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">datestop</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;datestart&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
    <span class="c1"># Final datestop far in the future</span>
    <span class="n">datestop</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">stop</span>
    <span class="n">out</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">Column</span><span class="p">(</span><span class="n">datestop</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;datestop&#39;</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Add corresponding tstart, tstop</span>
    <span class="n">out</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">Column</span><span class="p">(</span><span class="n">date2secs</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;datestart&#39;</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;tstart&#39;</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">out</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">Column</span><span class="p">(</span><span class="n">date2secs</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;datestop&#39;</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;tstop&#39;</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">out</span><span class="p">[</span><span class="s1">&#39;tstart&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s1">&#39;.3f&#39;</span>
    <span class="n">out</span><span class="p">[</span><span class="s1">&#39;tstop&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s1">&#39;.3f&#39;</span>

    <span class="n">out</span><span class="p">[</span><span class="s1">&#39;trans_keys&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">st</span><span class="o">.</span><span class="n">trans_keys</span> <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">states</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">reduce</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">reduce_states</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">orig_state_keys</span><span class="p">,</span> <span class="n">merge_identical</span><span class="p">)</span>

    <span class="c1"># See long comment where continuity_transitions is defined</span>
    <span class="n">out</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;continuity_transitions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">continuity_transitions</span>

    <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="reduce_states"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.reduce_states">[docs]</a><span class="k">def</span> <span class="nf">reduce_states</span><span class="p">(</span><span class="n">states</span><span class="p">,</span> <span class="n">state_keys</span><span class="p">,</span> <span class="n">merge_identical</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">all_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reduce the input ``states`` so that only transitions in the ``state_keys``</span>
<span class="sd">    are in the output.</span>

<span class="sd">    By default this also reduces the states table to only include</span>
<span class="sd">    columns for those ``state_keys``, but if the ``all_keys`` argument is</span>
<span class="sd">    ``True`` then all columns are included in the output.</span>

<span class="sd">    By default, the output table will reflect every state transition</span>
<span class="sd">    generated by commands even if this does not change the state value.  This</span>
<span class="sd">    allows uniquely identifying the time of such commanding related to a</span>
<span class="sd">    state value.  A common example of transition commanding that does not</span>
<span class="sd">    change state is the pair of ACIS stop science commands, where the second</span>
<span class="sd">    is redundant.</span>

<span class="sd">    However, if ``merge_identical`` is True then adacent states with identical</span>
<span class="sd">    values will be merged.</span>

<span class="sd">    :param states: table of states</span>
<span class="sd">    :param state_keys: notice transitions in this list of state keys</span>
<span class="sd">    :param merge_identical: merge adjacent identical states</span>
<span class="sd">    :param all_keys: if True, then all state keys are included in the output</span>

<span class="sd">    :returns: numpy recarray of reduced states</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">states</span><span class="p">,</span> <span class="n">Table</span><span class="p">):</span>
        <span class="n">states</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">states</span><span class="p">)</span>

    <span class="n">has_transitions</span> <span class="o">=</span> <span class="p">{</span><span class="n">state_key</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">states</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
                       <span class="k">for</span> <span class="n">state_key</span> <span class="ow">in</span> <span class="n">state_keys</span><span class="p">}</span>
    <span class="n">has_transition</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">states</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">state_keys</span><span class="p">:</span>
        <span class="c1"># Get array where this key has transitions</span>
        <span class="k">if</span> <span class="n">merge_identical</span><span class="p">:</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">has_transitions</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">col</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">col</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">has_trans</span> <span class="o">=</span> <span class="n">has_transitions</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">trans_keys</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="s1">&#39;trans_keys&#39;</span><span class="p">]):</span>
                <span class="n">has_trans</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">trans_keys</span>
        <span class="n">has_transitions</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Master array if *any* key has a transition</span>
        <span class="n">has_transition</span> <span class="o">|=</span> <span class="n">has_transitions</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="c1"># Create output with desired state keys and only states with a transition</span>
    <span class="k">if</span> <span class="n">all_keys</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">states</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">states</span><span class="p">[[</span><span class="s1">&#39;datestart&#39;</span><span class="p">,</span> <span class="s1">&#39;datestop&#39;</span><span class="p">,</span> <span class="s1">&#39;tstart&#39;</span><span class="p">,</span> <span class="s1">&#39;tstop&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">state_keys</span><span class="p">)]</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">has_transition</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">):</span>
        <span class="n">out</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dt</span><span class="si">}</span><span class="s1">stop&#39;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dt</span><span class="si">}</span><span class="s1">start&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">out</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dt</span><span class="si">}</span><span class="s1">stop&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">dt</span><span class="si">}</span><span class="s1">stop&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">trans_keys_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">TransKeysSet</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">))]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">state_keys</span><span class="p">:</span>
        <span class="c1"># Filter transitions for this key based on master filter (from creation of `out`).</span>
        <span class="c1"># Then get the index for these transitions.</span>
        <span class="n">has_trans</span> <span class="o">=</span> <span class="n">has_transitions</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">has_transition</span><span class="p">]</span>
        <span class="n">idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">has_trans</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">:</span>
            <span class="n">trans_keys_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="c1"># First state trans_keys is the transition keys from continuity.  Reduce</span>
    <span class="c1"># this by set intersection to the output state_keys.</span>
    <span class="k">if</span> <span class="s1">&#39;trans_keys&#39;</span> <span class="ow">in</span> <span class="n">states</span><span class="o">.</span><span class="n">colnames</span><span class="p">:</span>
        <span class="n">trans_keys_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="s1">&#39;trans_keys&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">state_keys</span><span class="p">)</span>

    <span class="n">out</span><span class="p">[</span><span class="s1">&#39;trans_keys&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">trans_keys_list</span>

    <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="get_continuity"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.get_continuity">[docs]</a><span class="k">def</span> <span class="nf">get_continuity</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">state_keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lookbacks</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span>
                   <span class="n">scenario</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the state and transition dates at ``date`` for ``state_keys``.</span>

<span class="sd">    This function finds the state at a particular date by fetching commands</span>
<span class="sd">    prior to that date and determine the states.  It returns dictionary</span>
<span class="sd">    ``continuity`` provides the state values. Included in this dict is a special</span>
<span class="sd">    key ``__dates__`` which provides the corresponding date at which the</span>
<span class="sd">    state-changing command occurred.</span>

<span class="sd">    Since some state keys like ``pitch`` change often (many times per day) while</span>
<span class="sd">    others like ``letg`` may not change for weeks, this function does dynamic</span>
<span class="sd">    lookbacks from ``date`` to find transitions for each key.  By default it</span>
<span class="sd">    will try looking back 7 days, then 30 days, then 180 days, and finally 1000</span>
<span class="sd">    days.  This lookback sequence can be controlled with the ``lookbacks``</span>
<span class="sd">    argument.</span>

<span class="sd">    If ``state_keys`` is ``None`` then the default keys ``states.DEFAULT_STATE_KEYS``</span>
<span class="sd">    is used.  This corresponds to the &quot;classic&quot; Chandra commanded states (obsid,</span>
<span class="sd">    ACIS, PCAD, and mechanisms).</span>

<span class="sd">    :param date: date (DateTime compatible, default=NOW)</span>
<span class="sd">    :param state_keys: list of state keys or str (one state key) or None</span>
<span class="sd">    :param lookbacks: list of lookback times in days (default=[7, 30, 180, 1000])</span>
<span class="sd">    :param scenario: commands archive scenario (default=None)</span>

<span class="sd">    :returns: dict of state values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state_keys</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">state_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">state_keys</span><span class="p">]</span>

    <span class="n">lookbacks</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">lookbacks</span><span class="p">)</span>
    <span class="n">stop</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">state_keys</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">state_keys</span> <span class="o">=</span> <span class="n">DEFAULT_STATE_KEYS</span>

    <span class="n">continuity</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">dates</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># List of transitions that occur *after* the ``stop`` date but are still needed</span>
    <span class="c1"># to compute states.  Classic example is for maneuvers, but this also occurs for</span>
    <span class="c1"># SPMEnableTransition which puts commands into the future.  Collect all these</span>
    <span class="c1"># transitions and eventually add to the output continuity dict as the</span>
    <span class="c1"># __transitions__ key.  Then ``get_states`` uses this to initialize transitions.</span>
    <span class="n">continuity_transitions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">lookback</span> <span class="ow">in</span> <span class="n">lookbacks</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">lookback</span>
        <span class="n">cmds</span> <span class="o">=</span> <span class="n">commands</span><span class="o">.</span><span class="n">get_cmds</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">scenario</span><span class="o">=</span><span class="n">scenario</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmds</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">for</span> <span class="n">state_key</span> <span class="ow">in</span> <span class="n">state_keys</span><span class="p">:</span>
            <span class="c1"># Don&#39;t bother if we already have a value for this key.</span>
            <span class="k">if</span> <span class="n">state_key</span> <span class="ow">in</span> <span class="n">continuity</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Get available commanded states for this particular state_key.  This may</span>
            <span class="c1"># return state values for many more keys (e.g. PCAD-related), and some or all</span>
            <span class="c1"># of these might be None if the relevant command never happened.  Fill in</span>
            <span class="c1"># continuity as possible from last state (corresponding to the state after the</span>
            <span class="c1"># last command in cmds).</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Note that we need to specify start and stop to ensure that the states span</span>
                <span class="c1"># the required time range. Without this the time range of cmds is used which</span>
                <span class="c1"># can give unexpected outputs if ``date``` is within a maneuver.</span>
                <span class="n">states</span> <span class="o">=</span> <span class="n">get_states</span><span class="p">(</span><span class="n">state_keys</span><span class="o">=</span><span class="n">state_key</span><span class="p">,</span> <span class="n">cmds</span><span class="o">=</span><span class="n">cmds</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span>
                                    <span class="n">continuity</span><span class="o">=</span><span class="p">{},</span> <span class="n">reduce</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">scenario</span><span class="o">=</span><span class="n">scenario</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">NoTransitionsError</span><span class="p">:</span>
                <span class="c1"># No transitions within `cmds` for state_key, continue with other keys</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># get_states() sets this meta value with a list of transitions that were beyond</span>
                <span class="c1"># the stop time and did not get processed.</span>
                <span class="n">continuity_transitions</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;continuity_transitions&#39;</span><span class="p">])</span>

            <span class="n">colnames</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">colnames</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;datestart&#39;</span><span class="p">,</span> <span class="s1">&#39;datestop&#39;</span><span class="p">,</span>
                                                   <span class="s1">&#39;tstart&#39;</span><span class="p">,</span> <span class="s1">&#39;tstop&#39;</span><span class="p">,</span> <span class="s1">&#39;trans_keys&#39;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">colname</span> <span class="ow">in</span> <span class="n">colnames</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">states</span><span class="p">[</span><span class="n">colname</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Reduce states to only the desired state_key</span>
                    <span class="n">red_states</span> <span class="o">=</span> <span class="n">reduce_states</span><span class="p">(</span><span class="n">states</span><span class="p">,</span> <span class="p">[</span><span class="n">colname</span><span class="p">])</span>
                    <span class="n">continuity</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span> <span class="o">=</span> <span class="n">red_states</span><span class="p">[</span><span class="n">colname</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">dates</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span> <span class="o">=</span> <span class="n">red_states</span><span class="p">[</span><span class="s1">&#39;datestart&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># If we have filled in continuity for every key then we&#39;re done.</span>
        <span class="c1"># Otherwise bump the lookback and try again.</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">state_key</span> <span class="ow">in</span> <span class="n">continuity</span> <span class="k">for</span> <span class="n">state_key</span> <span class="ow">in</span> <span class="n">state_keys</span><span class="p">):</span>
            <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Didn&#39;t find all state keys</span>
        <span class="n">missing_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">state_keys</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">continuity</span><span class="p">)</span>

        <span class="c1"># Try to get defaults from transition classes</span>
        <span class="k">for</span> <span class="n">missing_key</span> <span class="ow">in</span> <span class="n">missing_keys</span><span class="p">:</span>
            <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">get_transition_classes</span><span class="p">(</span><span class="n">missing_key</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s1">&#39;default_value&#39;</span><span class="p">):</span>
                    <span class="n">continuity</span><span class="p">[</span><span class="n">missing_key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">default_value</span>
                    <span class="n">dates</span><span class="p">[</span><span class="n">missing_key</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;DEFAULT&#39;</span>

        <span class="c1"># Try again...</span>
        <span class="n">missing_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">state_keys</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">continuity</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">missing_keys</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;did not find transitions for state key(s)&#39;</span>
                             <span class="s1">&#39; </span><span class="si">{}</span><span class="s1"> within </span><span class="si">{}</span><span class="s1"> days of </span><span class="si">{}</span><span class="s1">.  Maybe adjust the `lookbacks` argument?&#39;</span>
                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">missing_keys</span><span class="p">,</span> <span class="n">lookbacks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">stop</span><span class="o">.</span><span class="n">date</span><span class="p">))</span>

    <span class="c1"># Finally reduce down to the state_keys the user requested</span>
    <span class="n">continuity</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">continuity</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">state_keys</span><span class="p">}</span>
    <span class="n">dates</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">dates</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">state_keys</span><span class="p">}</span>
    <span class="n">continuity</span><span class="p">[</span><span class="s1">&#39;__dates__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dates</span>

    <span class="c1"># List of transitions needed to fully express continuity.  See long comment above.</span>
    <span class="k">if</span> <span class="n">continuity_transitions</span><span class="p">:</span>
        <span class="n">continuity</span><span class="p">[</span><span class="s1">&#39;__transitions__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">continuity_transitions</span>

    <span class="k">return</span> <span class="n">continuity</span></div>


<div class="viewcode-block" id="interpolate_states"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.interpolate_states">[docs]</a><span class="k">def</span> <span class="nf">interpolate_states</span><span class="p">(</span><span class="n">states</span><span class="p">,</span> <span class="n">times</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Interpolate ``states`` table at given times.</span>

<span class="sd">    :param states: states (astropy states Table)</span>
<span class="sd">    :param times: times (np.array or any DateTime compatible input)</span>

<span class="sd">    :returns: ``states`` view at ``times``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Column</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="n">times</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">!=</span> <span class="s1">&#39;f&#39;</span><span class="p">:</span>
        <span class="n">times</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">times</span><span class="p">)</span><span class="o">.</span><span class="n">secs</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">tstops</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="s1">&#39;tstop&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
        <span class="n">tstops</span> <span class="o">=</span> <span class="n">date2secs</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="s1">&#39;datestop&#39;</span><span class="p">])</span>

    <span class="n">indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">tstops</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="n">indexes</span><span class="p">]</span>
    <span class="n">out</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">Column</span><span class="p">(</span><span class="n">secs2date</span><span class="p">(</span><span class="n">times</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span></div>


<span class="k">def</span> <span class="nf">_unique</span><span class="p">(</span><span class="n">seq</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return unique elements of ``seq`` in order&quot;&quot;&quot;</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">seen_add</span> <span class="o">=</span> <span class="n">seen</span><span class="o">.</span><span class="n">add</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">seq</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">seen</span> <span class="ow">or</span> <span class="n">seen_add</span><span class="p">(</span><span class="n">x</span><span class="p">))]</span>


<div class="viewcode-block" id="print_state_keys_transition_classes_docs"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.print_state_keys_transition_classes_docs">[docs]</a><span class="k">def</span> <span class="nf">print_state_keys_transition_classes_docs</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sort transition classes into a data structure keyed by state_keys</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">state_keys_classes</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">TRANSITION_CLASSES</span><span class="p">:</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">state_keys</span><span class="p">)</span>
        <span class="n">state_keys_classes</span><span class="p">[</span><span class="n">keys</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">keys</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">state_keys_classes</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;``</span><span class="si">{}</span><span class="s1">``&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">))</span>
        <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">state_keys_classes</span><span class="p">[</span><span class="n">keys</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="bp">cls</span><span class="p">:</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  - :class:`~</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">`&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">()</span></div>


<div class="viewcode-block" id="get_chandra_states"><a class="viewcode-back" href="../../../api.html#kadi.commands.states.get_chandra_states">[docs]</a><span class="k">def</span> <span class="nf">get_chandra_states</span><span class="p">(</span><span class="n">main_args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Command line interface to output commanded states over a date range in tabular form</span>
<span class="sd">    to stdout or a file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">argparse</span>
    <span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">ascii</span>

    <span class="n">descr</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Ouput the Chandra commanded states over a date range &#39;</span>
             <span class="s1">&#39;as a space-delimited ASCII table.&#39;</span><span class="p">)</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="n">descr</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--start&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Start date (default=Now-10 days)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--stop&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Stop date (default=None)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--state-keys&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Comma-separated list of state keys&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--merge-identical&quot;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Merge adjacent states that have identical values &quot;</span>
                        <span class="s2">&quot;(default=False)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--outfile&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Output file (default=stdout)&quot;</span><span class="p">)</span>

    <span class="n">opt</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">main_args</span><span class="p">)</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">()</span> <span class="o">-</span> <span class="mi">10</span> <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
    <span class="n">stop</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>
    <span class="n">state_keys</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">state_keys</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">state_keys</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">states</span> <span class="o">=</span> <span class="n">get_states</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">state_keys</span><span class="p">,</span> <span class="n">merge_identical</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">merge_identical</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">states</span><span class="p">[</span><span class="s1">&#39;trans_keys&#39;</span><span class="p">]</span>
    <span class="k">del</span> <span class="n">states</span><span class="p">[</span><span class="s1">&#39;tstart&#39;</span><span class="p">]</span>
    <span class="k">del</span> <span class="n">states</span><span class="p">[</span><span class="s1">&#39;tstop&#39;</span><span class="p">]</span>

    <span class="n">ascii</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">states</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">opt</span><span class="o">.</span><span class="n">outfile</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;fixed_width&#39;</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/ska.png" alt="Logo"/>
            </a></p><h3>Page Contents</h3>


<form action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2013, Tom Aldcroft.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 4.2.0. &nbsp;
  </p>
</footer>
  </body>
</html>