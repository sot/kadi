<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>kadi.commands.commands_v2 &#8212; kadi 7.10.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../_static/bootstrap-astropy.css?v=f4f7060c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/plot_directive.css" />
    
    <script src="../../../_static/documentation_options.js?v=4c31421e"></script>
    <script src="../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script type="text/javascript" src="../../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../../_static/copybutton.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../../index.html"><span id="logotext1">Ska!</span><span id="logotext2">Kadi</span><span id="logotext3"></span></a>
  <ul>
    
    <li><a class="home" title="Homepage" href="https://sot.github.io/">
        <span id="logotext1">ska</span><span id="logotext2">tools</span>
    </a></li>
    <li><a title="General Index" href="../../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../../index.html">kadi 7.10.1 documentation</a>
	 &#187;
      </li>
      <li><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for kadi.commands.commands_v2</h1><div class="highlight"><pre>
<span></span><span class="c1"># Licensed under a 3-clause BSD style license - see LICENSE.rst</span>
<span class="kn">import</span> <span class="nn">calendar</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">difflib</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">weakref</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>

<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">chandra_maneuver</span> <span class="kn">import</span> <span class="n">NSM_attitude</span>
<span class="kn">from</span> <span class="nn">cxotime</span> <span class="kn">import</span> <span class="n">CxoTime</span>
<span class="kn">from</span> <span class="nn">parse_cm.paths</span> <span class="kn">import</span> <span class="n">load_dir_from_load_name</span>
<span class="kn">from</span> <span class="nn">testr.test_helper</span> <span class="kn">import</span> <span class="n">has_internet</span>

<span class="kn">from</span> <span class="nn">kadi</span> <span class="kn">import</span> <span class="n">occweb</span><span class="p">,</span> <span class="n">paths</span>
<span class="kn">from</span> <span class="nn">kadi.commands.command_sets</span> <span class="kn">import</span> <span class="n">get_cmds_from_event</span>
<span class="kn">from</span> <span class="nn">kadi.commands.core</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CommandTable</span><span class="p">,</span>
    <span class="n">LazyVal</span><span class="p">,</span>
    <span class="n">_find</span><span class="p">,</span>
    <span class="n">get_cmds_from_backstop</span><span class="p">,</span>
    <span class="n">get_par_idx_update_pars_dict</span><span class="p">,</span>
    <span class="n">load_idx_cmds</span><span class="p">,</span>
    <span class="n">load_name_to_cxotime</span><span class="p">,</span>
    <span class="n">load_pars_dict</span><span class="p">,</span>
    <span class="n">vstack_exact</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">kadi.config</span> <span class="kn">import</span> <span class="n">conf</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;clear_caches&quot;</span><span class="p">,</span> <span class="s2">&quot;get_cmds&quot;</span><span class="p">]</span>

<span class="c1"># TODO configuration options, but use DEFAULT_* in the mean time</span>

<span class="n">MATCHING_BLOCK_SIZE</span> <span class="o">=</span> <span class="mi">500</span>

<span class="c1"># TODO: cache translation from cmd_events to CommandTable&#39;s  [Probably not]</span>

<span class="n">APPROVED_LOADS_OCCWEB_DIR</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;FOT/mission_planning/PRODUCTS/APPR_LOADS&quot;</span><span class="p">)</span>

<span class="c1"># URL to download google sheets `doc_id`</span>
<span class="c1"># See https://stackoverflow.com/questions/33713084 (original question).</span>
<span class="c1"># See also kadi.commands.cmds_validate for the long-form URL.</span>
<span class="n">CMD_EVENTS_SHEET_URL</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;https://docs.google.com/spreadsheets/d/</span><span class="si">{doc_id}</span><span class="s2">/export?format=csv&quot;</span>
<span class="p">)</span>

<span class="c1"># Cached values of the full mission commands archive (cmds_v2.h5, cmds_v2.pkl).</span>
<span class="c1"># These are loaded on demand.</span>
<span class="n">IDX_CMDS</span> <span class="o">=</span> <span class="n">LazyVal</span><span class="p">(</span><span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">load_idx_cmds</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
<span class="n">PARS_DICT</span> <span class="o">=</span> <span class="n">LazyVal</span><span class="p">(</span><span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">load_pars_dict</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
<span class="n">REV_PARS_DICT</span> <span class="o">=</span> <span class="n">LazyVal</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">PARS_DICT</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>

<span class="c1"># Cache of recent commands keyed by scenario</span>
<span class="n">CMDS_RECENT</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">MATCHING_BLOCKS</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1"># APR1420B was the first load set to have RLTT (backstop 6.9)</span>
<span class="n">RLTT_ERA_START</span> <span class="o">=</span> <span class="n">CxoTime</span><span class="p">(</span><span class="s2">&quot;2020-04-14&quot;</span><span class="p">)</span>

<span class="n">HAS_INTERNET</span> <span class="o">=</span> <span class="n">has_internet</span><span class="p">()</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="clear_caches">
<a class="viewcode-back" href="../../../api_commands.html#kadi.commands.commands_v2.clear_caches">[docs]</a>
<span class="k">def</span> <span class="nf">clear_caches</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Clear all commands caches.</span>

<span class="sd">    This is useful for testing and in case upstream products like the Command</span>
<span class="sd">    Events sheet have changed during a session.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">CMDS_RECENT</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">MATCHING_BLOCKS</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span><span class="n">IDX_CMDS</span><span class="p">,</span> <span class="n">PARS_DICT</span><span class="p">,</span> <span class="n">REV_PARS_DICT</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">var</span><span class="o">.</span><span class="n">_val</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="kn">from</span> <span class="nn">kadi.commands.observations</span> <span class="kn">import</span> <span class="n">OBSERVATIONS</span>

    <span class="n">OBSERVATIONS</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></div>



<span class="k">def</span> <span class="nf">_merge_cmds_archive_recent</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">scenario</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Merge cmds archive from ``start`` onward with recent cmds for ``scenario``</span>

<span class="sd">    This assumes:</span>
<span class="sd">    - CMDS_RECENT cache has been set with that scenario.</span>
<span class="sd">    - Recent commands overlap the cmds archive</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    start : CxoTime-like</span>
<span class="sd">        Start time for returned commands</span>
<span class="sd">    scenario : str</span>
<span class="sd">        Scenario name</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    CommandTable</span>
<span class="sd">        Commands from cmds archive and all recent commands</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cmds_recent</span> <span class="o">=</span> <span class="n">CMDS_RECENT</span><span class="p">[</span><span class="n">scenario</span><span class="p">]</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Merging cmds_recent with archive commands from </span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">scenario</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">MATCHING_BLOCKS</span><span class="p">:</span>
        <span class="c1"># Get index for start of cmds_recent within the cmds archive</span>
        <span class="n">i0_arch_recent</span> <span class="o">=</span> <span class="n">IDX_CMDS</span><span class="o">.</span><span class="n">find_date</span><span class="p">(</span><span class="n">cmds_recent</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Find the end of the first large (MATCHING_BLOCK_SIZE) block of</span>
        <span class="c1"># cmds_recent that overlap with archive cmds. Look for the matching</span>
        <span class="c1"># block in a subset of archive cmds that starts at the start of</span>
        <span class="c1"># cmds_recent. `arch_recent_offset` is the offset from `i0_arch_recent`</span>
        <span class="c1"># to the end of the matching block. `i0_recent` is the end of the</span>
        <span class="c1"># matching block in recent commands.</span>
        <span class="n">arch_recent_offset</span><span class="p">,</span> <span class="n">recent_block_end</span> <span class="o">=</span> <span class="n">get_matching_block_idx</span><span class="p">(</span>
            <span class="n">IDX_CMDS</span><span class="p">[</span><span class="n">i0_arch_recent</span><span class="p">:],</span> <span class="n">cmds_recent</span>
        <span class="p">)</span>
        <span class="n">arch_block_end</span> <span class="o">=</span> <span class="n">i0_arch_recent</span> <span class="o">+</span> <span class="n">arch_recent_offset</span>
        <span class="n">MATCHING_BLOCKS</span><span class="p">[</span><span class="n">scenario</span><span class="p">]</span> <span class="o">=</span> <span class="n">arch_block_end</span><span class="p">,</span> <span class="n">recent_block_end</span><span class="p">,</span> <span class="n">i0_arch_recent</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">arch_block_end</span><span class="p">,</span> <span class="n">recent_block_end</span><span class="p">,</span> <span class="n">i0_arch_recent</span> <span class="o">=</span> <span class="n">MATCHING_BLOCKS</span><span class="p">[</span><span class="n">scenario</span><span class="p">]</span>

    <span class="c1"># Get archive commands from the requested start time (or start of the overlap</span>
    <span class="c1"># with recent commands) to the end of the matching block in recent commands.</span>
    <span class="n">i0_arch_start</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">IDX_CMDS</span><span class="o">.</span><span class="n">find_date</span><span class="p">(</span><span class="n">start</span><span class="p">),</span> <span class="n">i0_arch_recent</span><span class="p">)</span>
    <span class="n">cmds_arch</span> <span class="o">=</span> <span class="n">IDX_CMDS</span><span class="p">[</span><span class="n">i0_arch_start</span><span class="p">:</span><span class="n">arch_block_end</span><span class="p">]</span>

    <span class="c1"># Stored archive commands HDF5 has no `params` column, instead storing an</span>
    <span class="c1"># index to the param values which are in PARS_DICT. Add `params` object</span>
    <span class="c1"># column with None values and then stack with cmds_recent (which has</span>
    <span class="c1"># `params` already as dicts).</span>
    <span class="n">cmds</span> <span class="o">=</span> <span class="n">vstack_exact</span><span class="p">([</span><span class="n">cmds_arch</span><span class="p">,</span> <span class="n">cmds_recent</span><span class="p">[</span><span class="n">recent_block_end</span><span class="p">:]])</span>

    <span class="c1"># Need to give CommandTable a ref to REV_PARS_DICT so it can tranlate from</span>
    <span class="c1"># params index to the actual dict of values. Stored as a weakref so that</span>
    <span class="c1"># pickling and other serialization doesn&#39;t break.</span>
    <span class="n">cmds</span><span class="o">.</span><span class="n">rev_pars_dict</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">REV_PARS_DICT</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cmds</span>


<span class="k">def</span> <span class="nf">get_matching_block_idx_simple</span><span class="p">(</span><span class="n">cmds_recent</span><span class="p">,</span> <span class="n">cmds_arch</span><span class="p">,</span> <span class="n">min_match</span><span class="p">):</span>
    <span class="c1"># Find the first command in cmd_arch that starts at the same date as the</span>
    <span class="c1"># block of recent commands. There might be multiple commands at the same</span>
    <span class="c1"># date, so we walk through this getting a block match of `min_match` size.</span>
    <span class="c1"># Matching block is defined by all `key_names` columns matching.</span>
    <span class="n">date0</span> <span class="o">=</span> <span class="n">cmds_recent</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">i0_arch</span> <span class="o">=</span> <span class="n">cmds_arch</span><span class="o">.</span><span class="n">find_date</span><span class="p">(</span><span class="n">date0</span><span class="p">)</span>
    <span class="n">key_names</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;tlmsid&quot;</span><span class="p">,</span> <span class="s2">&quot;scs&quot;</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">,</span> <span class="s2">&quot;vcdu&quot;</span><span class="p">)</span>

    <span class="c1"># Find block of commands in cmd_arch that match first min_match of</span>
    <span class="c1"># cmds_recent. Special case is min_match=0, which means we just want to</span>
    <span class="c1"># append the cmds_recent to the end of cmds_arch. This is the case for</span>
    <span class="c1"># the transition from pre-RLTT (APR1420B) to post, for the one-time</span>
    <span class="c1"># migration from version 1 to version 2.</span>
    <span class="k">while</span> <span class="n">min_match</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span>
                <span class="n">cmds_arch</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">i0_arch</span> <span class="p">:</span> <span class="n">i0_arch</span> <span class="o">+</span> <span class="n">min_match</span><span class="p">]</span>
                <span class="o">==</span> <span class="n">cmds_recent</span><span class="p">[</span><span class="n">name</span><span class="p">][:</span><span class="n">min_match</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">key_names</span>
        <span class="p">):</span>
            <span class="k">break</span>
        <span class="c1"># No joy, step forward and make sure date still matches</span>
        <span class="n">i0_arch</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">cmds_arch</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">][</span><span class="n">i0_arch</span><span class="p">]</span> <span class="o">!=</span> <span class="n">date0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;No matching commands block in archive found for recent_commands&quot;</span>
            <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found matching commands block in archive at </span><span class="si">{</span><span class="n">i0_arch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">i0_arch</span>


<div class="viewcode-block" id="get_cmds">
<a class="viewcode-back" href="../../../api_commands.html#kadi.commands.commands_v2.get_cmds">[docs]</a>
<span class="k">def</span> <span class="nf">get_cmds</span><span class="p">(</span>
    <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">inclusive_stop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">scenario</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CommandTable</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get commands using loads table, relying entirely on RLTT.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    start : CxoTime-like</span>
<span class="sd">        Start time for cmds</span>
<span class="sd">    stop : CxoTime-like</span>
<span class="sd">        Stop time for cmds</span>
<span class="sd">    scenario : str, None</span>
<span class="sd">        Scenario name</span>
<span class="sd">    inclusive_stop : bool</span>
<span class="sd">        Include commands at exactly ``stop`` if True.</span>
<span class="sd">    loads_stop : CxoTime-like, None</span>
<span class="sd">        Stop time for loads table (default is all available loads, but useful</span>
<span class="sd">        for development/testing work)</span>
<span class="sd">    **kwargs : dict</span>
<span class="sd">        key=val keyword argument pairs for filtering</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    CommandTable</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Getting commands from </span><span class="si">{</span><span class="n">CxoTime</span><span class="p">(</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">CxoTime</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">scenario</span><span class="si">=}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">scenario</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;KADI_SCENARIO&quot;</span><span class="p">,</span> <span class="n">scenario</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">CxoTime</span><span class="p">(</span><span class="s2">&quot;1999:001&quot;</span> <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">start</span><span class="p">)</span>
    <span class="n">stop</span> <span class="o">=</span> <span class="p">(</span><span class="n">CxoTime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">year</span><span class="p">)</span> <span class="k">if</span> <span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">CxoTime</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span>

    <span class="c1"># Default stop is either now (typically) or set by env var</span>
    <span class="n">default_stop</span> <span class="o">=</span> <span class="n">CxoTime</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;KADI_COMMANDS_DEFAULT_STOP&quot;</span><span class="p">))</span>

    <span class="c1"># For flight scenario or no internet or if the query stop time is guaranteed</span>
    <span class="c1"># to not require recent commands then just use the archive.</span>
    <span class="n">before_recent_cmds</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">&lt;</span> <span class="n">default_stop</span> <span class="o">-</span> <span class="n">conf</span><span class="o">.</span><span class="n">default_lookback</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">day</span>
    <span class="k">if</span> <span class="n">scenario</span> <span class="o">==</span> <span class="s2">&quot;flight&quot;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">HAS_INTERNET</span> <span class="ow">or</span> <span class="n">before_recent_cmds</span><span class="p">:</span>
        <span class="n">cmds</span> <span class="o">=</span> <span class="n">IDX_CMDS</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Getting commands from archive only because of:&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">scenario</span><span class="si">=}</span><span class="s2"> </span><span class="si">{</span><span class="n">before_recent_cmds</span><span class="si">=}</span><span class="s2"> </span><span class="si">{</span><span class="n">HAS_INTERNET</span><span class="si">=}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">scenario</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">CMDS_RECENT</span><span class="p">:</span>
            <span class="n">cmds_recent</span> <span class="o">=</span> <span class="n">update_archive_and_get_cmds_recent</span><span class="p">(</span>
                <span class="n">scenario</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pars_dict</span><span class="o">=</span><span class="n">PARS_DICT</span><span class="p">,</span> <span class="n">rev_pars_dict</span><span class="o">=</span><span class="n">REV_PARS_DICT</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmds_recent</span> <span class="o">=</span> <span class="n">CMDS_RECENT</span><span class="p">[</span><span class="n">scenario</span><span class="p">]</span>

        <span class="c1"># Get `cmds` as correct mix of recent and archive commands that contains</span>
        <span class="c1"># the requested date range.</span>
        <span class="k">if</span> <span class="n">stop</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;</span> <span class="n">cmds_recent</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
            <span class="c1"># Query does not overlap with recent commands, just use archive.</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Getting commands from archive only: stop &lt; first commands recent for&quot;</span>
                <span class="s2">&quot; {scenario=}&quot;</span>
            <span class="p">)</span>
            <span class="n">cmds</span> <span class="o">=</span> <span class="n">IDX_CMDS</span>
        <span class="k">elif</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="n">CxoTime</span><span class="p">(</span><span class="n">cmds_recent</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;loads_start&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">day</span><span class="p">:</span>
            <span class="c1"># Query starts near beginning of recent commands and *might* need some</span>
            <span class="c1"># archive commands. The margin is set at 3 days to ensure that OBS</span>
            <span class="c1"># command continuity is maintained (there is at least one maneuver).</span>
            <span class="c1"># See also the DESIGN commentary after the function.</span>
            <span class="n">cmds</span> <span class="o">=</span> <span class="n">_merge_cmds_archive_recent</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">scenario</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Getting commands from archive + recent: start &lt; recent loads start +&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; 3 days for </span><span class="si">{</span><span class="n">scenario</span><span class="si">=}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Query is strictly within recent commands.</span>
            <span class="n">cmds</span> <span class="o">=</span> <span class="n">cmds_recent</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Getting commands from recent only: start and stop are within recent&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; commands for </span><span class="si">{</span><span class="n">scenario</span><span class="si">=}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="c1"># Select the requested time range and make a copy. (Slicing is a view so</span>
    <span class="c1"># in theory bad things could happen without a copy).</span>
    <span class="n">idx0</span> <span class="o">=</span> <span class="n">cmds</span><span class="o">.</span><span class="n">find_date</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
    <span class="n">idx1</span> <span class="o">=</span> <span class="n">cmds</span><span class="o">.</span><span class="n">find_date</span><span class="p">(</span><span class="n">stop</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;right&quot;</span> <span class="k">if</span> <span class="n">inclusive_stop</span> <span class="k">else</span> <span class="s2">&quot;left&quot;</span><span class="p">))</span>
    <span class="n">cmds</span> <span class="o">=</span> <span class="n">cmds</span><span class="p">[</span><span class="n">idx0</span><span class="p">:</span><span class="n">idx1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="c1"># Specified extra filters on cmds search</span>
        <span class="n">pars_dict</span> <span class="o">=</span> <span class="n">PARS_DICT</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># For any recent commands that have params as a dict, those will have</span>
        <span class="c1"># idx = -1. This doesn&#39;t work with _find, which is optimized to search</span>
        <span class="c1"># pars_dict for the matching search keys.</span>
        <span class="c1"># TODO: this step is only really required for kwargs that are not a column,</span>
        <span class="c1"># i.e. keys that are found only in params.</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">cmds</span><span class="p">[</span><span class="s2">&quot;idx&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">cmds</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="s2">&quot;idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_par_idx_update_pars_dict</span><span class="p">(</span><span class="n">pars_dict</span><span class="p">,</span> <span class="n">cmds</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
        <span class="n">cmds</span> <span class="o">=</span> <span class="n">_find</span><span class="p">(</span><span class="n">idx_cmds</span><span class="o">=</span><span class="n">cmds</span><span class="p">,</span> <span class="n">pars_dict</span><span class="o">=</span><span class="n">pars_dict</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">cmds</span><span class="o">.</span><span class="n">rev_pars_dict</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">REV_PARS_DICT</span><span class="p">)</span>

    <span class="n">cmds</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="s2">&quot;.3f&quot;</span>

    <span class="k">return</span> <span class="n">cmds</span></div>



<span class="c1"># DESIGN commentary on this line in the above code::</span>
<span class="c1">#    start &lt; CxoTime(cmds_recent.meta[&quot;loads_start&quot;]) + 3 * u.day</span>
<span class="c1">#</span>
<span class="c1"># The question being asked here is &quot;are there any applicable archive load</span>
<span class="c1"># commands which are NOT available from the recent load commands (i.e. the last</span>
<span class="c1"># 4 weeks of weekly loads)?&quot;.  Imagine these inputs:</span>
<span class="c1">#</span>
<span class="c1">#   start = Apr-02-2022</span>
<span class="c1">#   Loads = APR0122 (Never run due to anomaly), APR0622 (replan), APR0822,  APR1522,</span>
<span class="c1">#           APR2222</span>
<span class="c1">#   cmds_recent.meta[&quot;loads_start&quot;] = Apr-01-2022 (first command in APR0122 approx)</span>
<span class="c1">#</span>
<span class="c1"># So what we care about is the first command in the applicable loads in the time</span>
<span class="c1"># span, not the first actually run load command in the span. The reason is that</span>
<span class="c1"># the archive is not going to provide additional commands here because the</span>
<span class="c1"># APR0122 commands will also not be in the archive.</span>


<span class="k">def</span> <span class="nf">update_archive_and_get_cmds_recent</span><span class="p">(</span>
    <span class="n">scenario</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">lookback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">pars_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">rev_pars_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update local loads table and downloaded loads and return all recent cmds.</span>

<span class="sd">    This is the main entry point for getting recent commands and for updating</span>
<span class="sd">    the archive HDF5 file.</span>

<span class="sd">    This also caches the recent commands in the global CMDS_RECENT dict.</span>

<span class="sd">    This relies entirely on RLTT and load_events to assemble the commands.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    scenario : str, None</span>
<span class="sd">        Scenario name</span>
<span class="sd">    lookback : int, Quantity, None</span>
<span class="sd">        Lookback time from ``stop`` for recent loads. If None, use</span>
<span class="sd">        conf.default_lookback.</span>
<span class="sd">    stop : CxoTime-like, None</span>
<span class="sd">        Stop time for loads table (default is now + 21 days)</span>
<span class="sd">    cache : bool</span>
<span class="sd">        Cache the result in CMDS_RECENT dict.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    CommandTable</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># List of CommandTable objects from loads and cmd_events</span>
    <span class="n">cmds_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">CommandTable</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Update local cmds_events.csv from Google Sheets</span>
    <span class="n">cmd_events</span> <span class="o">=</span> <span class="n">update_cmd_events</span><span class="p">(</span><span class="n">scenario</span><span class="p">)</span>

    <span class="c1"># Get load names that were not run at all or where observing was not run.</span>
    <span class="c1"># E.g. an SCS-107 near end of loads where next week vehicle loads only were</span>
    <span class="c1"># uplinked.</span>
    <span class="n">not_run_loads</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">not_run_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Load&quot;</span><span class="p">,</span> <span class="s2">&quot;Observing&quot;</span><span class="p">,</span> <span class="s2">&quot;HRC&quot;</span><span class="p">):</span>
        <span class="n">not_run_loads</span><span class="p">[</span><span class="n">not_run_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">cmd_event</span><span class="p">[</span><span class="s2">&quot;Params&quot;</span><span class="p">]:</span> <span class="n">cmd_event</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">cmd_event</span> <span class="ow">in</span> <span class="n">cmd_events</span>
            <span class="k">if</span> <span class="n">cmd_event</span><span class="p">[</span><span class="s2">&quot;Event&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">not_run_type</span><span class="si">}</span><span class="s2"> not run&quot;</span>
        <span class="p">}</span>

    <span class="c1"># Update loads table and download/archive backstop files from OCCweb</span>
    <span class="n">loads</span> <span class="o">=</span> <span class="n">update_loads</span><span class="p">(</span><span class="n">scenario</span><span class="p">,</span> <span class="n">cmd_events</span><span class="o">=</span><span class="n">cmd_events</span><span class="p">,</span> <span class="n">lookback</span><span class="o">=</span><span class="n">lookback</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Including loads </span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">loads</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">load</span> <span class="ow">in</span> <span class="n">loads</span><span class="p">:</span>
        <span class="n">load_name</span> <span class="o">=</span> <span class="n">load</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="n">loads_backstop_path</span> <span class="o">=</span> <span class="n">paths</span><span class="o">.</span><span class="n">LOADS_BACKSTOP_PATH</span><span class="p">(</span><span class="n">load_name</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">loads_backstop_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">cmds</span><span class="p">:</span> <span class="n">CommandTable</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>

        <span class="c1"># Filter commands if loads (vehicle and/or observing) were approved but</span>
        <span class="c1"># never uplinked</span>
        <span class="k">if</span> <span class="n">load_name</span> <span class="ow">in</span> <span class="n">not_run_loads</span><span class="p">[</span><span class="s2">&quot;Load&quot;</span><span class="p">]:</span>
            <span class="c1"># Keep only the orbit points</span>
            <span class="n">cmds</span> <span class="o">=</span> <span class="n">cmds</span><span class="p">[</span><span class="n">cmds</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ORBPOINT&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">load_name</span> <span class="ow">in</span> <span class="n">not_run_loads</span><span class="p">[</span><span class="s2">&quot;Observing&quot;</span><span class="p">]:</span>
            <span class="c1"># Cut observing commands</span>
            <span class="n">bad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">cmds</span><span class="p">[</span><span class="s2">&quot;scs&quot;</span><span class="p">],</span> <span class="p">[</span><span class="mi">131</span><span class="p">,</span> <span class="mi">132</span><span class="p">,</span> <span class="mi">133</span><span class="p">])</span>
            <span class="n">cmds</span> <span class="o">=</span> <span class="n">cmds</span><span class="p">[</span><span class="o">~</span><span class="n">bad</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">load_name</span> <span class="ow">in</span> <span class="n">not_run_loads</span><span class="p">[</span><span class="s2">&quot;HRC&quot;</span><span class="p">]:</span>
            <span class="c1"># Cut HRC state-changing commands</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">not_run_loads</span><span class="p">[</span><span class="s2">&quot;HRC&quot;</span><span class="p">][</span><span class="n">load_name</span><span class="p">]</span>
            <span class="n">bad</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">cmds</span><span class="p">[</span><span class="s2">&quot;tlmsid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;224PCAON&quot;</span><span class="p">)</span>
                <span class="o">|</span> <span class="p">((</span><span class="n">cmds</span><span class="p">[</span><span class="s2">&quot;tlmsid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;COACTSX&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cmds</span><span class="p">[</span><span class="s2">&quot;coacts1&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">134</span><span class="p">))</span>
                <span class="o">|</span> <span class="p">((</span><span class="n">cmds</span><span class="p">[</span><span class="s2">&quot;tlmsid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;COENASX&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cmds</span><span class="p">[</span><span class="s2">&quot;coenas1&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">89</span><span class="p">))</span>
                <span class="o">|</span> <span class="p">((</span><span class="n">cmds</span><span class="p">[</span><span class="s2">&quot;tlmsid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;COENASX&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cmds</span><span class="p">[</span><span class="s2">&quot;coenas1&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">90</span><span class="p">))</span>
            <span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cmds</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">date</span><span class="p">)</span>
            <span class="n">cmds</span> <span class="o">=</span> <span class="n">cmds</span><span class="p">[</span><span class="o">~</span><span class="n">bad</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">rltt</span> <span class="o">=</span> <span class="n">cmds</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;rltt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmds</span><span class="o">.</span><span class="n">get_rltt</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">rltt</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">load_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">not_run_loads</span><span class="p">[</span><span class="s2">&quot;Load&quot;</span><span class="p">]:</span>
                <span class="c1"># This is unexpected but press ahead anyway</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No RLTT for </span><span class="si">{</span><span class="n">load_name</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Load </span><span class="si">{</span><span class="n">load_name</span><span class="si">}</span><span class="s2"> has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cmds</span><span class="p">)</span><span class="si">}</span><span class="s2"> commands with RLTT=</span><span class="si">{</span><span class="n">rltt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">cmds_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmds</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Load </span><span class="si">{</span><span class="n">load_name</span><span class="si">}</span><span class="s2"> has no commands, skipping&quot;</span><span class="p">)</span>

    <span class="c1"># Filter events outside the time interval, assuming command event cannot</span>
    <span class="c1"># last more than 2 weeks.</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">CxoTime</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">loads</span><span class="p">[</span><span class="s2">&quot;cmd_start&quot;</span><span class="p">]))</span>
    <span class="n">stop</span> <span class="o">=</span> <span class="n">CxoTime</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">loads</span><span class="p">[</span><span class="s2">&quot;cmd_stop&quot;</span><span class="p">]))</span>
    <span class="c1"># Allow for variations in input format of date</span>
    <span class="n">dates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">CxoTime</span><span class="p">(</span><span class="n">date</span><span class="p">)</span><span class="o">.</span><span class="n">date</span> <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">cmd_events</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">bad</span> <span class="o">=</span> <span class="p">(</span><span class="n">dates</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">start</span> <span class="o">-</span> <span class="mi">14</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">day</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dates</span> <span class="o">&gt;</span> <span class="n">stop</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
    <span class="n">cmd_events</span> <span class="o">=</span> <span class="n">cmd_events</span><span class="p">[</span><span class="o">~</span><span class="n">bad</span><span class="p">]</span>
    <span class="n">cmd_events_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">evt</span><span class="p">[</span><span class="s2">&quot;Event&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; at &quot;</span> <span class="o">+</span> <span class="n">evt</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">evt</span> <span class="ow">in</span> <span class="n">cmd_events</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd_events</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Including cmd_events:</span><span class="se">\n</span><span class="s2">  </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd_events_ids</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No cmd_events to include&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">cmd_event</span> <span class="ow">in</span> <span class="n">cmd_events</span><span class="p">:</span>
        <span class="n">cmds</span> <span class="o">=</span> <span class="n">get_cmds_from_event</span><span class="p">(</span>
            <span class="n">cmd_event</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">],</span> <span class="n">cmd_event</span><span class="p">[</span><span class="s2">&quot;Event&quot;</span><span class="p">],</span> <span class="n">cmd_event</span><span class="p">[</span><span class="s2">&quot;Params&quot;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Events that do not generate commands return None from</span>
        <span class="c1"># get_cmds_from_event.</span>
        <span class="k">if</span> <span class="n">cmds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cmds_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmds</span><span class="p">)</span>

    <span class="c1"># Sort cmds_list and rltts by the date of the first cmd in each cmds Table</span>
    <span class="n">cmds_starts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cmds</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">cmds</span> <span class="ow">in</span> <span class="n">cmds_list</span><span class="p">])</span>
    <span class="n">idx_sort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">cmds_starts</span><span class="p">)</span>
    <span class="n">cmds_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmds_list</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">idx_sort</span><span class="p">]</span>

    <span class="c1"># Apply RLTT and any END SCS commands (CODISAXS) to loads. RLTT is applied</span>
    <span class="c1"># by stopping SCS&#39;s 128-133.</span>
    <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">cmds</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cmds_list</span><span class="p">):</span>
        <span class="n">cmds_source</span> <span class="o">=</span> <span class="n">cmds</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">cmds_source</span> <span class="o">==</span> <span class="s2">&quot;CMD_EVT&quot;</span><span class="p">:</span>
            <span class="n">cmds_source</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;CMD_EVT </span><span class="si">{</span><span class="n">cmds</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;event&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">cmds</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">cmds_source</span><span class="si">}</span><span class="s2"> with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cmds</span><span class="p">)</span><span class="si">}</span><span class="s2"> commands&quot;</span><span class="p">)</span>
        <span class="n">end_scs</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">date_end</span> <span class="o">:=</span> <span class="n">cmds</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rltt&quot;</span><span class="p">):</span>
            <span class="n">source</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;RLTT in </span><span class="si">{</span><span class="n">cmds</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">end_scs</span><span class="p">[</span><span class="n">date_end</span><span class="p">,</span> <span class="n">source</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mi">128</span><span class="p">,</span> <span class="mi">129</span><span class="p">,</span> <span class="mi">130</span><span class="p">,</span> <span class="mi">131</span><span class="p">,</span> <span class="mi">132</span><span class="p">,</span> <span class="mi">133</span><span class="p">])</span>

        <span class="c1"># Explicit END SCS commands. Most commonly these come from command events</span>
        <span class="c1"># like SCS-107, but can also be in weekly loads e.g. disabling an ACIS</span>
        <span class="c1"># ECS measurement in SCS-135.</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">cmds</span><span class="p">[</span><span class="s2">&quot;tlmsid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;CODISASX&quot;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">ok</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">cmds</span><span class="p">[</span><span class="n">ok</span><span class="p">]:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">scs</span> <span class="o">:=</span> <span class="n">cmd</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">][</span><span class="s2">&quot;codisas1&quot;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">128</span><span class="p">:</span>
                    <span class="n">source</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;DISABLE SCS in </span><span class="si">{</span><span class="n">cmd</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> at </span><span class="si">{</span><span class="n">cmd</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="n">end_scs</span><span class="p">[</span><span class="n">cmd</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">],</span> <span class="n">source</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scs</span><span class="p">)</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">date_end</span><span class="p">,</span> <span class="n">source</span><span class="p">),</span> <span class="n">scss</span> <span class="ow">in</span> <span class="n">end_scs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Apply end SCS from these commands to the current running loads.</span>
            <span class="c1"># Remove commands with date greater than end SCS date. In most</span>
            <span class="c1"># cases this does not cut anything.</span>
            <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ii</span><span class="p">):</span>
                <span class="n">prev_cmds</span> <span class="o">=</span> <span class="n">cmds_list</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span>
                <span class="c1"># First check for any overlap since prev_cmds is sorted by date.</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prev_cmds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">prev_cmds</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">date_end</span><span class="p">:</span>
                    <span class="n">bad</span> <span class="o">=</span> <span class="p">(</span><span class="n">prev_cmds</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">date_end</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span>
                        <span class="n">prev_cmds</span><span class="p">[</span><span class="s2">&quot;scs&quot;</span><span class="p">],</span> <span class="n">scss</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">bad</span><span class="p">):</span>
                        <span class="n">n_bad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">bad</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Removing </span><span class="si">{</span><span class="n">n_bad</span><span class="si">}</span><span class="s2"> cmds in SCS slots </span><span class="si">{</span><span class="n">scss</span><span class="si">}</span><span class="s2"> from &quot;</span>
                            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prev_cmds</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> due to </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="p">)</span>
                    <span class="n">cmds_list</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">=</span> <span class="n">prev_cmds</span><span class="p">[</span><span class="o">~</span><span class="n">bad</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cmds</span><span class="p">)</span><span class="si">}</span><span class="s2"> commands from </span><span class="si">{</span><span class="n">cmds_source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">cmds_recent</span><span class="p">:</span> <span class="n">CommandTable</span> <span class="o">=</span> <span class="n">vstack_exact</span><span class="p">(</span><span class="n">cmds_list</span><span class="p">)</span>
    <span class="n">cmds_recent</span><span class="o">.</span><span class="n">sort_in_backstop_order</span><span class="p">()</span>
    <span class="n">cmds_recent</span><span class="o">.</span><span class="n">deduplicate_orbit_cmds</span><span class="p">()</span>
    <span class="n">cmds_recent</span><span class="o">.</span><span class="n">remove_not_run_cmds</span><span class="p">()</span>
    <span class="n">cmds_recent</span> <span class="o">=</span> <span class="n">add_obs_cmds</span><span class="p">(</span><span class="n">cmds_recent</span><span class="p">,</span> <span class="n">pars_dict</span><span class="p">,</span> <span class="n">rev_pars_dict</span><span class="p">)</span>
    <span class="n">cmds_recent</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s2">&quot;loads_start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start</span><span class="o">.</span><span class="n">date</span>

    <span class="k">if</span> <span class="n">cache</span><span class="p">:</span>
        <span class="c1"># Cache recent commands so future requests for the same scenario are fast</span>
        <span class="n">CMDS_RECENT</span><span class="p">[</span><span class="n">scenario</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmds_recent</span>

    <span class="k">return</span> <span class="n">cmds_recent</span>


<span class="k">def</span> <span class="nf">add_obs_cmds</span><span class="p">(</span>
    <span class="n">cmds</span><span class="p">:</span> <span class="n">CommandTable</span><span class="p">,</span>
    <span class="n">pars_dict</span><span class="p">,</span>
    <span class="n">rev_pars_dict</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">prev_att</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">prev_obsid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">prev_simpos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add &#39;type=LOAD_EVENT tlmsid=OBS&#39; commands with info about observations.</span>

<span class="sd">    These &quot;OBS&quot; commands include the following params:</span>
<span class="sd">    - manvr_start: date of maneuver start</span>
<span class="sd">    - npnt_enab: auto-transition to NPNT enabled</span>
<span class="sd">    - obs_start: start date of NPNT corresponding to the command date</span>
<span class="sd">    - obs_stop: stop date of NPNT (subsequent AONMMODE or AONSMSAF command)</span>
<span class="sd">    - obsid: observation ID</span>
<span class="sd">    - prev_att: previous attitude (4-tuple of quaternion components)</span>
<span class="sd">    - simpos: SIM position</span>
<span class="sd">    - source: source of the observation (e.g. load name)</span>
<span class="sd">    - starcat_date: date of starcat command (if available)</span>
<span class="sd">    - starcat_idx: index of starcat in reversed params dict (if available)</span>
<span class="sd">    - targ_att: target attitude (4-tuple of quaternion components)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cmds_recent</span>
<span class="sd">        CommandTable</span>
<span class="sd">    pars_dict : dict</span>
<span class="sd">        Dictionary of parameters from the command table.</span>
<span class="sd">    rev_pars_dict : dict</span>
<span class="sd">        Dictionary of parameters from the command table, with keys reversed.</span>
<span class="sd">    prev_att : tuple</span>
<span class="sd">        Continuity attitude. If not supplied the first obs is dropped.</span>
<span class="sd">    prev_obsid : int, optional</span>
<span class="sd">        Previous obsid, default is -1.</span>
<span class="sd">    prev_simpos : int, optional</span>
<span class="sd">        Previous SIM position, default is -99616.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    CommandTable</span>
<span class="sd">        Command table with added OBS commands</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Last command in cmds is the schedule stop time (i.e. obs_stop for the</span>
    <span class="c1"># last observation).</span>
    <span class="n">schedule_stop_time</span> <span class="o">=</span> <span class="n">cmds</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Get the subset of commands needed to determine the state for OBS cmds like</span>
    <span class="c1"># maneuver commanding, obsid, starcat, etc.</span>
    <span class="n">cmds_state</span> <span class="o">=</span> <span class="n">get_state_cmds</span><span class="p">(</span><span class="n">cmds</span><span class="p">)</span>

    <span class="c1"># Get a table of OBS cmds corresponding to the end of each maneuver. For the</span>
    <span class="c1"># first pass this only has maneuver info that is known at the point of</span>
    <span class="c1"># starting the maneuver.</span>
    <span class="n">cmds_obs</span> <span class="o">=</span> <span class="n">get_cmds_obs_from_manvrs</span><span class="p">(</span><span class="n">cmds_state</span><span class="p">,</span> <span class="n">prev_att</span><span class="p">)</span>

    <span class="c1"># Put the OBS cmds into the state cmds table and then do the second pass to</span>
    <span class="c1"># determine obsid, starcat, etc at the end of the maneuver (i.e. at the</span>
    <span class="c1"># start of the obs). This returns just the obs commands and updates</span>
    <span class="c1"># `pars_dict` and `rev_pars_dict` in place.</span>
    <span class="n">cmds_state_obs</span> <span class="o">=</span> <span class="n">cmds_state</span><span class="o">.</span><span class="n">add_cmds</span><span class="p">(</span><span class="n">cmds_obs</span><span class="p">)</span>
    <span class="n">cmds_obs</span> <span class="o">=</span> <span class="n">get_cmds_obs_final</span><span class="p">(</span>
        <span class="n">cmds_state_obs</span><span class="p">,</span>
        <span class="n">pars_dict</span><span class="p">,</span>
        <span class="n">rev_pars_dict</span><span class="p">,</span>
        <span class="n">schedule_stop_time</span><span class="p">,</span>
        <span class="n">prev_obsid</span><span class="o">=</span><span class="n">prev_obsid</span><span class="p">,</span>
        <span class="n">prev_simpos</span><span class="o">=</span><span class="n">prev_simpos</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Finally add the OBS cmds to the recent cmds table.</span>
    <span class="n">cmds_out</span> <span class="o">=</span> <span class="n">cmds</span><span class="o">.</span><span class="n">add_cmds</span><span class="p">(</span><span class="n">cmds_obs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cmds_out</span>


<span class="k">def</span> <span class="nf">get_state_cmds</span><span class="p">(</span><span class="n">cmds</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the state-changing commands need to create LOAD_EVENT OBS commands.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cmds</span>
<span class="sd">        CommandTable of input commands.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    CommandTable of state-changing commands.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">state_tlmsids</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;AOSTRCAT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;COAOSQID&quot;</span><span class="p">,</span>
        <span class="s2">&quot;AOMANUVR&quot;</span><span class="p">,</span>
        <span class="s2">&quot;AONMMODE&quot;</span><span class="p">,</span>
        <span class="s2">&quot;AONSMSAF&quot;</span><span class="p">,</span>
        <span class="s2">&quot;AOUPTARQ&quot;</span><span class="p">,</span>
        <span class="s2">&quot;AONM2NPE&quot;</span><span class="p">,</span>
        <span class="s2">&quot;AONM2NPD&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="n">cmds</span><span class="p">[</span><span class="s2">&quot;tlmsid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;S&quot;</span><span class="p">:</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">state_tlmsids</span><span class="p">]</span>
    <span class="n">ok</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">cmds</span><span class="p">[</span><span class="s2">&quot;tlmsid&quot;</span><span class="p">],</span> <span class="n">vals</span><span class="p">)</span>
    <span class="n">ok</span> <span class="o">|=</span> <span class="n">cmds</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;SIMTRANS&quot;</span>
    <span class="n">cmds</span> <span class="o">=</span> <span class="n">cmds</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span>
    <span class="n">cmds</span><span class="o">.</span><span class="n">sort</span><span class="p">([</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;scs&quot;</span><span class="p">,</span> <span class="s2">&quot;tlmsid&quot;</span><span class="p">])</span>

    <span class="c1"># Note about sorting by &#39;tlmsid&#39;: this relates to an issue where the obsid</span>
    <span class="c1"># command COAOSQID is at exactly the same time as the AONMMODE commands</span>
    <span class="c1"># instead of just after it (e.g. in a null maneuver). In this case we need</span>
    <span class="c1"># to ensure that the AONMMODE commands are before the COAOSQID command in</span>
    <span class="c1"># the table order. The order of other commands is not important, so we rely</span>
    <span class="c1"># on the lucky fact that AONMMODE is alphabetically before COAOSQID to just</span>
    <span class="c1"># include `tlmsid`` in the lexical sort.</span>
    <span class="c1">#</span>
    <span class="c1">#  idx            date             type     tlmsid</span>
    <span class="c1"># ------ --------------------- ----------- --------</span>
    <span class="c1">#      6 2005:177:09:14:38.119  COMMAND_SW AOMANUVR</span>
    <span class="c1">#  10620 2005:177:09:17:27.868    MP_OBSID COAOSQID</span>
    <span class="c1">#  10621 2005:177:10:04:15.740    MP_OBSID COAOSQID</span>
    <span class="c1">#      1 2005:177:10:04:15.740  COMMAND_SW AONMMODE</span>
    <span class="c1">#      2 2005:177:10:04:15.997  COMMAND_SW AONM2NPE</span>

    <span class="k">return</span> <span class="n">cmds</span>


<span class="k">def</span> <span class="nf">get_cmds_obs_from_manvrs</span><span class="p">(</span><span class="n">cmds</span><span class="p">,</span> <span class="n">prev_att</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get OBS commands corresponding to the end of each maneuver.</span>

<span class="sd">    This is the first pass of getting OBS commands, keying off each maneuver.</span>
<span class="sd">    These OBS commands are then re-inserted into the commands table at the point</span>
<span class="sd">    of the maneuver END for the second pass, where at the point in time of the</span>
<span class="sd">    maneuver end (obs start), all the state-changing commands have occurred.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cmds : CommandTable</span>
<span class="sd">        CommandTable of state-changing commands.</span>
<span class="sd">    prev_att : tuple</span>
<span class="sd">        Previous attitude (q1, q2, q3, q4)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    CommandTable</span>
<span class="sd">        OBS commands.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">targ_att</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">npnt_enab</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">cmds_obs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">times</span> <span class="o">=</span> <span class="n">CxoTime</span><span class="p">(</span><span class="n">cmds</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">secs</span>

    <span class="k">for</span> <span class="n">time</span><span class="p">,</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">cmds</span><span class="p">):</span>
        <span class="n">tlmsid</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="s2">&quot;tlmsid&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">tlmsid</span> <span class="o">==</span> <span class="s2">&quot;AOUPTARQ&quot;</span><span class="p">:</span>
            <span class="n">pars</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">]</span>
            <span class="n">targ_att</span> <span class="o">=</span> <span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="s2">&quot;q1&quot;</span><span class="p">],</span> <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;q2&quot;</span><span class="p">],</span> <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;q3&quot;</span><span class="p">],</span> <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;q4&quot;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">tlmsid</span> <span class="o">==</span> <span class="s2">&quot;AONM2NPE&quot;</span><span class="p">:</span>
            <span class="n">npnt_enab</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">tlmsid</span> <span class="o">==</span> <span class="s2">&quot;AONM2NPD&quot;</span><span class="p">:</span>
            <span class="n">npnt_enab</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">tlmsid</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;AOMANUVR&quot;</span><span class="p">,</span> <span class="s2">&quot;AONSMSAF&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">tlmsid</span> <span class="o">==</span> <span class="s2">&quot;AONSMSAF&quot;</span><span class="p">:</span>
                <span class="n">targ_att</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                    <span class="n">NSM_attitude</span><span class="p">(</span><span class="n">prev_att</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">cmd</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="p">)</span>
                <span class="n">npnt_enab</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">targ_att</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># No target attitude is unexpected since we got to a MANVR cmd.</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;WARNING: no target attitude for </span><span class="si">{</span><span class="n">cmd</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">log_context_obs</span><span class="p">(</span><span class="n">cmds</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">prev_att</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># No previous attitude happens always for first manvr at the</span>
                <span class="c1"># beginning of loads, and normally we just push on to the next</span>
                <span class="c1"># OBS. But if we already have OBS command this is a problem.</span>
                <span class="k">if</span> <span class="n">cmds_obs</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;WARNING: No previous attitude for </span><span class="si">{</span><span class="n">cmd</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">log_context_obs</span><span class="p">(</span><span class="n">cmds</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
                <span class="n">prev_att</span> <span class="o">=</span> <span class="n">targ_att</span>
                <span class="k">continue</span>
            <span class="n">dur</span> <span class="o">=</span> <span class="n">manvr_duration</span><span class="p">(</span><span class="n">prev_att</span><span class="p">,</span> <span class="n">targ_att</span><span class="p">)</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;manvr_start&quot;</span><span class="p">:</span> <span class="n">cmd</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">],</span>
                <span class="s2">&quot;prev_att&quot;</span><span class="p">:</span> <span class="n">prev_att</span><span class="p">,</span>
                <span class="s2">&quot;targ_att&quot;</span><span class="p">:</span> <span class="n">targ_att</span><span class="p">,</span>
                <span class="s2">&quot;npnt_enab&quot;</span><span class="p">:</span> <span class="n">npnt_enab</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">cmd_obs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;idx&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;LOAD_EVENT&quot;</span><span class="p">,</span>
                <span class="s2">&quot;tlmsid&quot;</span><span class="p">:</span> <span class="s2">&quot;OBS&quot;</span><span class="p">,</span>
                <span class="s2">&quot;scs&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">cmd</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">],</span>
                <span class="s2">&quot;vcdu&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">time</span> <span class="o">+</span> <span class="n">dur</span><span class="p">,</span>
                <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">params</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">cmds_obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmd_obs</span><span class="p">)</span>
            <span class="n">prev_att</span> <span class="o">=</span> <span class="n">targ_att</span>
            <span class="n">targ_att</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">cmds_obs</span> <span class="o">=</span> <span class="n">CommandTable</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="n">cmds_obs</span><span class="p">)</span>
    <span class="c1"># NB: much faster to do this vectorized than when defining cmd_obs above.</span>
    <span class="n">cmds_obs</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">CxoTime</span><span class="p">(</span><span class="n">cmds_obs</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># If an NSM occurs within a maneuver then remove that obs</span>
    <span class="n">nsms</span> <span class="o">=</span> <span class="n">cmds</span><span class="p">[</span><span class="s2">&quot;tlmsid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;AONSMSAF&quot;</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">nsms</span><span class="p">):</span>
        <span class="n">bad_idxs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">nsm_date</span> <span class="ow">in</span> <span class="n">cmds</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">][</span><span class="n">nsms</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cmds_obs</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">nsm_date</span> <span class="o">&gt;</span> <span class="n">cmd</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">][</span><span class="s2">&quot;manvr_start&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">nsm_date</span> <span class="o">&lt;=</span> <span class="n">cmd</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;NSM at </span><span class="si">{</span><span class="n">nsm_date</span><span class="si">}</span><span class="s2"> happened during maneuver preceding&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot; obs</span><span class="se">\n</span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="n">log_context_obs</span><span class="p">(</span><span class="n">cmds</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">)</span>
                    <span class="n">bad_idxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bad_idxs</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removing obss at </span><span class="si">{</span><span class="n">bad_idxs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">cmds_obs</span><span class="o">.</span><span class="n">remove_rows</span><span class="p">(</span><span class="n">bad_idxs</span><span class="p">)</span>

    <span class="c1"># This is known to happen for cmds in AUG0103A, JAN2204B, JUL2604D due to</span>
    <span class="c1"># non-load maneuvers that are not captured correctly. Run the v1-v2</span>
    <span class="c1"># migration script to see. The prev_att is wrong and the incorrect maneuver</span>
    <span class="c1"># timing results in overlaps. It should not happen for modern loads.</span>
    <span class="k">for</span> <span class="n">cmd0</span><span class="p">,</span> <span class="n">cmd1</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cmds_obs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">cmds_obs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
        <span class="k">if</span> <span class="n">cmd1</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">][</span><span class="s2">&quot;manvr_start&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">cmd0</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">cmd1</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING: fixing overlapping OBS cmds: </span><span class="se">\n</span><span class="si">{</span><span class="n">cmd0</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="si">{</span><span class="n">cmd1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">date0</span> <span class="o">=</span> <span class="n">CxoTime</span><span class="p">(</span><span class="n">cmd1</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">][</span><span class="s2">&quot;manvr_start&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">15</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span>
            <span class="n">cmd0</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date0</span><span class="o">.</span><span class="n">date</span>
            <span class="n">cmd0</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date0</span><span class="o">.</span><span class="n">secs</span>

    <span class="k">return</span> <span class="n">cmds_obs</span>


<span class="c1"># parameters from characteristics_Hardware for normal maneuvers</span>
<span class="n">MANVR_DELTA</span> <span class="o">=</span> <span class="mf">60.0</span>
<span class="n">MANVR_ALPHAMAX</span> <span class="o">=</span> <span class="mf">2.18166e-006</span>  <span class="c1"># AKA alpha</span>
<span class="n">MANVR_VMAX</span> <span class="o">=</span> <span class="mf">0.001309</span>  <span class="c1"># AKA omega</span>


<span class="k">def</span> <span class="nf">manvr_duration</span><span class="p">(</span><span class="n">q1</span><span class="p">,</span> <span class="n">q2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the duration of a maneuver from two quaternions</span>

<span class="sd">    This is basically the same as the function in chandra_maneuver but</span>
<span class="sd">    optimized to work on a single 4-vector quaterion.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    q1</span>
<span class="sd">        list of 4 quaternion elements</span>
<span class="sd">    q2</span>
<span class="sd">        list of 4 quaternion elements</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    duration of maneuver in seconds</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Compute 4th element of delta quaternion q_manvr = q2 / q1</span>
    <span class="n">q_manvr_3</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="o">-</span><span class="n">q2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">q1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">q2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">q1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">q2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">q1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">q2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="o">-</span><span class="n">q1</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

    <span class="c1"># 4th component is cos(theta/2)</span>
    <span class="k">if</span> <span class="n">q_manvr_3</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">q_manvr_3</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">phimax</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">acos</span><span class="p">(</span><span class="n">q_manvr_3</span><span class="p">)</span>

    <span class="n">epsmax</span> <span class="o">=</span> <span class="n">MANVR_VMAX</span> <span class="o">/</span> <span class="n">MANVR_ALPHAMAX</span> <span class="o">-</span> <span class="n">MANVR_DELTA</span>
    <span class="n">tau</span> <span class="o">=</span> <span class="n">phimax</span> <span class="o">/</span> <span class="n">MANVR_VMAX</span> <span class="o">-</span> <span class="n">epsmax</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">MANVR_DELTA</span>
    <span class="k">if</span> <span class="n">tau</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="n">epsmax</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">MANVR_DELTA</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">phimax</span> <span class="o">/</span> <span class="n">MANVR_ALPHAMAX</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="o">-</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">MANVR_DELTA</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">eps</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">eps</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">tm</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">MANVR_DELTA</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">eps</span> <span class="o">+</span> <span class="n">tau</span>
    <span class="k">return</span> <span class="n">tm</span>


<span class="k">def</span> <span class="nf">get_cmds_obs_final</span><span class="p">(</span>
    <span class="n">cmds</span><span class="p">,</span>
    <span class="n">pars_dict</span><span class="p">,</span>
    <span class="n">rev_pars_dict</span><span class="p">,</span>
    <span class="n">schedule_stop_time</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">prev_obsid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">prev_simpos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fill in the rest of params for each OBS command.</span>

<span class="sd">    Second pass of processing which implements a state machine to fill in the</span>
<span class="sd">    other parameters like obsid, starcat, simpos etc. for each OBS command.</span>

<span class="sd">    The observation state is completed by encountering the next transition to</span>
<span class="sd">    NMM or NSM.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cmds</span>
<span class="sd">        CommandTable of state-changing + OBS commands.</span>
<span class="sd">    pars_dict</span>
<span class="sd">        dict of parameters for commands</span>
<span class="sd">    rev_pars_dict</span>
<span class="sd">        reversed dict of parameters for commands</span>
<span class="sd">    schedule_stop_time</span>
<span class="sd">        date of last command</span>
<span class="sd">    prev_obsid : int, optional</span>
<span class="sd">        Previous obsid, default is -1.</span>
<span class="sd">    prev_simpos : int, optional</span>
<span class="sd">        Previous SIM position, default is -99616.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    CommandTable</span>
<span class="sd">        OBS commands with all parameters filled in.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Initialize state variables. Note that the first OBS command may end up</span>
    <span class="c1"># with bogus values for some of these, but this is OK because of the command</span>
    <span class="c1"># merging with the archive commands which are always correct. Nevertheless</span>
    <span class="c1"># use values that are not None to avoid errors. For `sim_pos`, if the SIM</span>
    <span class="c1"># has not been commanded in a long time then it will be at -99616.</span>
    <span class="n">obsid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">prev_obsid</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">prev_obsid</span>
    <span class="n">starcat_idx</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">starcat_date</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sim_pos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">99616</span> <span class="k">if</span> <span class="n">prev_simpos</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">prev_simpos</span>
    <span class="n">obs_params</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">cmd_obs_extras</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">cmds</span><span class="p">:</span>
        <span class="n">tlmsid</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="s2">&quot;tlmsid&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">tlmsid</span> <span class="o">==</span> <span class="s2">&quot;AOSTRCAT&quot;</span><span class="p">:</span>
            <span class="n">starcat_date</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">cmd</span><span class="p">[</span><span class="s2">&quot;idx&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="c1"># OBS command only stores the index of the starcat params, so at</span>
                <span class="c1"># this point we need to put those params into the pars_dict and</span>
                <span class="c1"># rev_pars_dict and get the index.</span>
                <span class="n">starcat_idx</span> <span class="o">=</span> <span class="n">get_par_idx_update_pars_dict</span><span class="p">(</span>
                    <span class="n">pars_dict</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">rev_pars_dict</span><span class="o">=</span><span class="n">rev_pars_dict</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">starcat_idx</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="s2">&quot;idx&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">tlmsid</span> <span class="o">==</span> <span class="s2">&quot;COAOSQID&quot;</span><span class="p">:</span>
            <span class="n">obsid</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">][</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
            <span class="c1"># Look for obsid change within obs, likely an undercover</span>
            <span class="c1"># (target=&quot;cold blank ECS&quot;). First stop the initial obs at the time</span>
            <span class="c1"># of the obsid command.</span>
            <span class="k">if</span> <span class="n">obs_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">obs_params</span><span class="p">[</span><span class="s2">&quot;obs_stop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span>
                <span class="c1"># Then start a new obs at the time of the next obsid command.</span>
                <span class="n">obs_params</span> <span class="o">=</span> <span class="n">obs_params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">obs_params</span><span class="p">[</span><span class="s2">&quot;obsid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obsid</span>
                <span class="n">obs_params</span><span class="p">[</span><span class="s2">&quot;obs_start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span>
                <span class="c1"># Collect these extra obs to a list to be added to cmds table later.</span>
                <span class="n">cmd_obs</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;idx&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="n">cmd</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;LOAD_EVENT&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;tlmsid&quot;</span><span class="p">:</span> <span class="s2">&quot;OBS&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;scs&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">CxoTime</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">secs</span><span class="p">,</span>
                    <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">cmd</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;vcdu&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">obs_params</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">cmd_obs_extras</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmd_obs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">tlmsid</span> <span class="o">==</span> <span class="s2">&quot;OBS&quot;</span><span class="p">:</span>
            <span class="n">obs_params</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">]</span>
            <span class="n">obs_params</span><span class="p">[</span><span class="s2">&quot;obsid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obsid</span>
            <span class="n">obs_params</span><span class="p">[</span><span class="s2">&quot;simpos&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim_pos</span>  <span class="c1"># matches states &#39;simpos&#39;</span>
            <span class="n">obs_params</span><span class="p">[</span><span class="s2">&quot;obs_start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">obs_params</span><span class="p">[</span><span class="s2">&quot;npnt_enab&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">starcat_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">starcat_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">obs_params</span><span class="p">[</span><span class="s2">&quot;starcat_idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">starcat_idx</span>
                    <span class="n">obs_params</span><span class="p">[</span><span class="s2">&quot;starcat_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">starcat_date</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;No starcat for obsid </span><span class="si">{</span><span class="n">obsid</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">cmd</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="s2">&quot;even though npnt_enab is True&quot;</span>
                    <span class="p">)</span>

        <span class="k">elif</span> <span class="n">tlmsid</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;AONMMODE&quot;</span><span class="p">,</span> <span class="s2">&quot;AONSMSAF&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="n">tlmsid</span> <span class="o">==</span> <span class="s2">&quot;AONM2NPE&quot;</span> <span class="ow">and</span> <span class="n">cmd</span><span class="p">[</span><span class="s2">&quot;vcdu&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
        <span class="p">):</span>
            <span class="c1"># Stop current obs at next maneuver. In some v1 commands (for</span>
            <span class="c1"># migration) there are cases of non-load maneuvers without an</span>
            <span class="c1"># AONMMODE command and only the AONM2NPE and AOMANUVR commands.</span>
            <span class="c1"># In those cases just use ANOM2NPE as a proxy. In v2 commands this</span>
            <span class="c1"># is OK since AONM2NPE always comes after the AONMMODE command and</span>
            <span class="c1"># obs_params will be None at that point.</span>
            <span class="k">if</span> <span class="n">obs_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">obs_params</span><span class="p">[</span><span class="s2">&quot;obs_stop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span>
            <span class="c1"># This closes out the observation. Reset the star catalog state</span>
            <span class="c1"># variables since a valid star catalog is always uniquely associated</span>
            <span class="c1"># with an pointing observation.</span>
            <span class="n">obs_params</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">starcat_idx</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">starcat_date</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">elif</span> <span class="n">cmd</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;SIMTRANS&quot;</span><span class="p">:</span>
            <span class="n">sim_pos</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">][</span><span class="s2">&quot;pos&quot;</span><span class="p">]</span>

    <span class="c1"># Filter down to just the observation commands</span>
    <span class="n">cmds_obs</span> <span class="o">=</span> <span class="n">cmds</span><span class="p">[</span><span class="n">cmds</span><span class="p">[</span><span class="s2">&quot;tlmsid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;OBS&quot;</span><span class="p">]</span>

    <span class="c1"># Potentially add extra obs commands (typically undercovers) to cmds table</span>
    <span class="k">if</span> <span class="n">cmd_obs_extras</span><span class="p">:</span>
        <span class="n">cmds_obs</span> <span class="o">=</span> <span class="n">cmds_obs</span><span class="o">.</span><span class="n">add_cmds</span><span class="p">(</span><span class="n">CommandTable</span><span class="p">(</span><span class="n">cmd_obs_extras</span><span class="p">))</span>

    <span class="c1"># The last OBS command will be missing obs_stop since there is no</span>
    <span class="c1"># subsequent maneuver. Fix that for the expected case but warn if an obs</span>
    <span class="c1"># before the end is missing obs_stop.</span>
    <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">cmds_obs</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;obs_stop&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">]:</span>
            <span class="n">cmd</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">][</span><span class="s2">&quot;obs_stop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">schedule_stop_time</span>
            <span class="k">if</span> <span class="n">cmd</span><span class="o">.</span><span class="n">index</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmds_obs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;OBS command missing obs_stop</span><span class="se">\n</span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">log_context_obs</span><span class="p">(</span><span class="n">cmds</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
        <span class="n">cmd</span><span class="p">[</span><span class="s2">&quot;idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_par_idx_update_pars_dict</span><span class="p">(</span>
            <span class="n">pars_dict</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">rev_pars_dict</span><span class="o">=</span><span class="n">rev_pars_dict</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">cmds_obs</span>


<span class="k">def</span> <span class="nf">log_context_obs</span><span class="p">(</span><span class="n">cmds</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">before</span><span class="o">=</span><span class="mi">3600</span><span class="p">,</span> <span class="n">after</span><span class="o">=</span><span class="mi">3600</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s2">&quot;warning&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Log commands before and after ``cmd``&quot;&quot;&quot;</span>
    <span class="n">date_before</span> <span class="o">=</span> <span class="p">(</span><span class="n">CxoTime</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="n">before</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">date</span>
    <span class="n">date_after</span> <span class="o">=</span> <span class="p">(</span><span class="n">CxoTime</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="n">after</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">date</span>
    <span class="n">ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmds</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">date_before</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cmds</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">date_after</span><span class="p">)</span>
    <span class="n">log_func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">log_level</span><span class="p">)</span>
    <span class="n">log_func</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">cmds</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">is_google_id</span><span class="p">(</span><span class="n">scenario</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return True if scenario appears to be a Google ID.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    scenario</span>
<span class="sd">        str, None</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Something better??</span>
    <span class="k">return</span> <span class="n">scenario</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">scenario</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">35</span>


<span class="k">def</span> <span class="nf">update_cmd_events</span><span class="p">(</span><span class="n">scenario</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Table</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update local cmd_events.csv from Google Sheets for ``scenario``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    scenario : str, None</span>
<span class="sd">        Scenario name</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Table</span>
<span class="sd">        Command events table</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Named scenarios with a name that isn&#39;t &quot;flight&quot; and does not look like a</span>
    <span class="c1"># google sheet ID are local files.</span>
    <span class="n">use_local</span> <span class="o">=</span> <span class="n">scenario</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;flight&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_google_id</span><span class="p">(</span><span class="n">scenario</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">use_local</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">HAS_INTERNET</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">get_cmd_events</span><span class="p">(</span><span class="n">scenario</span><span class="p">)</span>

    <span class="c1"># Ensure the scenario directory exists</span>
    <span class="n">paths</span><span class="o">.</span><span class="n">SCENARIO_DIR</span><span class="p">(</span><span class="n">scenario</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">cmd_events_path</span> <span class="o">=</span> <span class="n">paths</span><span class="o">.</span><span class="n">CMD_EVENTS_PATH</span><span class="p">(</span><span class="n">scenario</span><span class="p">)</span>

    <span class="n">doc_id</span> <span class="o">=</span> <span class="n">scenario</span> <span class="k">if</span> <span class="n">is_google_id</span><span class="p">(</span><span class="n">scenario</span><span class="p">)</span> <span class="k">else</span> <span class="n">conf</span><span class="o">.</span><span class="n">cmd_events_flight_id</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">CMD_EVENTS_SHEET_URL</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">doc_id</span><span class="o">=</span><span class="n">doc_id</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Getting cmd_events from </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to get cmd events sheet: </span><span class="si">{</span><span class="n">req</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">cmd_events</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;csv&quot;</span><span class="p">)</span>

    <span class="c1"># Filter table based on State column. In-work can be used to validate the new</span>
    <span class="c1"># event vs telemetry prior to make it operational.</span>
    <span class="n">allowed_states</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Predictive&quot;</span><span class="p">,</span> <span class="s2">&quot;Definitive&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">conf</span><span class="o">.</span><span class="n">include_in_work_command_events</span><span class="p">:</span>
        <span class="n">allowed_states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;In-work&quot;</span><span class="p">)</span>
    <span class="n">ok</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">cmd_events</span><span class="p">[</span><span class="s2">&quot;State&quot;</span><span class="p">],</span> <span class="n">allowed_states</span><span class="p">)</span>
    <span class="n">cmd_events</span> <span class="o">=</span> <span class="n">cmd_events</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span>

    <span class="c1"># If KADI_COMMANDS_DEFAULT_STOP is set, filter out events after that date.</span>
    <span class="n">cmd_events</span> <span class="o">=</span> <span class="n">filter_cmd_events_default_stop</span><span class="p">(</span><span class="n">cmd_events</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cmd_events</span><span class="p">)</span><span class="si">}</span><span class="s2"> cmd_events to </span><span class="si">{</span><span class="n">cmd_events_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">cmd_events</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cmd_events_path</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;csv&quot;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cmd_events</span>


<span class="k">def</span> <span class="nf">get_cmd_events</span><span class="p">(</span><span class="n">scenario</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get local cmd_events.csv for ``scenario``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    scenario : str, None</span>
<span class="sd">        Scenario name</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    out</span>
<span class="sd">        Table</span>
<span class="sd">        Command events table</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cmd_events_path</span> <span class="o">=</span> <span class="n">paths</span><span class="o">.</span><span class="n">CMD_EVENTS_PATH</span><span class="p">(</span><span class="n">scenario</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reading command events </span><span class="si">{</span><span class="n">cmd_events_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">cmd_events</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cmd_events_path</span><span class="p">),</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;csv&quot;</span><span class="p">,</span> <span class="n">fill_values</span><span class="o">=</span><span class="p">[])</span>

    <span class="c1"># If KADI_COMMANDS_DEFAULT_STOP is set, filter out events after that date.</span>
    <span class="n">cmd_events</span> <span class="o">=</span> <span class="n">filter_cmd_events_default_stop</span><span class="p">(</span><span class="n">cmd_events</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cmd_events</span>


<span class="k">def</span> <span class="nf">filter_cmd_events_default_stop</span><span class="p">(</span><span class="n">cmd_events</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">stop</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;KADI_COMMANDS_DEFAULT_STOP&quot;</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="n">CxoTime</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span>
        <span class="c1"># Filter table based on stop date. Need to use CxoTime on each event separately</span>
        <span class="c1"># because the date format could be inconsistent.</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="p">[</span><span class="n">CxoTime</span><span class="p">(</span><span class="n">cmd_event</span><span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;=</span> <span class="n">stop</span><span class="o">.</span><span class="n">date</span> <span class="k">for</span> <span class="n">cmd_event</span> <span class="ow">in</span> <span class="n">cmd_events</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Filtering cmd_events to stop date </span><span class="si">{</span><span class="n">stop</span><span class="o">.</span><span class="n">date</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">ok</span><span class="p">)</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cmd_events</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>
        <span class="n">cmd_events</span> <span class="o">=</span> <span class="n">cmd_events</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">cmd_events</span>


<span class="k">def</span> <span class="nf">update_loads</span><span class="p">(</span><span class="n">scenario</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">cmd_events</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lookback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Table</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update local copy of approved command loads though ``lookback`` days.&quot;&quot;&quot;</span>
    <span class="c1"># For testing allow override of default `stop` value</span>
    <span class="k">if</span> <span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;KADI_COMMANDS_DEFAULT_STOP&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">lookback</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lookback</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">default_lookback</span>

    <span class="c1"># Ensure the scenario directory exists</span>
    <span class="n">paths</span><span class="o">.</span><span class="n">SCENARIO_DIR</span><span class="p">(</span><span class="n">scenario</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cmd_events</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cmd_events</span> <span class="o">=</span> <span class="n">get_cmd_events</span><span class="p">(</span><span class="n">scenario</span><span class="p">)</span>

    <span class="c1"># TODO for performance when we have decent testing:</span>
    <span class="c1"># Read in the existing loads table and grab the RLTT and scheduled stop</span>
    <span class="c1"># dates. Those are the only reason we need to read an existing set of</span>
    <span class="c1"># commands that are already locally available, but they are fixed and cannot</span>
    <span class="c1"># change. The only thing that might change is an interrupt time, e.g. if</span>
    <span class="c1"># the SCS time gets updated.</span>
    <span class="c1"># So maybe read in the loads table and make a dict of rltts and ssts keyed</span>
    <span class="c1"># by load name and use those to avoid reading in the cmds table.</span>
    <span class="c1"># For now just get things working reliably.</span>

    <span class="n">loads_rows</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Probably too complicated, but this bit of code generates a list of dates</span>
    <span class="c1"># that are guaranteed to sample all the months in the lookback period with</span>
    <span class="c1"># two weeks of margin on the tail end.</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="mi">21</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">day</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">CxoTime</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span> <span class="o">-</span> <span class="n">lookback</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">day</span>
    <span class="k">if</span> <span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="n">CxoTime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">dt</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="n">CxoTime</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span>
    <span class="n">n_sample</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">stop</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">/</span> <span class="n">dt</span><span class="p">))</span>
    <span class="n">dates</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_sample</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">stop</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_sample</span>
    <span class="n">dirs_tried</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="c1"># Get the directory listing for each unique Year/Month and find loads.</span>
    <span class="c1"># For each load not already in the table, download the backstop and add the</span>
    <span class="c1"># load to the table.</span>
    <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">dates</span><span class="p">:</span>
        <span class="n">year</span><span class="p">,</span> <span class="n">month</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">ymdhms</span><span class="o">.</span><span class="n">year</span><span class="p">),</span> <span class="n">date</span><span class="o">.</span><span class="n">ymdhms</span><span class="o">.</span><span class="n">month</span>
        <span class="n">month_name</span> <span class="o">=</span> <span class="n">calendar</span><span class="o">.</span><span class="n">month_abbr</span><span class="p">[</span><span class="n">month</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

        <span class="n">dir_year_month</span> <span class="o">=</span> <span class="n">APPROVED_LOADS_OCCWEB_DIR</span> <span class="o">/</span> <span class="n">year</span> <span class="o">/</span> <span class="n">month_name</span>
        <span class="k">if</span> <span class="n">dir_year_month</span> <span class="ow">in</span> <span class="n">dirs_tried</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">dirs_tried</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dir_year_month</span><span class="p">)</span>

        <span class="c1"># Get directory listing for Year/Month</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="n">occweb</span><span class="o">.</span><span class="n">get_occweb_dir</span><span class="p">(</span><span class="n">dir_year_month</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;404&quot;</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No OCCweb directory for </span><span class="si">{</span><span class="n">dir_year_month</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>

        <span class="c1"># Find each valid load name in the directory listing and process:</span>
        <span class="c1"># - Find and download the backstop file</span>
        <span class="c1"># - Parse the backstop file and save to the loads/ archive as a gzipped</span>
        <span class="c1">#   pickle file</span>
        <span class="c1"># - Add the load to the table</span>
        <span class="k">for</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">contents</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[A-Z]</span><span class="si">{3}</span><span class="s2">\d</span><span class="si">{4}</span><span class="s2">[A-Z]/&quot;</span><span class="p">,</span> <span class="n">content</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]):</span>
                <span class="n">load_name</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">][:</span><span class="mi">8</span><span class="p">]</span>  <span class="c1"># chop the /</span>
                <span class="n">load_date</span> <span class="o">=</span> <span class="n">load_name_to_cxotime</span><span class="p">(</span><span class="n">load_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">load_date</span> <span class="o">&lt;</span> <span class="n">RLTT_ERA_START</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Skipping </span><span class="si">{</span><span class="n">load_name</span><span class="si">}</span><span class="s2"> which is before &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">RLTT_ERA_START</span><span class="si">}</span><span class="s2"> start of RLTT era&quot;</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">load_date</span> <span class="o">&gt;=</span> <span class="n">start</span> <span class="ow">and</span> <span class="n">load_date</span> <span class="o">&lt;=</span> <span class="n">stop</span><span class="p">:</span>
                    <span class="n">cmds</span> <span class="o">=</span> <span class="n">get_load_cmds_from_occweb_or_local</span><span class="p">(</span><span class="n">dir_year_month</span><span class="p">,</span> <span class="n">load_name</span><span class="p">)</span>
                    <span class="n">load</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">load_name</span><span class="p">,</span>
                        <span class="s2">&quot;cmd_start&quot;</span><span class="p">:</span> <span class="n">cmds</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                        <span class="s2">&quot;cmd_stop&quot;</span><span class="p">:</span> <span class="n">cmds</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                    <span class="p">}</span>
                    <span class="n">loads_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">load</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">loads_rows</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No loads found in </span><span class="si">{</span><span class="n">lookback</span><span class="si">}</span><span class="s2"> days&quot;</span><span class="p">)</span>

    <span class="c1"># Finally, save the table to file</span>
    <span class="n">loads_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">loads_rows</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">conf</span><span class="o">.</span><span class="n">clean_loads_dir</span><span class="p">:</span>
        <span class="n">clean_loads_dir</span><span class="p">(</span><span class="n">loads_table</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">loads_table</span>


<span class="k">def</span> <span class="nf">clean_loads_dir</span><span class="p">(</span><span class="n">loads</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove load-like files from loads directory if not in ``loads``&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">Path</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">LOADS_ARCHIVE_DIR</span><span class="p">())</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.pkl.gz&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[A-Z]</span><span class="si">{3}</span><span class="s2">\d</span><span class="si">{4}</span><span class="s2">[A-Z]\.pkl\.gz&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">loads</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removing load file </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">file</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">get_load_cmds_from_occweb_or_local</span><span class="p">(</span>
    <span class="n">dir_year_month</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">load_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">use_ska_dir</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CommandTable</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the load cmds (backstop) for ``load_name`` within ``dir_year_month``</span>

<span class="sd">    If the backstop file is already available locally, use that. Otherwise, the</span>
<span class="sd">    file is downloaded from OCCweb and is then parsed and saved as a gzipped</span>
<span class="sd">    pickle file of the corresponding CommandTable object.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dir_year_month : Path</span>
<span class="sd">        Path to the directory containing the ``load_name`` directory.</span>
<span class="sd">    load_name : str</span>
<span class="sd">        Load name in the usual format e.g. JAN0521A.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    CommandTable</span>
<span class="sd">        Backstop commands for the load.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Determine output file name and make directory if necessary.</span>
    <span class="n">loads_dir</span> <span class="o">=</span> <span class="n">paths</span><span class="o">.</span><span class="n">LOADS_ARCHIVE_DIR</span><span class="p">()</span>
    <span class="n">loads_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">cmds_filename</span> <span class="o">=</span> <span class="n">loads_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">load_name</span><span class="si">}</span><span class="s2">.pkl.gz&quot;</span>

    <span class="c1"># If the output file already exists, read the commands and return them.</span>
    <span class="k">if</span> <span class="n">cmds_filename</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Already have </span><span class="si">{</span><span class="n">cmds_filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">cmds_filename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">cmds</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cmds</span>

    <span class="k">if</span> <span class="n">use_ska_dir</span><span class="p">:</span>
        <span class="n">ska_dir</span> <span class="o">=</span> <span class="n">load_dir_from_load_name</span><span class="p">(</span><span class="n">load_name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">ska_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;CR????????.backstop&quot;</span><span class="p">):</span>
            <span class="n">backstop_text</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Got backstop from </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">cmds</span> <span class="o">=</span> <span class="n">parse_backstop_and_write</span><span class="p">(</span><span class="n">load_name</span><span class="p">,</span> <span class="n">cmds_filename</span><span class="p">,</span> <span class="n">backstop_text</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No backstop file found in </span><span class="si">{</span><span class="n">ska_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>  <span class="c1"># use OCCweb</span>
        <span class="n">load_dir_contents</span> <span class="o">=</span> <span class="n">occweb</span><span class="o">.</span><span class="n">get_occweb_dir</span><span class="p">(</span><span class="n">dir_year_month</span> <span class="o">/</span> <span class="n">load_name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">load_dir_contents</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;CR\d</span><span class="si">{3}</span><span class="s2">.\d</span><span class="si">{4}</span><span class="s2">\.backstop&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
                <span class="c1"># Download the backstop file from OCCweb</span>
                <span class="n">backstop_text</span> <span class="o">=</span> <span class="n">occweb</span><span class="o">.</span><span class="n">get_occweb_page</span><span class="p">(</span>
                    <span class="n">dir_year_month</span> <span class="o">/</span> <span class="n">load_name</span> <span class="o">/</span> <span class="n">filename</span><span class="p">,</span>
                    <span class="n">cache</span><span class="o">=</span><span class="n">conf</span><span class="o">.</span><span class="n">cache_loads_in_astropy_cache</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">cmds</span> <span class="o">=</span> <span class="n">parse_backstop_and_write</span><span class="p">(</span><span class="n">load_name</span><span class="p">,</span> <span class="n">cmds_filename</span><span class="p">,</span> <span class="n">backstop_text</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Could not find backstop file in </span><span class="si">{</span><span class="n">dir_year_month</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">load_name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">cmds</span>


<span class="k">def</span> <span class="nf">parse_backstop_and_write</span><span class="p">(</span><span class="n">load_name</span><span class="p">,</span> <span class="n">cmds_filename</span><span class="p">,</span> <span class="n">backstop_text</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse ``backstop_text`` and write to ``cmds_filename`` (gzipped pickle).</span>

<span class="sd">    This sets the ``source`` column to ``load_name`` and removes the</span>
<span class="sd">    ``timeline_id`` column.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">backstop_lines</span> <span class="o">=</span> <span class="n">backstop_text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
    <span class="n">cmds</span> <span class="o">=</span> <span class="n">get_cmds_from_backstop</span><span class="p">(</span><span class="n">backstop_lines</span><span class="p">)</span>

    <span class="c1"># Fix up the commands to be in the right format</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">cmds</span><span class="o">.</span><span class="n">colnames</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;timeline_id&quot;</span><span class="p">)</span>
    <span class="n">cmds</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">load_name</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;source&quot;</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">cmds</span><span class="p">[</span><span class="s2">&quot;timeline_id&quot;</span><span class="p">]</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving </span><span class="si">{</span><span class="n">cmds_filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">cmds_filename</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">cmds</span><span class="p">,</span> <span class="n">fh</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cmds</span>


<span class="k">def</span> <span class="nf">update_cmds_archive</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">lookback</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">log_level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
    <span class="n">scenario</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">data_root</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span>
    <span class="n">match_prev_cmds</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update cmds2.h5 and cmds2.pkl archive files.</span>

<span class="sd">    This updates the archive though ``stop`` date, where is required that the</span>
<span class="sd">    ``stop`` date is within ``lookback`` days of existing data in the archive.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lookback : int, None</span>
<span class="sd">        Number of days to look back to get recent load commands from OCCweb.</span>
<span class="sd">        Default is ``conf.default_lookback`` (currently 30).</span>
<span class="sd">    stop : CxoTime-like, None</span>
<span class="sd">        Stop date to update the archive to. Default is NOW + 21 days.</span>
<span class="sd">    log_level : int</span>
<span class="sd">        Logging level. Default is ``logging.INFO``.</span>
<span class="sd">    scenario : str, None</span>
<span class="sd">        Scenario name for loads and command events</span>
<span class="sd">    data_root : str, Path</span>
<span class="sd">        Root directory where cmds2.h5 and cmds2.pkl are stored. Default is &#39;.&#39;.</span>
<span class="sd">    match_prev_cmds : bool</span>
<span class="sd">        One-time use flag set to True to update the cmds archive near the v1/v2</span>
<span class="sd">        transition of APR1420B. See ``utils/migrate_cmds_to_cmds2.py`` for</span>
<span class="sd">        details.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># For testing allow override of default `stop` value</span>
    <span class="k">if</span> <span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;KADI_COMMANDS_DEFAULT_STOP&quot;</span><span class="p">)</span>

    <span class="c1"># Local context manager for log_level and data_root</span>
    <span class="n">kadi_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;kadi&quot;</span><span class="p">)</span>
    <span class="n">log_level_orig</span> <span class="o">=</span> <span class="n">kadi_logger</span><span class="o">.</span><span class="n">level</span>
    <span class="k">with</span> <span class="n">conf</span><span class="o">.</span><span class="n">set_temp</span><span class="p">(</span><span class="s2">&quot;commands_dir&quot;</span><span class="p">,</span> <span class="n">data_root</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">kadi_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">log_level</span><span class="p">)</span>
            <span class="n">_update_cmds_archive</span><span class="p">(</span><span class="n">lookback</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">match_prev_cmds</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">data_root</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">kadi_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">log_level_orig</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_update_cmds_archive</span><span class="p">(</span><span class="n">lookback</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">match_prev_cmds</span><span class="p">,</span> <span class="n">scenario</span><span class="p">,</span> <span class="n">data_root</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Do the real work of updating the cmds archive&quot;&quot;&quot;</span>
    <span class="n">idx_cmds_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">data_root</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;cmds2.h5&quot;</span>
    <span class="n">pars_dict_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">data_root</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;cmds2.pkl&quot;</span>

    <span class="k">if</span> <span class="n">idx_cmds_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">cmds_arch</span> <span class="o">=</span> <span class="n">load_idx_cmds</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">idx_cmds_path</span><span class="p">)</span>
        <span class="n">pars_dict</span> <span class="o">=</span> <span class="n">load_pars_dict</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">pars_dict_path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Make an empty cmds archive table and pars dict</span>
        <span class="n">cmds_arch</span> <span class="o">=</span> <span class="n">CommandTable</span><span class="p">(</span>
            <span class="n">names</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">CommandTable</span><span class="o">.</span><span class="n">COL_TYPES</span><span class="p">),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">CommandTable</span><span class="o">.</span><span class="n">COL_TYPES</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
        <span class="p">)</span>
        <span class="k">del</span> <span class="n">cmds_arch</span><span class="p">[</span><span class="s2">&quot;timeline_id&quot;</span><span class="p">]</span>
        <span class="n">pars_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">match_prev_cmds</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># No matching of previous commands</span>

    <span class="n">cmds_recent</span> <span class="o">=</span> <span class="n">update_archive_and_get_cmds_recent</span><span class="p">(</span>
        <span class="n">scenario</span><span class="o">=</span><span class="n">scenario</span><span class="p">,</span>
        <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span>
        <span class="n">lookback</span><span class="o">=</span><span class="n">lookback</span><span class="p">,</span>
        <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">pars_dict</span><span class="o">=</span><span class="n">pars_dict</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">match_prev_cmds</span><span class="p">:</span>
        <span class="n">idx0_arch</span><span class="p">,</span> <span class="n">idx0_recent</span> <span class="o">=</span> <span class="n">get_matching_block_idx</span><span class="p">(</span><span class="n">cmds_arch</span><span class="p">,</span> <span class="n">cmds_recent</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">idx0_arch</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmds_arch</span><span class="p">)</span>
        <span class="n">idx0_recent</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Convert from `params` col of dicts to index into same params in pars_dict.</span>
    <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">cmds_recent</span><span class="p">:</span>
        <span class="n">cmd</span><span class="p">[</span><span class="s2">&quot;idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_par_idx_update_pars_dict</span><span class="p">(</span><span class="n">pars_dict</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>

    <span class="c1"># If the length of the updated table will be the same as the existing table.</span>
    <span class="c1"># For the command below the no-op logic should be clear:</span>
    <span class="c1"># cmds_arch = vstack([cmds_arch[:idx0_arch], cmds_recent[idx0_recent:]])</span>
    <span class="k">if</span> <span class="n">idx0_arch</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmds_arch</span><span class="p">)</span> <span class="ow">and</span> <span class="n">idx0_recent</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmds_recent</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No new commands found, skipping writing </span><span class="si">{</span><span class="n">idx_cmds_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># Merge the recent commands with the existing archive.</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Appending </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cmds_recent</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">idx0_recent</span><span class="si">}</span><span class="s2"> new commands after &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;removing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cmds_arch</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">idx0_arch</span><span class="si">}</span><span class="s2"> from existing archive&quot;</span>
    <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot; starting with cmds_arch[:</span><span class="si">{</span><span class="n">idx0_arch</span><span class="si">}</span><span class="s2">] and adding &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;cmds_recent[</span><span class="si">{</span><span class="n">idx0_recent</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cmds_recent</span><span class="p">)</span><span class="si">}</span><span class="s2">]&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Remove params column before stacking and saving</span>
    <span class="k">del</span> <span class="n">cmds_recent</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">]</span>
    <span class="k">del</span> <span class="n">cmds_arch</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">]</span>

    <span class="c1"># Save the updated archive and pars_dict.</span>
    <span class="n">cmds_arch_new</span> <span class="o">=</span> <span class="n">vstack_exact</span><span class="p">([</span><span class="n">cmds_arch</span><span class="p">[:</span><span class="n">idx0_arch</span><span class="p">],</span> <span class="n">cmds_recent</span><span class="p">[</span><span class="n">idx0_recent</span><span class="p">:]])</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cmds_arch_new</span><span class="p">)</span><span class="si">}</span><span class="s2"> commands to </span><span class="si">{</span><span class="n">idx_cmds_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">cmds_arch_new</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">idx_cmds_path</span><span class="p">),</span> <span class="n">path</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;hdf5&quot;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writing updated pars_dict to </span><span class="si">{</span><span class="n">pars_dict_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">pars_dict</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">pars_dict_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">get_matching_block_idx</span><span class="p">(</span><span class="n">cmds_arch</span><span class="p">,</span> <span class="n">cmds_recent</span><span class="p">):</span>
    <span class="c1"># Find place in archive where the recent commands start.</span>
    <span class="n">idx_arch_recent</span> <span class="o">=</span> <span class="n">cmds_arch</span><span class="o">.</span><span class="n">find_date</span><span class="p">(</span><span class="n">cmds_recent</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Selecting commands from cmds_arch[</span><span class="si">{}</span><span class="s2">:]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx_arch_recent</span><span class="p">))</span>
    <span class="n">cmds_arch_recent</span> <span class="o">=</span> <span class="n">cmds_arch</span><span class="p">[</span><span class="n">idx_arch_recent</span><span class="p">:]</span>
    <span class="n">cmds_arch_recent</span><span class="o">.</span><span class="n">rev_pars_dict</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">REV_PARS_DICT</span><span class="p">)</span>

    <span class="n">arch_vals</span> <span class="o">=</span> <span class="n">get_list_for_matching</span><span class="p">(</span><span class="n">cmds_arch_recent</span><span class="p">)</span>
    <span class="n">recent_vals</span> <span class="o">=</span> <span class="n">get_list_for_matching</span><span class="p">(</span><span class="n">cmds_recent</span><span class="p">)</span>

    <span class="n">diff</span> <span class="o">=</span> <span class="n">difflib</span><span class="o">.</span><span class="n">SequenceMatcher</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">arch_vals</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">recent_vals</span><span class="p">,</span> <span class="n">autojunk</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">matching_blocks</span> <span class="o">=</span> <span class="n">diff</span><span class="o">.</span><span class="n">get_matching_blocks</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Matching blocks for (a) recent commands and (b) existing HDF5&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">matching_blocks</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">block</span><span class="p">))</span>
    <span class="n">opcodes</span> <span class="o">=</span> <span class="n">diff</span><span class="o">.</span><span class="n">get_opcodes</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Diffs between (a) recent commands and (b) existing HDF5&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">opcode</span> <span class="ow">in</span> <span class="n">opcodes</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">opcode</span><span class="p">))</span>
    <span class="c1"># Find the first matching block that is sufficiently long</span>
    <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">matching_blocks</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">block</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">MATCHING_BLOCK_SIZE</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;No matching blocks at least </span><span class="si">{</span><span class="n">MATCHING_BLOCK_SIZE</span><span class="si">}</span><span class="s2"> long. This most likely &quot;</span>
            <span class="s2">&quot;means that you have not recently synced your local Ska data using `ska_sync`.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Index into idx_cmds at the end of the large matching block.  block.b is the</span>
    <span class="c1"># beginning of the match.</span>
    <span class="n">idx0_recent</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">b</span> <span class="o">+</span> <span class="n">block</span><span class="o">.</span><span class="n">size</span>
    <span class="n">idx0_arch</span> <span class="o">=</span> <span class="n">idx_arch_recent</span> <span class="o">+</span> <span class="n">block</span><span class="o">.</span><span class="n">a</span> <span class="o">+</span> <span class="n">block</span><span class="o">.</span><span class="n">size</span>

    <span class="k">return</span> <span class="n">idx0_arch</span><span class="p">,</span> <span class="n">idx0_recent</span>


<span class="k">def</span> <span class="nf">get_list_for_matching</span><span class="p">(</span><span class="n">cmds</span><span class="p">:</span> <span class="n">CommandTable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]:</span>
    <span class="c1"># Define the column names that specify a complete and unique row</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;tlmsid&quot;</span><span class="p">,</span> <span class="s2">&quot;scs&quot;</span><span class="p">,</span> <span class="s2">&quot;step&quot;</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="s2">&quot;vcdu&quot;</span><span class="p">)</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">cmds</span><span class="p">:</span>
        <span class="n">row</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="n">cmd</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">bytes</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span>
        <span class="p">)</span>
        <span class="c1"># Special case for OBS command. The obs_stop param can change during anomaly</span>
        <span class="c1"># recovery when there is a CMD_EVT maneuver but no subsequent maneuver to define</span>
        <span class="c1"># obs_stop. In theory we could include these params in the match tuple for every</span>
        <span class="c1"># command in the matching, but it turns out that (for reasons I don&#39;t fully</span>
        <span class="c1"># understand) the AOSTRCAT yang and zang params are very slightly different at</span>
        <span class="c1"># floating point precision level, so the matches fail. Since all the other</span>
        <span class="c1"># commands are not mutable in this way we just apply this for OBS commands.</span>
        <span class="k">if</span> <span class="n">cmd</span><span class="p">[</span><span class="s2">&quot;tlmsid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;OBS&quot;</span><span class="p">:</span>
            <span class="n">row_params</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
                <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="n">row</span> <span class="o">+=</span> <span class="n">row_params</span>
        <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rows</span>


<span class="n">TYPE_MAP</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ACQ&quot;</span><span class="p">,</span> <span class="s2">&quot;GUI&quot;</span><span class="p">,</span> <span class="s2">&quot;BOT&quot;</span><span class="p">,</span> <span class="s2">&quot;FID&quot;</span><span class="p">,</span> <span class="s2">&quot;MON&quot;</span><span class="p">]</span>
<span class="n">IMGSZ_MAP</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;4x4&quot;</span><span class="p">,</span> <span class="s2">&quot;6x6&quot;</span><span class="p">,</span> <span class="s2">&quot;8x8&quot;</span><span class="p">]</span>
<span class="n">PAR_MAPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s2">&quot;imnum&quot;</span><span class="p">,</span> <span class="s2">&quot;slot&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="n">TYPE_MAP</span><span class="p">[</span><span class="n">n</span><span class="p">]),</span>
    <span class="p">(</span><span class="s2">&quot;imgsz&quot;</span><span class="p">,</span> <span class="s2">&quot;sz&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="n">IMGSZ_MAP</span><span class="p">[</span><span class="n">n</span><span class="p">]),</span>
    <span class="p">(</span><span class="s2">&quot;maxmag&quot;</span><span class="p">,</span> <span class="s2">&quot;maxmag&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;yang&quot;</span><span class="p">,</span> <span class="s2">&quot;yang&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;zang&quot;</span><span class="p">,</span> <span class="s2">&quot;zang&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;dimdts&quot;</span><span class="p">,</span> <span class="s2">&quot;dim&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;restrk&quot;</span><span class="p">,</span> <span class="s2">&quot;res&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
<span class="p">]</span>


<span class="k">def</span> <span class="nf">convert_aostrcat_to_acatable</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert dict of AOSTRCAT parameters to an ACATable.</span>

<span class="sd">    The dict looks like::</span>

<span class="sd">       2009:032:11:13:42.800 | 8023994 0 | MP_STARCAT | TLMSID= AOSTRCAT, CMDS=</span>
<span class="sd">       49, IMNUM1= 0, YANG1= -3.74826751e-03, ZANG1= -8.44541515e-03, MAXMAG1=</span>
<span class="sd">       8.00000000e+00, MINMAG1= 5.79687500e+00, DIMDTS1= 1, RESTRK1= 1, IMGSZ1=2,</span>
<span class="sd">       TYPE1= 3, ...</span>

<span class="sd">       IMNUM: slot</span>
<span class="sd">       RESTRK: box size resolution, always 1 (high) in loads for non-MON slot</span>
<span class="sd">       DIMDTS: (halfwidth - 20) / 5  # assumes AQRES=&#39;H&#39;</span>
<span class="sd">       TYPE: 4 =&gt; mon, 3 =&gt; fid, 2 =&gt; bot, 1 =&gt; gui, 0 =&gt; acq</span>
<span class="sd">       YANG: yang in radians</span>
<span class="sd">       ZANG: zang in radians</span>
<span class="sd">       IMGSZ: 0=4x4, 1=6x6, 2=8x8</span>
<span class="sd">       MINMAG = min mag</span>
<span class="sd">       MAXMAG = max mag</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    params</span>
<span class="sd">        dict of AOSTRCAT parameters</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ACATable</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">proseco.catalog</span> <span class="kn">import</span> <span class="n">ACATable</span>

    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">17</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;minmag</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">params</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;maxmag</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="n">max_idx</span> <span class="o">=</span> <span class="n">idx</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">par_name</span><span class="p">,</span> <span class="n">col_name</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">PAR_MAPS</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_idx</span><span class="p">):</span>
            <span class="n">cols</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">par_name</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">idx</span><span class="p">)]))</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">ACATable</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
    <span class="n">out</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_idx</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;idx&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/ska.png" alt="Logo"/>
            </a></p><h3>Page Contents</h3>


<form action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2013, Tom Aldcroft.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 7.2.6. &nbsp;
  </p>
</footer>
  </body>
</html>