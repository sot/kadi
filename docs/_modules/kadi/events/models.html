
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>kadi.events.models &#8212; kadi 7.8.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/bootstrap-astropy.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/plot_directive.css" />
    
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <script type="text/javascript" src="../../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../../_static/copybutton.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../../index.html"><span id="logotext1">Ska!</span><span id="logotext2">Kadi</span><span id="logotext3"></span></a>
  <ul>
    
    <li><a class="home" title="Homepage" href="https://sot.github.io/">
        <span id="logotext1">ska</span><span id="logotext2">tools</span>
    </a></li>
    <li><a title="General Index" href="../../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../../index.html">kadi 7.8.0 documentation</a>
	 &#187;
      </li>
      <li><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for kadi.events.models</h1><div class="highlight"><pre>
<span></span><span class="c1"># Licensed under a 3-clause BSD style license - see LICENSE.rst</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">count</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">cheta.fetch_eng</span> <span class="k">as</span> <span class="nn">fetch</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pyyaks.logger</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">table</span>
<span class="kn">from</span> <span class="nn">chandra_time</span> <span class="kn">import</span> <span class="n">DateTime</span>
<span class="kn">from</span> <span class="nn">cheta</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">Quaternion</span> <span class="kn">import</span> <span class="n">Quat</span>
<span class="kn">from</span> <span class="nn">ska_numpy</span> <span class="kn">import</span> <span class="n">interpolate</span>

<span class="kn">from</span> <span class="nn">.manvr_templates</span> <span class="kn">import</span> <span class="n">get_manvr_templates</span>

<span class="n">models</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">REPR_OUTPUT_SIZE</span> <span class="o">=</span> <span class="mi">1000</span>  <span class="c1"># Increase default number of rows printed</span>

<span class="n">ZERO_DT</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1e-4</span>
<span class="n">MAX_GAP</span> <span class="o">=</span> <span class="mf">328.1</span>  <span class="c1"># Max gap (seconds) in telemetry for state intervals</span>
<span class="n">R2A</span> <span class="o">=</span> <span class="mf">206264.8</span>  <span class="c1"># Convert from radians to arcsec</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">pyyaks</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;events&quot;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">pyyaks</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> </span><span class="si">%(message)s</span><span class="s2">&quot;</span>
<span class="p">)</span>


<div class="viewcode-block" id="msidset_interpolate"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.msidset_interpolate">[docs]</a><span class="k">def</span> <span class="nf">msidset_interpolate</span><span class="p">(</span><span class="n">msidset</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">time0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Interpolate the ``msidset`` in-place to a common time basis, starting at ``time0``</span>
<span class="sd">    and stepping by ``dt``.  This assumes an unfiltered MSIDset, and returns</span>
<span class="sd">    a filtered MSIDset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tstart</span> <span class="o">=</span> <span class="p">(</span><span class="n">time0</span> <span class="o">//</span> <span class="n">dt</span><span class="p">)</span> <span class="o">*</span> <span class="n">dt</span>
    <span class="n">times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">((</span><span class="n">msidset</span><span class="o">.</span><span class="n">tstop</span> <span class="o">-</span> <span class="n">tstart</span><span class="p">)</span> <span class="o">//</span> <span class="n">dt</span><span class="p">)</span> <span class="o">*</span> <span class="n">dt</span> <span class="o">+</span> <span class="n">tstart</span>
    <span class="n">msidset</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">times</span><span class="o">=</span><span class="n">times</span><span class="p">,</span> <span class="n">filter_bad</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">common_bads</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">msidset</span><span class="o">.</span><span class="n">times</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">msid</span> <span class="ow">in</span> <span class="n">msidset</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">common_bads</span> <span class="o">|=</span> <span class="n">msid</span><span class="o">.</span><span class="n">bads</span>

    <span class="c1"># Apply the common bads array and filter out these bad values</span>
    <span class="k">for</span> <span class="n">msid</span> <span class="ow">in</span> <span class="n">msidset</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">msid</span><span class="o">.</span><span class="n">bads</span> <span class="o">=</span> <span class="n">common_bads</span>
        <span class="n">msid</span><span class="o">.</span><span class="n">filter_bad</span><span class="p">()</span>
    <span class="n">msidset</span><span class="o">.</span><span class="n">times</span> <span class="o">=</span> <span class="n">msidset</span><span class="o">.</span><span class="n">times</span><span class="p">[</span><span class="o">~</span><span class="n">common_bads</span><span class="p">]</span></div>


<span class="k">def</span> <span class="nf">_get_si</span><span class="p">(</span><span class="n">simpos</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get SI corresponding to the given SIM position.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">simpos</span> <span class="o">&gt;=</span> <span class="mi">82109</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">simpos</span> <span class="o">&lt;=</span> <span class="mi">104839</span><span class="p">):</span>
        <span class="n">si</span> <span class="o">=</span> <span class="s2">&quot;ACIS-I&quot;</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">simpos</span> <span class="o">&gt;=</span> <span class="mi">70736</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">simpos</span> <span class="o">&lt;=</span> <span class="mi">82108</span><span class="p">):</span>
        <span class="n">si</span> <span class="o">=</span> <span class="s2">&quot;ACIS-S&quot;</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">simpos</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">86147</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">simpos</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">20000</span><span class="p">):</span>
        <span class="n">si</span> <span class="o">=</span> <span class="s2">&quot; HRC-I&quot;</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">simpos</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">104362</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">simpos</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">86148</span><span class="p">):</span>
        <span class="n">si</span> <span class="o">=</span> <span class="s2">&quot; HRC-S&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">si</span> <span class="o">=</span> <span class="s2">&quot;  NONE&quot;</span>
    <span class="k">return</span> <span class="n">si</span>


<span class="k">def</span> <span class="nf">_get_start_stop_vals</span><span class="p">(</span><span class="n">tstart</span><span class="p">,</span> <span class="n">tstop</span><span class="p">,</span> <span class="n">msidset</span><span class="p">,</span> <span class="n">msids</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the values of related telemetry MSIDs ``msids`` to the event as ``start_&lt;MSID&gt;``</span>
<span class="sd">    and ``stop_&lt;MSID&gt;``.  The value is taken from telemetry within `msidset` at ``tstart``</span>
<span class="sd">    and ``tstop``.  Returns a dict of &lt;MSID&gt;: &lt;VAL&gt; pairs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">rel_msids</span> <span class="o">=</span> <span class="p">[</span><span class="n">msidset</span><span class="p">[</span><span class="n">msid</span><span class="p">]</span> <span class="k">for</span> <span class="n">msid</span> <span class="ow">in</span> <span class="n">msids</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">rel_msid</span> <span class="ow">in</span> <span class="n">rel_msids</span><span class="p">:</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">interpolate</span><span class="p">(</span>
            <span class="n">rel_msid</span><span class="o">.</span><span class="n">vals</span><span class="p">,</span> <span class="n">rel_msid</span><span class="o">.</span><span class="n">times</span><span class="p">,</span> <span class="p">[</span><span class="n">tstart</span><span class="p">,</span> <span class="n">tstop</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span>
        <span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;start_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rel_msid</span><span class="o">.</span><span class="n">msid</span><span class="p">)]</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;stop_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rel_msid</span><span class="o">.</span><span class="n">msid</span><span class="p">)]</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span> <span class="nf">_get_msid_changes</span><span class="p">(</span><span class="n">msids</span><span class="p">,</span> <span class="n">sortmsids</span><span class="o">=</span><span class="p">{}):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For the list of fetch MSID objects, return a sorted structured array</span>
<span class="sd">    of each time any MSID value changes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">changes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">msid</span> <span class="ow">in</span> <span class="n">msids</span><span class="p">:</span>
        <span class="n">i_changes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">msid</span><span class="o">.</span><span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">!=</span> <span class="n">msid</span><span class="o">.</span><span class="n">vals</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">i_changes</span><span class="p">:</span>
            <span class="n">change</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">msid</span><span class="o">.</span><span class="n">msid</span><span class="p">,</span>
                <span class="n">sortmsids</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">msid</span><span class="o">.</span><span class="n">msid</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
                <span class="n">msid</span><span class="o">.</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">msid</span><span class="o">.</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">DateTime</span><span class="p">(</span><span class="n">msid</span><span class="o">.</span><span class="n">times</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                <span class="n">DateTime</span><span class="p">(</span><span class="n">msid</span><span class="o">.</span><span class="n">times</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                <span class="mf">0.0</span><span class="p">,</span>
                <span class="n">msid</span><span class="o">.</span><span class="n">times</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">msid</span><span class="o">.</span><span class="n">times</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">changes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">change</span><span class="p">)</span>
    <span class="n">changes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">fromrecords</span><span class="p">(</span>
        <span class="n">changes</span><span class="p">,</span>
        <span class="n">names</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;msid&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sortmsid&quot;</span><span class="p">,</span>
            <span class="s2">&quot;prev_val&quot;</span><span class="p">,</span>
            <span class="s2">&quot;val&quot;</span><span class="p">,</span>
            <span class="s2">&quot;prev_date&quot;</span><span class="p">,</span>
            <span class="s2">&quot;date&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dt&quot;</span><span class="p">,</span>
            <span class="s2">&quot;prev_time&quot;</span><span class="p">,</span>
            <span class="s2">&quot;time&quot;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">changes</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;sortmsid&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">changes</span>


<div class="viewcode-block" id="get_event_models"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.get_event_models">[docs]</a><span class="k">def</span> <span class="nf">get_event_models</span><span class="p">(</span><span class="n">baseclass</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get all Event models that represent actual events (and are not base</span>
<span class="sd">    or meta classes).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict of {model_name:ModelClass, ...}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">inspect</span>

    <span class="n">models</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">baseclass</span> <span class="ow">or</span> <span class="n">BaseEvent</span><span class="p">):</span>
            <span class="c1"># Make an instance of event class to discover if it is an abstact base class.</span>
            <span class="n">event</span> <span class="o">=</span> <span class="n">var</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">abstract</span><span class="p">:</span>
                <span class="n">models</span><span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">model_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">var</span>

    <span class="k">return</span> <span class="n">models</span></div>


<div class="viewcode-block" id="fuzz_states"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.fuzz_states">[docs]</a><span class="k">def</span> <span class="nf">fuzz_states</span><span class="p">(</span><span class="n">states</span><span class="p">,</span> <span class="n">t_fuzz</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For a set of `states` (from fetch.MSID.state_intervals()) or intervals (from</span>
<span class="sd">    fetch.MSID.logical_intervals), merge any that are within `t_fuzz` seconds of each</span>
<span class="sd">    other.  Logical intervals are just the subset of states with &#39;val&#39; equal to a</span>
<span class="sd">    particular value.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    states</span>
<span class="sd">        table of states or intervals</span>
<span class="sd">    t_fuzz : fuzz time in seconds</span>
<span class="sd">        :returns fuzzed_states: table</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">state_has_val</span> <span class="o">=</span> <span class="s2">&quot;val&quot;</span> <span class="ow">in</span> <span class="n">states</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">state0</span><span class="p">,</span> <span class="n">state1</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">count</span><span class="p">(),</span> <span class="n">states</span><span class="p">,</span> <span class="n">states</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
            <span class="c1"># Logical intervals all have a &#39;val&#39; of True by definition, while for state</span>
            <span class="c1"># intervals we need to check that adjacent intervals have same value.</span>
            <span class="n">state_equal</span> <span class="o">=</span> <span class="n">state0</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">state1</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">state_has_val</span> <span class="k">else</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">state1</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">state0</span><span class="p">[</span><span class="s2">&quot;tstop&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">t_fuzz</span> <span class="ow">and</span> <span class="n">state_equal</span><span class="p">:</span>
                <span class="c1"># Merge state1 into state0 and delete state1</span>
                <span class="n">state0</span><span class="p">[</span><span class="s2">&quot;tstop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state1</span><span class="p">[</span><span class="s2">&quot;tstop&quot;</span><span class="p">]</span>
                <span class="n">state0</span><span class="p">[</span><span class="s2">&quot;datestop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state1</span><span class="p">[</span><span class="s2">&quot;datestop&quot;</span><span class="p">]</span>
                <span class="n">state0</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state0</span><span class="p">[</span><span class="s2">&quot;tstop&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">state0</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span>
                <span class="n">states</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">states</span><span class="p">[:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">states</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">:]])</span>  <span class="c1"># noqa</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="n">states</span></div>


<div class="viewcode-block" id="Pad"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.Pad">[docs]</a><span class="k">class</span> <span class="nc">Pad</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Time padding at the start and stop of an interval.</span>

<span class="sd">    Positive values always make the interval *bigger* in each direction, so</span>
<span class="sd">    a pad of 300 seconds makes the interval a total of 10 minutes longer (5 minutes</span>
<span class="sd">    on each side).  A pad of -300 seconds makes the interval start 5 minutes</span>
<span class="sd">    later and end 5 minutes earlier.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">start</span> <span class="ow">or</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="n">stop</span> <span class="ow">or</span> <span class="mf">0.0</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;</span><span class="si">{}</span><span class="s2"> start=</span><span class="si">{}</span><span class="s2"> stop=</span><span class="si">{}</span><span class="s2"> seconds&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="IntervalPad"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.IntervalPad">[docs]</a><span class="k">class</span> <span class="nc">IntervalPad</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Data descriptor that sets and gets an interval pad.  This pad has</span>
<span class="sd">    two values that are applied to the start and stop times for an interval,</span>
<span class="sd">    respectively.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">owner</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s2">&quot;_pad&quot;</span><span class="p">):</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">_pad</span> <span class="o">=</span> <span class="n">Pad</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">instance</span><span class="o">.</span><span class="n">_pad</span>

    <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">val_start</span> <span class="o">=</span> <span class="n">val_stop</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">Pad</span><span class="p">):</span>
            <span class="n">val_start</span><span class="p">,</span> <span class="n">val_stop</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">val</span><span class="o">.</span><span class="n">stop</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">len_val</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">val_start</span> <span class="o">=</span> <span class="n">val_stop</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">len_val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">val_start</span> <span class="o">=</span> <span class="n">val_stop</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">elif</span> <span class="n">len_val</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">val_start</span> <span class="o">=</span> <span class="n">val_stop</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">len_val</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">val_start</span><span class="p">,</span> <span class="n">val_stop</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;interval_pad must be a float scalar, or 1 or 2-element list&quot;</span>
                    <span class="p">)</span>

        <span class="n">instance</span><span class="o">.</span><span class="n">_pad</span> <span class="o">=</span> <span class="n">Pad</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">val_start</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">val_stop</span><span class="p">))</span></div>


<div class="viewcode-block" id="Update"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.Update">[docs]</a><span class="k">class</span> <span class="nc">Update</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Last telemetry which was searched for an update.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># model name</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">21</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;name=</span><span class="si">{}</span><span class="s2"> date=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="p">)</span></div>


<div class="viewcode-block" id="MyManager"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.MyManager">[docs]</a><span class="k">class</span> <span class="nc">MyManager</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Manager</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Custom query manager that allows for overriding the default __repr__.</span>
<span class="sd">    The purpose is to make a more user friendly output for event queries.</span>

<span class="sd">    http://stackoverflow.com/questions/2163151/custom-queryset-and-manager-without-breaking-dry</span>
<span class="sd">    https://docs.djangoproject.com/en/3.1/topics/db/managers/#custom-managers</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">get_query_set</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">QuerySet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span></div>


<div class="viewcode-block" id="BaseModel"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.BaseModel">[docs]</a><span class="k">class</span> <span class="nc">BaseModel</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for for all models.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_get_obsid_start_attr</span> <span class="o">=</span> <span class="s2">&quot;date&quot;</span>  <span class="c1"># Attribute to use for getting event obsid</span>
    <span class="n">update_priority</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Priority order in update processing (higher =&gt; earlier)</span>

<div class="viewcode-block" id="BaseModel.QuerySet"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.BaseModel.QuerySet">[docs]</a>    <span class="k">class</span> <span class="nc">QuerySet</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">QuerySet</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        More user-friendly output from event queries.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">[:</span> <span class="n">models</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">REPR_OUTPUT_SIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">models</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">REPR_OUTPUT_SIZE</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;...(remaining elements truncated)...&quot;</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">)</span>

        <span class="nd">@property</span>
        <span class="k">def</span> <span class="nf">table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">un_unicode</span><span class="p">(</span><span class="n">vals</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span>
                    <span class="n">val</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">val</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">vals</span>
                <span class="p">)</span>

            <span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span>

            <span class="n">model_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_model_fields</span><span class="p">()</span>
            <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">model_fields</span><span class="p">]</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">values_list</span><span class="p">()</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">rows</span><span class="p">))</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">dat</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">names</span><span class="p">)</span>

            <span class="n">drop_names</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">dat</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span> <span class="k">if</span> <span class="n">dat</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;O&quot;</span>
            <span class="p">]</span>
            <span class="n">drop_names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">model_fields</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;_kadi_hidden&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)]</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">drop_names</span><span class="p">:</span>
                <span class="n">dat</span><span class="o">.</span><span class="n">remove_columns</span><span class="p">(</span><span class="n">drop_names</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">dat</span>

<div class="viewcode-block" id="BaseModel.QuerySet.select_overlapping"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.BaseModel.QuerySet.select_overlapping">[docs]</a>        <span class="k">def</span> <span class="nf">select_overlapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_event</span><span class="p">,</span> <span class="n">allow_partial</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Select events which overlap with the specified ``query_event``.</span>

<span class="sd">            By default partial overlap between the self events and the ``query_event``</span>
<span class="sd">            intervals is sufficient.  However, if ``allow_partial=False``, then</span>
<span class="sd">            complete overlap is required.  As an example this would be selecting</span>
<span class="sd">            maneuvers that are *entirely* within the radiation zone.</span>

<span class="sd">            Examples::</span>

<span class="sd">              &gt;&gt;&gt; from kadi import events</span>
<span class="sd">              &gt;&gt;&gt; manvrs = events.manvrs.filter(&#39;2001:001:00:00:00&#39;, &#39;2001:003:00:00:00&#39;)</span>
<span class="sd">              &gt;&gt;&gt; non_rad_manvrs = manvrs.select_overlapping(~events.rad_zones)</span>
<span class="sd">              &gt;&gt;&gt; rad_manvrs = manvrs.select_overlapping(events.rad_zones)</span>
<span class="sd">              &gt;&gt;&gt; fully_radzone_manvrs = manvrs.select_overlapping(events.rad_zones,</span>
<span class="sd">              ...                                                  allow_partial=False)</span>

<span class="sd">            :param query_event: QueryEvent object (e.g. events.tsc_moves or a composite</span>
<span class="sd">                                boolean expression)</span>
<span class="sd">            :param allow_partial: return events where there is at least partial overlap</span>
<span class="sd">                            (default=True)</span>

<span class="sd">            :returns: list of overlapping events</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="kn">from</span> <span class="nn">chandra_time</span> <span class="kn">import</span> <span class="n">DateTime</span>

            <span class="kn">from</span> <span class="nn">.query</span> <span class="kn">import</span> <span class="n">combine_intervals</span>

            <span class="c1"># First find the intervals corresponding to overlaps between self events and</span>
            <span class="c1"># `query_event`.  Do this over an interval that covers an extra 30 days on</span>
            <span class="c1"># either end, assuming that is the longest possible event.  (This padding might</span>
            <span class="c1"># not actually be necessary, but it doesn&#39;t hurt too much).</span>
            <span class="n">events</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tstart</span><span class="p">)</span> <span class="o">-</span> <span class="mi">30</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tstop</span><span class="p">)</span> <span class="o">+</span> <span class="mi">30</span>
            <span class="n">datestarts</span> <span class="o">=</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">start</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">]</span>
            <span class="n">datestops</span> <span class="o">=</span> <span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">stop</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">]</span>
            <span class="n">intervals</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">datestarts</span><span class="p">,</span> <span class="n">datestops</span><span class="p">))</span>
            <span class="n">qe_intervals</span> <span class="o">=</span> <span class="n">query_event</span><span class="o">.</span><span class="n">intervals</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span>
            <span class="n">overlap_intervals</span> <span class="o">=</span> <span class="n">combine_intervals</span><span class="p">(</span>
                <span class="n">operator</span><span class="o">.</span><span class="n">and_</span><span class="p">,</span> <span class="n">intervals</span><span class="p">,</span> <span class="n">qe_intervals</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span>
            <span class="p">)</span>

            <span class="n">overlap_starts</span><span class="p">,</span> <span class="n">overlap_stops</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">overlap_intervals</span><span class="p">))</span>

            <span class="n">datestarts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">datestarts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;S21&quot;</span><span class="p">)</span>
            <span class="n">datestops</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">datestops</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;S21&quot;</span><span class="p">)</span>
            <span class="n">overlap_starts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">overlap_starts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;S21&quot;</span><span class="p">)</span>
            <span class="n">overlap_stops</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">overlap_stops</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;S21&quot;</span><span class="p">)</span>

            <span class="n">func</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_get_partial_overlaps</span> <span class="k">if</span> <span class="n">allow_partial</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_full_overlaps</span>
            <span class="p">)</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">overlap_starts</span><span class="p">,</span> <span class="n">overlap_stops</span><span class="p">,</span> <span class="n">datestarts</span><span class="p">,</span> <span class="n">datestops</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span></div>

        <span class="nd">@staticmethod</span>
        <span class="k">def</span> <span class="nf">_get_full_overlaps</span><span class="p">(</span><span class="n">overlap_starts</span><span class="p">,</span> <span class="n">overlap_stops</span><span class="p">,</span> <span class="n">datestarts</span><span class="p">,</span> <span class="n">datestops</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Find which of the new overlap_intervals are the same as an original interval,</span>
<span class="sd">            indicating that there is a full overlap.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">datestops</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">overlap_stops</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

            <span class="c1"># Find the indices of matching datestart/stops for the overlap start/stop times.</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">datestops</span><span class="p">,</span> <span class="n">overlap_stops</span><span class="p">)</span>

            <span class="n">match_datestarts</span> <span class="o">=</span> <span class="n">datestarts</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
            <span class="n">match_datestops</span> <span class="o">=</span> <span class="n">datestops</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>

            <span class="n">ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">overlap_starts</span> <span class="o">==</span> <span class="n">match_datestarts</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
                <span class="n">overlap_stops</span> <span class="o">==</span> <span class="n">match_datestops</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">indices</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span>

        <span class="nd">@staticmethod</span>
        <span class="k">def</span> <span class="nf">_get_partial_overlaps</span><span class="p">(</span><span class="n">overlap_starts</span><span class="p">,</span> <span class="n">overlap_stops</span><span class="p">,</span> <span class="n">datestarts</span><span class="p">,</span> <span class="n">datestops</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Find which of the new overlap_intervals are the same as an original interval,</span>
<span class="sd">            indicating that there is a full overlap.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">datestops</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">overlap_stops</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">datestops</span><span class="p">,</span> <span class="n">overlap_starts</span><span class="p">)</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">indices</span></div>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Django &gt;= 1.8 (which is req&#39;d for Py3)</span>
        <span class="c1"># https://docs.djangoproject.com/en/1.10/topics/db/managers/#creating-a-manager-with-queryset-methods</span>
        <span class="n">objects</span> <span class="o">=</span> <span class="n">QuerySet</span><span class="o">.</span><span class="n">as_manager</span><span class="p">()</span>  <span class="c1"># Custom manager to use custom QuerySet below</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">objects</span> <span class="o">=</span> <span class="n">MyManager</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">abstract</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="BaseModel.from_dict"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.BaseModel.from_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">model_dict</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set model from a dict `model_dict` which might have extra stuff not in</span>
<span class="sd">        Model.  If `logger` is supplied then log output at debug level.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>

        <span class="c1"># Get the obsid at the appropriate time for the event (typically &quot;start&quot;</span>
        <span class="c1"># but &quot;stop&quot; in the case of Manvr).</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">TlmEvent</span><span class="p">)</span> <span class="ow">and</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Obsid</span><span class="p">:</span>
            <span class="n">tstart</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">model_dict</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_get_obsid_start_attr</span><span class="p">])</span><span class="o">.</span><span class="n">secs</span>
            <span class="n">obsrq</span> <span class="o">=</span> <span class="n">fetch</span><span class="o">.</span><span class="n">Msid</span><span class="p">(</span><span class="s2">&quot;cobsrqid&quot;</span><span class="p">,</span> <span class="n">tstart</span><span class="p">,</span> <span class="n">tstart</span> <span class="o">+</span> <span class="mi">200</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obsrq</span><span class="o">.</span><span class="n">vals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;WARNING: unable to get COBSRQID near &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_dict</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_get_obsid_start_attr</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
                    <span class="s2">&quot;using obsid=-999&quot;</span>
                <span class="p">)</span>
                <span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;obsid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">model_dict</span><span class="p">[</span><span class="s2">&quot;obsid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obsrq</span><span class="o">.</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">model_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;Setting </span><span class="si">{}</span><span class="s2"> model with </span><span class="si">{}</span><span class="s2">=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model</span></div>

<div class="viewcode-block" id="BaseModel.get_model_fields"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.BaseModel.get_model_fields">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_model_fields</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a list of model fields (works from class or instance).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">model_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_model_name&quot;</span><span class="p">):</span>
            <span class="n">cc_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="n">chars</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">c0</span><span class="p">,</span> <span class="n">c1</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cc_name</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">cc_name</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                <span class="c1"># Lower case followed by Upper case then insert &quot;_&quot;</span>
                <span class="n">chars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c0</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">c0</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">c0</span> <span class="ow">and</span> <span class="n">c1</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="n">c1</span><span class="p">:</span>
                    <span class="n">chars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="n">chars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c1</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_model_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_name</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_date_intervals</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">filter_kwargs</span><span class="p">):</span>
        <span class="c1"># OPTIMIZE ME!</span>

        <span class="c1"># Initially get events within padded date range.  Filter on only</span>
        <span class="c1"># the &quot;start&quot; field because this is always indexed, and filtering</span>
        <span class="c1"># on two fields is much slower in SQL.</span>
        <span class="k">if</span> <span class="n">pad</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pad</span> <span class="o">=</span> <span class="n">Pad</span><span class="p">()</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pad</span><span class="p">,</span> <span class="n">Pad</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;pad arg must be a Pad object&quot;</span><span class="p">)</span>

        <span class="n">datestart</span> <span class="o">=</span> <span class="p">(</span><span class="n">DateTime</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="o">-</span> <span class="bp">cls</span><span class="o">.</span><span class="n">lookback</span><span class="p">)</span><span class="o">.</span><span class="n">date</span>
        <span class="n">datestop</span> <span class="o">=</span> <span class="p">(</span><span class="n">DateTime</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span> <span class="o">+</span> <span class="bp">cls</span><span class="o">.</span><span class="n">lookback</span><span class="p">)</span><span class="o">.</span><span class="n">date</span>
        <span class="n">events</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">start__gte</span><span class="o">=</span><span class="n">datestart</span><span class="p">,</span> <span class="n">start__lte</span><span class="o">=</span><span class="n">datestop</span><span class="p">,</span> <span class="o">**</span><span class="n">filter_kwargs</span>
        <span class="p">)</span>

        <span class="n">datestart</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">date</span>
        <span class="n">datestop</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span><span class="o">.</span><span class="n">date</span>

        <span class="n">intervals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
            <span class="n">event_datestart</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">tstart</span> <span class="o">-</span> <span class="n">pad</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;secs&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span>
            <span class="n">event_datestop</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">tstop</span> <span class="o">+</span> <span class="n">pad</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;secs&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span>

            <span class="c1"># Negative padding might make an interval entirely disappear</span>
            <span class="k">if</span> <span class="n">event_datestart</span> <span class="o">&gt;=</span> <span class="n">event_datestop</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">event_datestart</span> <span class="o">&lt;=</span> <span class="n">datestop</span> <span class="ow">and</span> <span class="n">event_datestop</span> <span class="o">&gt;=</span> <span class="n">datestart</span><span class="p">:</span>
                <span class="n">interval_datestart</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">event_datestart</span><span class="p">,</span> <span class="n">datestart</span><span class="p">)</span>
                <span class="n">interval_datestop</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">event_datestop</span><span class="p">,</span> <span class="n">datestop</span><span class="p">)</span>

                <span class="c1"># If there is a previous interval and the end of the previous interval</span>
                <span class="c1"># is after the start of this new interval, then merge the two intervals</span>
                <span class="k">if</span> <span class="n">intervals</span> <span class="ow">and</span> <span class="n">intervals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">interval_datestart</span><span class="p">:</span>
                    <span class="n">intervals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">intervals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">interval_datestop</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Otherwise just create a new interval</span>
                    <span class="n">intervals</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">interval_datestart</span><span class="p">,</span> <span class="n">interval_datestop</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">intervals</span>

<div class="viewcode-block" id="BaseModel.get_obsid"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.BaseModel.get_obsid">[docs]</a>    <span class="k">def</span> <span class="nf">get_obsid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the obsid associated with the event.</span>

<span class="sd">        Typically this is the obsid at the start of the event, but for maneuvers it is the</span>
<span class="sd">        obsid at the end of the maneuver.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        obsid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">query</span>

        <span class="c1"># Get the start of the event.  If derived from Event or BaseEvent then</span>
        <span class="c1"># self will have a start attr.  Otherwise it must be from BaseModel in</span>
        <span class="c1"># which case it will have a date attr.</span>
        <span class="n">start</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_obsid_start_attr</span><span class="p">)</span>
        <span class="n">obsids</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">obsids</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obsids</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Expected one obsid at </span><span class="si">{}</span><span class="s2"> but got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">obsids</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">obsids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">obsid</span></div>

    <span class="k">def</span> <span class="fm">__bytes__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__unicode__</span><span class="p">()</span></div>


<div class="viewcode-block" id="BaseEvent"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.BaseEvent">[docs]</a><span class="k">class</span> <span class="nc">BaseEvent</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for any event that gets updated in update_events.main().  Note</span>
<span class="sd">    that BaseModel is the base class for models like ManvrSeq that get</span>
<span class="sd">    generated as part of another event class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">abstract</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span>

    <span class="n">_get_obsid_start_attr</span> <span class="o">=</span> <span class="s2">&quot;start&quot;</span>  <span class="c1"># Attribute to use for getting event obsid</span>
    <span class="n">lookback</span> <span class="o">=</span> <span class="mi">21</span>  <span class="c1"># days of lookback</span>
    <span class="n">interval_pad</span> <span class="o">=</span> <span class="n">IntervalPad</span><span class="p">()</span>  <span class="c1"># interval padding before/ after event start/stop</span>

<div class="viewcode-block" id="BaseEvent.get_commands"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.BaseEvent.get_commands">[docs]</a>    <span class="k">def</span> <span class="nf">get_commands</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get load commands within start/stop interval for this event.</span>
<span class="sd">        Apply padding defined by interval_pad attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">kadi</span> <span class="kn">import</span> <span class="n">cmds</span> <span class="k">as</span> <span class="n">commands</span>

        <span class="n">cmds</span> <span class="o">=</span> <span class="n">commands</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tstart</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval_pad</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tstop</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval_pad</span><span class="o">.</span><span class="n">stop</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">cmds</span></div>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;start=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>

<div class="viewcode-block" id="BaseEvent.get_next"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.BaseEvent.get_next">[docs]</a>    <span class="k">def</span> <span class="nf">get_next</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queryset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the next object by primary key order</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">queryset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="nb">next</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk__gt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">next</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="BaseEvent.get_previous"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.BaseEvent.get_previous">[docs]</a>    <span class="k">def</span> <span class="nf">get_previous</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queryset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the previous object by primary key order</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">queryset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk__lt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;-pk&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">prev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="Event"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.Event">[docs]</a><span class="k">class</span> <span class="nc">Event</span><span class="p">(</span><span class="n">BaseEvent</span><span class="p">):</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Start time (YYYY:DDD:HH:MM:SS)&quot;</span>
    <span class="p">)</span>
    <span class="n">stop</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Stop time (YYYY:DDD:HH:MM:SS)&quot;</span><span class="p">)</span>
    <span class="n">tstart</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">db_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Start time (CXC secs)&quot;</span><span class="p">)</span>
    <span class="n">tstop</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Stop time (CXC secs)&quot;</span><span class="p">)</span>
    <span class="n">dur</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Duration (secs)&quot;</span><span class="p">)</span>
    <span class="n">dur</span><span class="o">.</span><span class="n">_kadi_format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:.1f}</span><span class="s2">&quot;</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">abstract</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;start=</span><span class="si">{}</span><span class="s2"> dur=</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dur</span><span class="p">)</span></div>


<div class="viewcode-block" id="TlmEvent"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.TlmEvent">[docs]</a><span class="k">class</span> <span class="nc">TlmEvent</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
    <span class="n">obsid</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Observation ID (COBSRQID)&quot;</span><span class="p">)</span>

    <span class="n">event_msids</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># must be overridden by derived class</span>
    <span class="n">event_val</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">event_filter_bad</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Normally remove bad quality data immediately</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">abstract</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="TlmEvent.plot"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.TlmEvent.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrapper interface to plotting routines in plot module.  This is factored out</span>
<span class="sd">        of this module (models) to reduce loading of other modules (matplotlib) req&#39;d</span>
<span class="sd">        for plotting.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">plot</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">plot_func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">plot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">plot_func</span> <span class="o">=</span> <span class="n">plot</span><span class="o">.</span><span class="n">tlm_event</span>
        <span class="n">plot_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">figsize</span><span class="p">,</span> <span class="n">fig</span><span class="p">)</span></div>

<div class="viewcode-block" id="TlmEvent.get_extras"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.TlmEvent.get_extras">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_extras</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">event_msidset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get extra stuff for the event based on telemetry available in event_msidset.</span>
<span class="sd">        This is a hook within get_events() that should be overridden in individual</span>
<span class="sd">        classes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="TlmEvent.get_state_times_bools"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.TlmEvent.get_state_times_bools">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_state_times_bools</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">event_msidset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the boolean True/False array indicating when ``event_msid`` is in the</span>
<span class="sd">        desired state for this event type.  The default is when</span>
<span class="sd">        ``event_msid == cls.event_val``, but subclasses may override this method.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        event_msid</span>
<span class="sd">            fetch.MSID object</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        boolean ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">event_msid</span> <span class="o">=</span> <span class="n">event_msidset</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">event_msids</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">bools</span> <span class="o">=</span> <span class="n">event_msid</span><span class="o">.</span><span class="n">vals</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">event_val</span>
        <span class="k">return</span> <span class="n">event_msid</span><span class="o">.</span><span class="n">times</span><span class="p">,</span> <span class="n">bools</span></div>

<div class="viewcode-block" id="TlmEvent.get_msids_states"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.TlmEvent.get_msids_states">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_msids_states</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get event and related MSIDs and compute the states corresponding</span>
<span class="sd">        to the event.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tstart</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">secs</span>
        <span class="n">tstop</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span><span class="o">.</span><span class="n">secs</span>
        <span class="n">event_time_fuzz</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">event_time_fuzz</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;event_time_fuzz&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>

        <span class="c1"># Get the event telemetry MSID objects</span>
        <span class="n">event_msidset</span> <span class="o">=</span> <span class="n">fetch</span><span class="o">.</span><span class="n">MSIDset</span><span class="p">(</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">event_msids</span><span class="p">,</span> <span class="n">tstart</span><span class="p">,</span> <span class="n">tstop</span><span class="p">,</span> <span class="n">filter_bad</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">event_filter_bad</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Telemetry values for event_msids[0] define the states.  Don&#39;t allow a logical</span>
            <span class="c1"># interval that spans a telemetry gap of more than 10 major frames.</span>
            <span class="n">times</span><span class="p">,</span> <span class="n">bools</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_state_times_bools</span><span class="p">(</span><span class="n">event_msidset</span><span class="p">)</span>
            <span class="n">states</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">logical_intervals</span><span class="p">(</span>
                <span class="n">times</span><span class="p">,</span> <span class="n">bools</span><span class="p">,</span> <span class="n">max_gap</span><span class="o">=</span><span class="n">MAX_GAP</span><span class="p">,</span> <span class="n">complete_intervals</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">event_time_fuzz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;Warning: No telemetry available for </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="p">[],</span> <span class="n">event_msidset</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">states</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># When `event_time_fuzz` is specified, e.g. for events like Safe Sun Mode</span>
            <span class="c1"># or normal sun mode then ensure that the end of the event is at least</span>
            <span class="c1"># event_time_fuzz from the end of the search interval.  If not the event</span>
            <span class="c1"># might be split between the current search interval and the next.  Since</span>
            <span class="c1"># the next search interval will step forward in time, it is sure that</span>
            <span class="c1"># eventually the event will be fully contained.</span>
            <span class="k">if</span> <span class="n">event_time_fuzz</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">tstop</span> <span class="o">-</span> <span class="n">event_time_fuzz</span> <span class="o">&lt;</span> <span class="n">states</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;tstop&quot;</span><span class="p">]:</span>
                    <span class="c1"># Event tstop is within event_time_fuzz of the stop of states so</span>
                    <span class="c1"># bail out and don&#39;t return any states.</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="s2">&quot;Warning: dropping state because of &quot;</span>
                        <span class="s2">&quot;insufficent event time pad:</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:])</span>
                    <span class="p">)</span>
                    <span class="n">states</span> <span class="o">=</span> <span class="n">states</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">states</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">return</span> <span class="p">[],</span> <span class="n">event_msidset</span>

            <span class="c1"># Select event states that are contained within start/stop interval</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">tstart</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="s2">&quot;tstop&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">tstop</span><span class="p">)</span>
            <span class="n">states</span> <span class="o">=</span> <span class="n">states</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">event_time_fuzz</span><span class="p">:</span>
                <span class="n">states</span> <span class="o">=</span> <span class="n">fuzz_states</span><span class="p">(</span><span class="n">states</span><span class="p">,</span> <span class="n">event_time_fuzz</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">states</span><span class="p">,</span> <span class="n">event_msidset</span></div>

<div class="viewcode-block" id="TlmEvent.get_events"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.TlmEvent.get_events">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_events</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get events from telemetry defined by a simple rule that the value of</span>
<span class="sd">        `event_msids[0]` == `event_val`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">states</span><span class="p">,</span> <span class="n">event_msidset</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_msids_states</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span>

        <span class="c1"># Assemble a list of dicts corresponding to events in this tlm interval</span>
        <span class="n">events</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
            <span class="n">tstart</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span>
            <span class="n">tstop</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;tstop&quot;</span><span class="p">]</span>
            <span class="n">event</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">tstart</span><span class="o">=</span><span class="n">tstart</span><span class="p">,</span>
                <span class="n">tstop</span><span class="o">=</span><span class="n">tstop</span><span class="p">,</span>
                <span class="n">dur</span><span class="o">=</span><span class="n">tstop</span> <span class="o">-</span> <span class="n">tstart</span><span class="p">,</span>
                <span class="n">start</span><span class="o">=</span><span class="n">DateTime</span><span class="p">(</span><span class="n">tstart</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                <span class="n">stop</span><span class="o">=</span><span class="n">DateTime</span><span class="p">(</span><span class="n">tstop</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Reject events that are shorter than the minimum duration</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;event_min_dur&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;dur&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">cls</span><span class="o">.</span><span class="n">event_min_dur</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Custom processing defined by subclasses to add more attrs to event</span>
            <span class="n">event</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">get_extras</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">event_msidset</span><span class="p">))</span>

            <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">events</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">msidset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        fetch.MSIDset of self.fetch_event_msids.  By default filter_bad is True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_msidset&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_msidset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_event</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_msidset</span>

<div class="viewcode-block" id="TlmEvent.fetch_event"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.TlmEvent.fetch_event">[docs]</a>    <span class="k">def</span> <span class="nf">fetch_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extra_msids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filter_bad</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fetch an MSIDset of self.fetch_msids.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pad</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_event_pad</span>
        <span class="n">msids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_event_msids</span><span class="p">[:]</span>
        <span class="k">if</span> <span class="n">extra_msids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">extra_msids</span><span class="p">)</span>
        <span class="n">msidset</span> <span class="o">=</span> <span class="n">fetch</span><span class="o">.</span><span class="n">MSIDset</span><span class="p">(</span>
            <span class="n">msids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tstart</span> <span class="o">-</span> <span class="n">pad</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tstop</span> <span class="o">+</span> <span class="n">pad</span><span class="p">,</span> <span class="n">filter_bad</span><span class="o">=</span><span class="n">filter_bad</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">msidset</span></div></div>


<div class="viewcode-block" id="Obsid"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.Obsid">[docs]</a><span class="k">class</span> <span class="nc">Obsid</span><span class="p">(</span><span class="n">TlmEvent</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Observation identifier</span>

<span class="sd">    **Event definition**: interval where ``COBSRQID`` is unchanged.</span>

<span class="sd">    **Fields**</span>

<span class="sd">    ======== ========== ================================</span>
<span class="sd">     Field      Type              Description</span>
<span class="sd">    ======== ========== ================================</span>
<span class="sd">      start   Char(21)   Start time (YYYY:DDD:HH:MM:SS)</span>
<span class="sd">       stop   Char(21)    Stop time (YYYY:DDD:HH:MM:SS)</span>
<span class="sd">     tstart      Float            Start time (CXC secs)</span>
<span class="sd">      tstop      Float             Stop time (CXC secs)</span>
<span class="sd">        dur      Float                  Duration (secs)</span>
<span class="sd">      obsid    Integer        Observation ID (COBSRQID)</span>
<span class="sd">    ======== ========== ================================</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">event_msids</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;cobsrqid&quot;</span><span class="p">]</span>

    <span class="n">update_priority</span> <span class="o">=</span> <span class="mi">1000</span>  <span class="c1"># Process Obsid first</span>

<div class="viewcode-block" id="Obsid.get_events"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.Obsid.get_events">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_events</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get obsid events from telemetry.  A event is defined by a</span>
<span class="sd">        contiguous interval of the telemetered obsid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">events</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Get the event telemetry MSID objects</span>
        <span class="n">event_msidset</span> <span class="o">=</span> <span class="n">fetch</span><span class="o">.</span><span class="n">Msidset</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">event_msids</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span>
        <span class="n">obsid</span> <span class="o">=</span> <span class="n">event_msidset</span><span class="p">[</span><span class="s2">&quot;cobsrqid&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obsid</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># Not enough telemetry for state_intervals, return no events</span>
            <span class="k">return</span> <span class="n">events</span>

        <span class="n">states</span> <span class="o">=</span> <span class="n">obsid</span><span class="o">.</span><span class="n">state_intervals</span><span class="p">()</span>
        <span class="c1"># Skip the first and last states as they are likely incomplete</span>
        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">event</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">start</span><span class="o">=</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;datestart&quot;</span><span class="p">],</span>
                <span class="n">stop</span><span class="o">=</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;datestop&quot;</span><span class="p">],</span>
                <span class="n">tstart</span><span class="o">=</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">],</span>
                <span class="n">tstop</span><span class="o">=</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;tstop&quot;</span><span class="p">],</span>
                <span class="n">dur</span><span class="o">=</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;tstop&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">],</span>
                <span class="n">obsid</span><span class="o">=</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">events</span></div>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;start=</span><span class="si">{}</span><span class="s2"> dur=</span><span class="si">{:.0f}</span><span class="s2"> obsid=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dur</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">obsid</span><span class="p">)</span></div>


<div class="viewcode-block" id="TscMove"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.TscMove">[docs]</a><span class="k">class</span> <span class="nc">TscMove</span><span class="p">(</span><span class="n">TlmEvent</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    SIM TSC translation</span>

<span class="sd">    **Event definition**: interval where ``3TSCMOVE = MOVE``</span>

<span class="sd">    In addition to reporting the start and stop TSC position, these positions are also</span>
<span class="sd">    converted to the corresponding science instrument detector name, one of ``ACIS-I``,</span>
<span class="sd">    ``ACIS-S``, ``HRC-I``, or ``HRC-S``.  The maximum PWM value ``3MRMMXMV`` (sampled at</span>
<span class="sd">    the stop time + 66 seconds) is also included.</span>

<span class="sd">    **Fields**</span>

<span class="sd">    =============== ========== ============================================</span>
<span class="sd">         Field         Type                    Description</span>
<span class="sd">    =============== ========== ============================================</span>
<span class="sd">             start   Char(21)               Start time (YYYY:DDD:HH:MM:SS)</span>
<span class="sd">              stop   Char(21)                Stop time (YYYY:DDD:HH:MM:SS)</span>
<span class="sd">            tstart      Float                        Start time (CXC secs)</span>
<span class="sd">             tstop      Float                         Stop time (CXC secs)</span>
<span class="sd">               dur      Float                              Duration (secs)</span>
<span class="sd">             obsid    Integer                    Observation ID (COBSRQID)</span>
<span class="sd">     start_3tscpos    Integer                   Start TSC position (steps)</span>
<span class="sd">      stop_3tscpos    Integer                    Stop TSC position (steps)</span>
<span class="sd">         start_det    Char(6)   Start detector (ACIS-I ACIS-S HRC-I HRC-S)</span>
<span class="sd">          stop_det    Char(6)    Stop detector (ACIS-I ACIS-S HRC-I HRC-S)</span>
<span class="sd">           max_pwm    Integer                   Max PWM during translation</span>
<span class="sd">    =============== ========== ============================================</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">event_msids</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;3tscmove&quot;</span><span class="p">,</span> <span class="s2">&quot;3tscpos&quot;</span><span class="p">,</span> <span class="s2">&quot;3mrmmxmv&quot;</span><span class="p">]</span>
    <span class="n">event_val</span> <span class="o">=</span> <span class="s2">&quot;T&quot;</span>

    <span class="n">start_3tscpos</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Start TSC position (steps)&quot;</span><span class="p">)</span>
    <span class="n">stop_3tscpos</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Stop TSC position (steps)&quot;</span><span class="p">)</span>
    <span class="n">start_det</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Start detector (ACIS-I ACIS-S HRC-I HRC-S)&quot;</span>
    <span class="p">)</span>
    <span class="n">stop_det</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Stop detector (ACIS-I ACIS-S HRC-I HRC-S)&quot;</span>
    <span class="p">)</span>
    <span class="n">max_pwm</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Max PWM during translation&quot;</span><span class="p">)</span>

    <span class="n">interval_pad</span> <span class="o">=</span> <span class="n">IntervalPad</span><span class="p">()</span>  <span class="c1"># interval padding before/ after event start/stop</span>

<div class="viewcode-block" id="TscMove.get_extras"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.TscMove.get_extras">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_extras</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">event_msidset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define start/stop_3tscpos and start/stop_det.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">_get_start_stop_vals</span><span class="p">(</span>
            <span class="n">event</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">66</span><span class="p">,</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;tstop&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">66</span><span class="p">,</span> <span class="n">event_msidset</span><span class="p">,</span> <span class="n">msids</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;3tscpos&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;start_det&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_get_si</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s2">&quot;start_3tscpos&quot;</span><span class="p">])</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;stop_det&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_get_si</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s2">&quot;stop_3tscpos&quot;</span><span class="p">])</span>
        <span class="n">pwm</span> <span class="o">=</span> <span class="n">event_msidset</span><span class="p">[</span><span class="s2">&quot;3mrmmxmv&quot;</span><span class="p">]</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;max_pwm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">interpolate</span><span class="p">(</span><span class="n">pwm</span><span class="o">.</span><span class="n">vals</span><span class="p">,</span> <span class="n">pwm</span><span class="o">.</span><span class="n">times</span><span class="p">,</span> <span class="p">[</span><span class="n">event</span><span class="p">[</span><span class="s2">&quot;tstop&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">66</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">out</span></div>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;start=</span><span class="si">{}</span><span class="s2"> dur=</span><span class="si">{:.0f}</span><span class="s2"> start_3tscpos=</span><span class="si">{}</span><span class="s2"> stop_3tscpos=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dur</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_3tscpos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_3tscpos</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="DarkCalReplica"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.DarkCalReplica">[docs]</a><span class="k">class</span> <span class="nc">DarkCalReplica</span><span class="p">(</span><span class="n">TlmEvent</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ACA dark current calibration replica</span>

<span class="sd">    **Event definition**: interval where ``CIUMACAC = ON``</span>

<span class="sd">    CIUMACAC is the IU MODE ACA CALIBRATION INDICATOR.</span>

<span class="sd">    **Fields**</span>

<span class="sd">    ======== ========== ================================</span>
<span class="sd">     Field      Type              Description</span>
<span class="sd">    ======== ========== ================================</span>
<span class="sd">      start   Char(21)   Start time (YYYY:DDD:HH:MM:SS)</span>
<span class="sd">       stop   Char(21)    Stop time (YYYY:DDD:HH:MM:SS)</span>
<span class="sd">     tstart      Float            Start time (CXC secs)</span>
<span class="sd">      tstop      Float             Stop time (CXC secs)</span>
<span class="sd">        dur      Float                  Duration (secs)</span>
<span class="sd">      obsid    Integer        Observation ID (COBSRQID)</span>
<span class="sd">    ======== ========== ================================</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">event_msids</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ciumacac&quot;</span><span class="p">]</span>
    <span class="n">event_val</span> <span class="o">=</span> <span class="s2">&quot;ON &quot;</span>
    <span class="n">event_min_dur</span> <span class="o">=</span> <span class="mi">300</span></div>


<div class="viewcode-block" id="DarkCal"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.DarkCal">[docs]</a><span class="k">class</span> <span class="nc">DarkCal</span><span class="p">(</span><span class="n">TlmEvent</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ACA dark current calibration event</span>

<span class="sd">    **Event definition**: interval where ``CIUMACAC = ON``</span>

<span class="sd">    CIUMACAC is the IU MODE ACA CALIBRATION INDICATOR.  Individual intervals</span>
<span class="sd">    within one day are joined together to a single calibration event.</span>

<span class="sd">    **Fields**</span>

<span class="sd">    ======== ========== ================================</span>
<span class="sd">     Field      Type              Description</span>
<span class="sd">    ======== ========== ================================</span>
<span class="sd">      start   Char(21)   Start time (YYYY:DDD:HH:MM:SS)</span>
<span class="sd">       stop   Char(21)    Stop time (YYYY:DDD:HH:MM:SS)</span>
<span class="sd">     tstart      Float            Start time (CXC secs)</span>
<span class="sd">      tstop      Float             Stop time (CXC secs)</span>
<span class="sd">        dur      Float                  Duration (secs)</span>
<span class="sd">      obsid    Integer        Observation ID (COBSRQID)</span>
<span class="sd">    ======== ========== ================================</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">event_msids</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ciumacac&quot;</span><span class="p">]</span>
    <span class="n">event_val</span> <span class="o">=</span> <span class="s2">&quot;ON &quot;</span>
    <span class="n">event_time_fuzz</span> <span class="o">=</span> <span class="mi">86400</span>  <span class="c1"># One full day of fuzz / pad</span>
    <span class="n">event_min_dur</span> <span class="o">=</span> <span class="mi">8000</span></div>


<div class="viewcode-block" id="Scs107"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.Scs107">[docs]</a><span class="k">class</span> <span class="nc">Scs107</span><span class="p">(</span><span class="n">TlmEvent</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    SCS107 run</span>

<span class="sd">    **Event definition**: interval with the following combination of state values::</span>

<span class="sd">      3TSCMOVE = MOVE</span>
<span class="sd">      AORWBIAS = DISA</span>
<span class="sd">      CORADMEN = DISA</span>

<span class="sd">    These MSIDs are first sampled onto a common time sequence of 32.8 sec samples</span>
<span class="sd">    so the start / stop times are accurate only to that resolution.</span>

<span class="sd">    Early in the mission there were two SIM TSC translations during an SCS107 run.</span>
<span class="sd">    By the above rules this would generate two SCS107 events, but instead any two</span>
<span class="sd">    SCS107 events within 600 seconds are combined into a single event.</span>

<span class="sd">    **Fields**</span>

<span class="sd">    ======== ========== ================================</span>
<span class="sd">     Field      Type              Description</span>
<span class="sd">    ======== ========== ================================</span>
<span class="sd">      start   Char(21)   Start time (YYYY:DDD:HH:MM:SS)</span>
<span class="sd">       stop   Char(21)    Stop time (YYYY:DDD:HH:MM:SS)</span>
<span class="sd">     tstart      Float            Start time (CXC secs)</span>
<span class="sd">      tstop      Float             Stop time (CXC secs)</span>
<span class="sd">        dur      Float                  Duration (secs)</span>
<span class="sd">      obsid    Integer        Observation ID (COBSRQID)</span>
<span class="sd">      notes       Text               Supplemental notes</span>
<span class="sd">    ======== ========== ================================</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">notes</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Supplemental notes&quot;</span><span class="p">)</span>

    <span class="n">event_msids</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;3tscmove&quot;</span><span class="p">,</span> <span class="s2">&quot;aorwbias&quot;</span><span class="p">,</span> <span class="s2">&quot;coradmen&quot;</span><span class="p">]</span>
    <span class="n">event_time_fuzz</span> <span class="o">=</span> <span class="mi">600</span>  <span class="c1"># Earlier in the mission SCS107 resulted in two SIM moves</span>
    <span class="n">event_filter_bad</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="Scs107.get_state_times_bools"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.Scs107.get_state_times_bools">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_state_times_bools</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">msidset</span><span class="p">):</span>
        <span class="c1"># Interpolate all MSIDs to a common time.  Sync to the start of 3tscmove which is</span>
        <span class="c1"># sampled at 32.8 seconds</span>
        <span class="n">msidset_interpolate</span><span class="p">(</span><span class="n">msidset</span><span class="p">,</span> <span class="mf">32.8</span><span class="p">,</span> <span class="n">msidset</span><span class="p">[</span><span class="s2">&quot;3tscmove&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">scs107</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">msidset</span><span class="p">[</span><span class="s2">&quot;3tscmove&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">==</span> <span class="s2">&quot;T&quot;</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">msidset</span><span class="p">[</span><span class="s2">&quot;aorwbias&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">==</span> <span class="s2">&quot;DISA&quot;</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">msidset</span><span class="p">[</span><span class="s2">&quot;coradmen&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">==</span> <span class="s2">&quot;DISA&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">msidset</span><span class="o">.</span><span class="n">times</span><span class="p">,</span> <span class="n">scs107</span></div></div>


<div class="viewcode-block" id="FaMove"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.FaMove">[docs]</a><span class="k">class</span> <span class="nc">FaMove</span><span class="p">(</span><span class="n">TlmEvent</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    SIM FA translation</span>

<span class="sd">    **Event definition**: interval where ``3FAMOVE = MOVE``</span>

<span class="sd">    **Fields**</span>

<span class="sd">    ============== ========== ================================</span>
<span class="sd">        Field         Type              Description</span>
<span class="sd">    ============== ========== ================================</span>
<span class="sd">            start   Char(21)   Start time (YYYY:DDD:HH:MM:SS)</span>
<span class="sd">             stop   Char(21)    Stop time (YYYY:DDD:HH:MM:SS)</span>
<span class="sd">           tstart      Float            Start time (CXC secs)</span>
<span class="sd">            tstop      Float             Stop time (CXC secs)</span>
<span class="sd">              dur      Float                  Duration (secs)</span>
<span class="sd">            obsid    Integer        Observation ID (COBSRQID)</span>
<span class="sd">     start_3fapos    Integer        Start FA position (steps)</span>
<span class="sd">      stop_3fapos    Integer         Stop FA position (steps)</span>
<span class="sd">    ============== ========== ================================</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">event_msids</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;3famove&quot;</span><span class="p">,</span> <span class="s2">&quot;3fapos&quot;</span><span class="p">]</span>
    <span class="n">event_val</span> <span class="o">=</span> <span class="s2">&quot;T&quot;</span>

    <span class="n">start_3fapos</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Start FA position (steps)&quot;</span><span class="p">)</span>
    <span class="n">stop_3fapos</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Stop FA position (steps)&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="FaMove.get_extras"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.FaMove.get_extras">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_extras</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">event_msidset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define start/stop_3fapos.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">_get_start_stop_vals</span><span class="p">(</span>
            <span class="n">event</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">16.4</span><span class="p">,</span>
            <span class="n">event</span><span class="p">[</span><span class="s2">&quot;tstop&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">16.4</span><span class="p">,</span>
            <span class="n">event_msidset</span><span class="p">,</span>
            <span class="n">msids</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;3fapos&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;start=</span><span class="si">{}</span><span class="s2"> dur=</span><span class="si">{:.0f}</span><span class="s2"> start_3fapos=</span><span class="si">{}</span><span class="s2"> stop_3fapos=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dur</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_3fapos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_3fapos</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="GratingMove"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.GratingMove">[docs]</a><span class="k">class</span> <span class="nc">GratingMove</span><span class="p">(</span><span class="n">TlmEvent</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Grating movement (HETG or LETG)</span>

<span class="sd">    **Event definition**: interval with 4MP28AV &gt; 2.0 V  (MCE A + 28 VOLT MONITOR)</span>

<span class="sd">    This event detects grating motion via the MCE-A 28 volt monitor.  Due to</span>
<span class="sd">    changes in the on-board software over the years, this appears to be the</span>
<span class="sd">    most reliable method.</span>

<span class="sd">    Short movements of less than 4 seconds are classified with grating=BUMP.</span>
<span class="sd">    In a handful of cases in 2000, there are intervals with 4MP28AV &gt; 2.0</span>
<span class="sd">    where no grating motion is seen.  These have grating=UNKN (unknown).</span>

<span class="sd">    **Fields**</span>

<span class="sd">    ================ ========== =========================================</span>
<span class="sd">         Field          Type                   Description</span>
<span class="sd">    ================ ========== =========================================</span>
<span class="sd">              start   Char(21)            Start time (YYYY:DDD:HH:MM:SS)</span>
<span class="sd">               stop   Char(21)             Stop time (YYYY:DDD:HH:MM:SS)</span>
<span class="sd">             tstart      Float                     Start time (CXC secs)</span>
<span class="sd">              tstop      Float                      Stop time (CXC secs)</span>
<span class="sd">                dur      Float                           Duration (secs)</span>
<span class="sd">              obsid    Integer                 Observation ID (COBSRQID)</span>
<span class="sd">     start_4lposaro      Float             Start LETG position (degrees)</span>
<span class="sd">      stop_4lposaro      Float              Stop LETG position (degrees)</span>
<span class="sd">     start_4hposaro      Float             Start HETG position (degrees)</span>
<span class="sd">      stop_4hposaro      Float              Stop HETG position (degrees)</span>
<span class="sd">            grating    Char(4)   Grating in motion (UNKN LETG HETG BUMP)</span>
<span class="sd">          direction    Char(4)        Grating direction (UNKN INSR RETR)</span>
<span class="sd">    ================ ========== =========================================</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">start_4lposaro</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Start LETG position (degrees)&quot;</span><span class="p">)</span>
    <span class="n">stop_4lposaro</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Stop LETG position (degrees)&quot;</span><span class="p">)</span>
    <span class="n">start_4hposaro</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Start HETG position (degrees)&quot;</span><span class="p">)</span>
    <span class="n">stop_4hposaro</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Stop HETG position (degrees)&quot;</span><span class="p">)</span>
    <span class="n">grating</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Grating in motion (UNKN LETG HETG BUMP)&quot;</span>
    <span class="p">)</span>
    <span class="n">direction</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Grating direction (UNKN INSR RETR)&quot;</span>
    <span class="p">)</span>

    <span class="n">event_msids</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;4mp28av&quot;</span><span class="p">,</span> <span class="s2">&quot;4lposaro&quot;</span><span class="p">,</span> <span class="s2">&quot;4hposaro&quot;</span><span class="p">]</span>
    <span class="n">event_time_fuzz</span> <span class="o">=</span> <span class="mi">10</span>

<div class="viewcode-block" id="GratingMove.get_state_times_bools"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.GratingMove.get_state_times_bools">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_state_times_bools</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">event_msidset</span><span class="p">):</span>
        <span class="n">event_msid</span> <span class="o">=</span> <span class="n">event_msidset</span><span class="p">[</span><span class="s2">&quot;4mp28av&quot;</span><span class="p">]</span>
        <span class="n">moving</span> <span class="o">=</span> <span class="n">event_msid</span><span class="o">.</span><span class="n">vals</span> <span class="o">&gt;</span> <span class="mf">2.0</span>
        <span class="k">return</span> <span class="n">event_msid</span><span class="o">.</span><span class="n">times</span><span class="p">,</span> <span class="n">moving</span></div>

<div class="viewcode-block" id="GratingMove.get_extras"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.GratingMove.get_extras">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_extras</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">event_msidset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define start/stop grating positions for HETG and LETG</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">_get_start_stop_vals</span><span class="p">(</span>
            <span class="n">event</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">],</span>
            <span class="n">event</span><span class="p">[</span><span class="s2">&quot;tstop&quot;</span><span class="p">],</span>
            <span class="n">event_msidset</span><span class="p">,</span>
            <span class="n">msids</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;4lposaro&quot;</span><span class="p">,</span> <span class="s2">&quot;4hposaro&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;dur&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">grating</span> <span class="o">=</span> <span class="s2">&quot;BUMP&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">grating</span> <span class="o">=</span> <span class="s2">&quot;UNKN&quot;</span>  <span class="c1"># Should never stay as &#39;UNKN&#39;</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s2">&quot;start_4lposaro&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">out</span><span class="p">[</span><span class="s2">&quot;stop_4lposaro&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="n">grating</span> <span class="o">=</span> <span class="s2">&quot;LETG&quot;</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s2">&quot;start_4hposaro&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">out</span><span class="p">[</span><span class="s2">&quot;stop_4hposaro&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
                <span class="c1"># If BOTH this is not good (maybe two moves fuzzed together)</span>
                <span class="n">grating</span> <span class="o">=</span> <span class="s2">&quot;BOTH&quot;</span> <span class="k">if</span> <span class="n">grating</span> <span class="o">==</span> <span class="s2">&quot;LETG&quot;</span> <span class="k">else</span> <span class="s2">&quot;HETG&quot;</span>

        <span class="k">if</span> <span class="n">grating</span> <span class="o">==</span> <span class="s2">&quot;LETG&quot;</span><span class="p">:</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;INSR&quot;</span> <span class="k">if</span> <span class="n">out</span><span class="p">[</span><span class="s2">&quot;start_4lposaro&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">out</span><span class="p">[</span><span class="s2">&quot;stop_4lposaro&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;RETR&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">grating</span> <span class="o">==</span> <span class="s2">&quot;HETG&quot;</span><span class="p">:</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;INSR&quot;</span> <span class="k">if</span> <span class="n">out</span><span class="p">[</span><span class="s2">&quot;start_4hposaro&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">out</span><span class="p">[</span><span class="s2">&quot;stop_4hposaro&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;RETR&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="s2">&quot;UNKN&quot;</span>

        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;direction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">direction</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;grating&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grating</span>

        <span class="k">return</span> <span class="n">out</span></div>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;start=</span><span class="si">{}</span><span class="s2"> dur=</span><span class="si">{:.0f}</span><span class="s2"> grating=</span><span class="si">{}</span><span class="s2"> direction=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dur</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grating</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Dump"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.Dump">[docs]</a><span class="k">class</span> <span class="nc">Dump</span><span class="p">(</span><span class="n">TlmEvent</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Momentum unload either ground commanded or autonomous</span>

<span class="sd">    **Event definition**: interval where ``AOUNLOAD = GRND`` or ``AOUNLOAD = AUTO``</span>

<span class="sd">    **Fields**</span>

<span class="sd">    ======== ========== ==================================</span>
<span class="sd">     Field      Type               Description</span>
<span class="sd">    ======== ========== ==================================</span>
<span class="sd">      start   Char(21)     Start time (YYYY:DDD:HH:MM:SS)</span>
<span class="sd">       stop   Char(21)      Stop time (YYYY:DDD:HH:MM:SS)</span>
<span class="sd">     tstart      Float              Start time (CXC secs)</span>
<span class="sd">      tstop      Float               Stop time (CXC secs)</span>
<span class="sd">        dur      Float                    Duration (secs)</span>
<span class="sd">      obsid    Integer          Observation ID (COBSRQID)</span>
<span class="sd">       type    Char(4)   Momentum unload type (GRND AUTO)</span>
<span class="sd">    ======== ========== ==================================</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">event_msids</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;aounload&quot;</span><span class="p">]</span>
    <span class="n">event_val</span> <span class="o">=</span> <span class="s2">&quot;GRND&quot;</span>

    <span class="nb">type</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Momentum unload type (GRND AUTO)&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Dump.get_state_times_bools"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.Dump.get_state_times_bools">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_state_times_bools</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">event_msidset</span><span class="p">):</span>
        <span class="n">event_msid</span> <span class="o">=</span> <span class="n">event_msidset</span><span class="p">[</span><span class="s2">&quot;aounload&quot;</span><span class="p">]</span>
        <span class="n">unload</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">event_msid</span><span class="o">.</span><span class="n">vals</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;GRND&quot;</span><span class="p">,</span> <span class="s2">&quot;AUTO&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">event_msid</span><span class="o">.</span><span class="n">times</span><span class="p">,</span> <span class="n">unload</span></div>

<div class="viewcode-block" id="Dump.get_extras"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.Dump.get_extras">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_extras</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">event_msidset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define unload type</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tlm</span> <span class="o">=</span> <span class="n">event_msidset</span><span class="p">[</span><span class="s2">&quot;aounload&quot;</span><span class="p">]</span>
        <span class="n">t_mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;tstop&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">tlm</span><span class="o">.</span><span class="n">times</span><span class="p">,</span> <span class="n">t_mid</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">tlm</span><span class="o">.</span><span class="n">vals</span><span class="p">[</span><span class="n">idx</span><span class="p">]}</span>
        <span class="k">return</span> <span class="n">out</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;start=</span><span class="si">{}</span><span class="s2"> dur=</span><span class="si">{:.0f}</span><span class="s2"> type=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dur</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)</span></div>


<div class="viewcode-block" id="Eclipse"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.Eclipse">[docs]</a><span class="k">class</span> <span class="nc">Eclipse</span><span class="p">(</span><span class="n">TlmEvent</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Eclipse</span>

<span class="sd">    **Event definition**: interval where ``AOECLIPS = ECL``</span>

<span class="sd">    **Fields**</span>

<span class="sd">    ======== ========== ================================</span>
<span class="sd">     Field      Type              Description</span>
<span class="sd">    ======== ========== ================================</span>
<span class="sd">      start   Char(21)   Start time (YYYY:DDD:HH:MM:SS)</span>
<span class="sd">       stop   Char(21)    Stop time (YYYY:DDD:HH:MM:SS)</span>
<span class="sd">     tstart      Float            Start time (CXC secs)</span>
<span class="sd">      tstop      Float             Stop time (CXC secs)</span>
<span class="sd">        dur      Float                  Duration (secs)</span>
<span class="sd">      obsid    Integer        Observation ID (COBSRQID)</span>
<span class="sd">    ======== ========== ================================</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">event_msids</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;aoeclips&quot;</span><span class="p">]</span>
    <span class="n">event_val</span> <span class="o">=</span> <span class="s2">&quot;ECL &quot;</span>
    <span class="n">fetch_event_msids</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;aoeclips&quot;</span><span class="p">,</span> <span class="s2">&quot;eb1k5&quot;</span><span class="p">,</span> <span class="s2">&quot;eb2k5&quot;</span><span class="p">,</span> <span class="s2">&quot;eb3k5&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="Manvr"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.Manvr">[docs]</a><span class="k">class</span> <span class="nc">Manvr</span><span class="p">(</span><span class="n">TlmEvent</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Maneuver</span>

<span class="sd">    **Event definition**: interval where ``AOFATTMD = MNVR`` (spacecraft actually maneuvering)</span>

<span class="sd">    The maneuver event includes a number of attributes that give a detailed</span>
<span class="sd">    characterization of the timing and nature of the maneuver and corresponding</span>
<span class="sd">    star acquisitions and normal point model dwells.</span>

<span class="sd">    The ``start`` and ``stop`` time attributes for a maneuver event correspond exactly to</span>
<span class="sd">    the start and stop of the actual maneuver.  However, the full maneuver event</span>
<span class="sd">    contains information covering a larger time span from the end of the previous maneuver</span>
<span class="sd">    to the start of the next maneuver::</span>

<span class="sd">      Previous maneuver</span>
<span class="sd">                             &lt;---- Start of included information</span>
<span class="sd">        Previous MANV end</span>
<span class="sd">        Previous NPNT start</span>

<span class="sd">        ==&gt; Maneuver &lt;==</span>

<span class="sd">        Star acquisition</span>
<span class="sd">        Transition to KALM</span>
<span class="sd">        Kalman dwell</span>
<span class="sd">          Optional: more dwells, star acq sequences, NMAN/NPNT</span>

<span class="sd">        Transition to NMAN</span>
<span class="sd">        Transition to MANV</span>
<span class="sd">                             &lt;---- End of included information</span>
<span class="sd">      Next maneuver</span>

<span class="sd">    **Fields**</span>

<span class="sd">    ==================== ========== ============================================================</span>
<span class="sd">           Field            Type                            Description</span>
<span class="sd">    ==================== ========== ============================================================</span>
<span class="sd">                  start   Char(21)                               Start time (YYYY:DDD:HH:MM:SS)</span>
<span class="sd">                   stop   Char(21)                                Stop time (YYYY:DDD:HH:MM:SS)</span>
<span class="sd">                 tstart      Float                                        Start time (CXC secs)</span>
<span class="sd">                  tstop      Float                                         Stop time (CXC secs)</span>
<span class="sd">                    dur      Float                                              Duration (secs)</span>
<span class="sd">                  obsid    Integer                                    Observation ID (COBSRQID)</span>
<span class="sd">        prev_manvr_stop   Char(21)             Stop time of previous AOFATTMD=MNVR before manvr</span>
<span class="sd">        prev_npnt_start   Char(21)            Start time of previous AOPCADMD=NPNT before manvr</span>
<span class="sd">             nman_start   Char(21)                        Start time of AOPCADMD=NMAN for manvr</span>
<span class="sd">            manvr_start   Char(21)                        Start time of AOFATTMD=MNVR for manvr</span>
<span class="sd">             manvr_stop   Char(21)                         Stop time of AOFATTMD=MNVR for manvr</span>
<span class="sd">             npnt_start   Char(21)                      Start time of AOPCADMD=NPNT after manvr</span>
<span class="sd">              acq_start   Char(21)                      Start time of AOACASEQ=AQXN after manvr</span>
<span class="sd">            guide_start   Char(21)                      Start time of AOACASEQ=GUID after manvr</span>
<span class="sd">           kalman_start   Char(21)                      Start time of AOACASEQ=KALM after manvr</span>
<span class="sd">     aca_proc_act_start   Char(21)                       Start time of AOPSACPR=ACT after manvr</span>
<span class="sd">              npnt_stop   Char(21)                       Stop time of AOPCADMD=NPNT after manvr</span>
<span class="sd">        next_nman_start   Char(21)                 Start time of next AOPCADMD=NMAN after manvr</span>
<span class="sd">       next_manvr_start   Char(21)                 Start time of next AOFATTMD=MNVR after manvr</span>
<span class="sd">                n_dwell    Integer    Number of kalman dwells after manvr and before next manvr</span>
<span class="sd">                  n_acq    Integer   Number of AQXN intervals after manvr and before next manvr</span>
<span class="sd">                n_guide    Integer   Number of GUID intervals after manvr and before next manvr</span>
<span class="sd">               n_kalman    Integer   Number of KALM intervals after manvr and before next manvr</span>
<span class="sd">              anomalous    Boolean                             Key MSID shows off-nominal value</span>
<span class="sd">               template   Char(16)                                    Matched maneuver template</span>
<span class="sd">               start_ra      Float                           Start right ascension before manvr</span>
<span class="sd">              start_dec      Float                               Start declination before manvr</span>
<span class="sd">             start_roll      Float                                Start roll angle before manvr</span>
<span class="sd">                stop_ra      Float                             Stop right ascension after manvr</span>
<span class="sd">               stop_dec      Float                                 Stop declination after manvr</span>
<span class="sd">              stop_roll      Float                                  Stop roll angle after manvr</span>
<span class="sd">                  angle      Float                                         Maneuver angle (deg)</span>
<span class="sd">               one_shot      Float                            One shot attitude update (arcsec)</span>
<span class="sd">          one_shot_roll      Float                       One shot attitude update roll (arcsec)</span>
<span class="sd">         one_shot_pitch      Float                      One shot attitude update pitch (arcsec)</span>
<span class="sd">           one_shot_yaw      Float                        One shot attitude update yaw (arcsec)</span>
<span class="sd">    ==================== ========== ============================================================</span>

<span class="sd">    ``n_acq``, ``n_guide``, and ``n_kalman``: these provide a count of the number of times</span>
<span class="sd">        after the maneuver ends that ``AOACASEQ`` changes value from anything to ``AQXN``,</span>
<span class="sd">        ``GUID``, and ``KALM`` respectively.</span>

<span class="sd">    ``anomalous``: this is ``True`` if the following MSIDs have values that are</span>
<span class="sd">        not in the list of nominal state values:</span>

<span class="sd">        ==========  ===========================</span>
<span class="sd">           MSID          Nominal state values</span>
<span class="sd">        ==========  ===========================</span>
<span class="sd">         AOPCADMD       NPNT NMAN</span>
<span class="sd">         AOACASEQ       GUID KALM AQXN</span>
<span class="sd">         AOFATTMD       MNVR STDY</span>
<span class="sd">         AOPSACPR       INIT INAC ACT</span>
<span class="sd">         AOUNLOAD       MON  GRND</span>
<span class="sd">        ==========  ===========================</span>

<span class="sd">    ``template``: this indicates which of the pre-defined maneuver sequence templates were</span>
<span class="sd">        matched by this maneuver.  For details see :ref:`maneuver_templates`.</span>

<span class="sd">    ``one_shot``: one shot attitude update following maneuver.  This is -99.0 for maneuvers</span>
<span class="sd">        with no corresponding transition to NPM.</span>

<span class="sd">    ``one_shot_roll``, ``one_shot_pitch``, and ``one_shot_yaw`` are the values of AOATTER1, 2, and 3</span>
<span class="sd">        from samples after the guide transition.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_get_obsid_start_attr</span> <span class="o">=</span> <span class="s2">&quot;stop&quot;</span>  <span class="c1"># Attribute to use for getting event obsid</span>
    <span class="n">event_msids</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;aofattmd&quot;</span><span class="p">,</span> <span class="s2">&quot;aopcadmd&quot;</span><span class="p">,</span> <span class="s2">&quot;aoacaseq&quot;</span><span class="p">,</span> <span class="s2">&quot;aopsacpr&quot;</span><span class="p">]</span>
    <span class="n">event_val</span> <span class="o">=</span> <span class="s2">&quot;MNVR&quot;</span>

    <span class="n">fetch_event_msids</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;one_shot&quot;</span><span class="p">,</span>
        <span class="s2">&quot;aofattmd&quot;</span><span class="p">,</span>
        <span class="s2">&quot;aopcadmd&quot;</span><span class="p">,</span>
        <span class="s2">&quot;aoacaseq&quot;</span><span class="p">,</span>
        <span class="s2">&quot;aopsacpr&quot;</span><span class="p">,</span>
        <span class="s2">&quot;aounload&quot;</span><span class="p">,</span>
        <span class="s2">&quot;aoattqt1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;aoattqt2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;aoattqt3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;aoattqt4&quot;</span><span class="p">,</span>
        <span class="s2">&quot;aogyrct1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;aogyrct2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;aogyrct3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;aogyrct4&quot;</span><span class="p">,</span>
        <span class="s2">&quot;aoatupq1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;aoatupq2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;aoatupq3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;aotarqt1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;aotarqt2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;aotarqt3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;aoatter1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;aoatter2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;aoatter3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;aogbias1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;aogbias2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;aogbias3&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">fetch_event_pad</span> <span class="o">=</span> <span class="mi">600</span>

    <span class="n">interval_pad</span> <span class="o">=</span> <span class="n">IntervalPad</span><span class="p">()</span>  <span class="c1"># interval padding before/ after event start/stop</span>

    <span class="n">prev_manvr_stop</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span>
        <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Stop time of previous AOFATTMD=MNVR before manvr&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">prev_npnt_start</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span>
        <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Start time of previous AOPCADMD=NPNT before manvr&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">nman_start</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Start time of AOPCADMD=NMAN for manvr&quot;</span>
    <span class="p">)</span>
    <span class="n">manvr_start</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Start time of AOFATTMD=MNVR for manvr&quot;</span>
    <span class="p">)</span>
    <span class="n">manvr_stop</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Stop time of AOFATTMD=MNVR for manvr&quot;</span>
    <span class="p">)</span>
    <span class="n">npnt_start</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Start time of AOPCADMD=NPNT after manvr&quot;</span>
    <span class="p">)</span>
    <span class="n">acq_start</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Start time of AOACASEQ=AQXN after manvr&quot;</span>
    <span class="p">)</span>
    <span class="n">guide_start</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Start time of AOACASEQ=GUID after manvr&quot;</span>
    <span class="p">)</span>
    <span class="n">kalman_start</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Start time of AOACASEQ=KALM after manvr&quot;</span>
    <span class="p">)</span>
    <span class="n">aca_proc_act_start</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Start time of AOPSACPR=ACT after manvr&quot;</span>
    <span class="p">)</span>
    <span class="n">npnt_stop</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Stop time of AOPCADMD=NPNT after manvr&quot;</span>
    <span class="p">)</span>
    <span class="n">next_nman_start</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span>
        <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Start time of next AOPCADMD=NMAN after manvr&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">next_manvr_start</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span>
        <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Start time of next AOFATTMD=MNVR after manvr&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">n_dwell</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Number of kalman dwells after manvr and before next manvr&quot;</span>
    <span class="p">)</span>
    <span class="n">n_acq</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Number of AQXN intervals after manvr and before next manvr&quot;</span>
    <span class="p">)</span>
    <span class="n">n_guide</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Number of GUID intervals after manvr and before next manvr&quot;</span>
    <span class="p">)</span>
    <span class="n">n_kalman</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Number of KALM intervals after manvr and before next manvr&quot;</span>
    <span class="p">)</span>
    <span class="n">anomalous</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Key MSID shows off-nominal value&quot;</span><span class="p">)</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Matched maneuver template&quot;</span><span class="p">)</span>
    <span class="n">start_ra</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Start right ascension before manvr&quot;</span><span class="p">)</span>
    <span class="n">start_dec</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Start declination before manvr&quot;</span><span class="p">)</span>
    <span class="n">start_roll</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Start roll angle before manvr&quot;</span><span class="p">)</span>
    <span class="n">stop_ra</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Stop right ascension after manvr&quot;</span><span class="p">)</span>
    <span class="n">stop_dec</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Stop declination after manvr&quot;</span><span class="p">)</span>
    <span class="n">stop_roll</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Stop roll angle after manvr&quot;</span><span class="p">)</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Maneuver angle (deg)&quot;</span><span class="p">)</span>
    <span class="n">one_shot</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;One shot attitude update (arcsec)&quot;</span><span class="p">)</span>
    <span class="n">one_shot_roll</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;One shot attitude update roll (arcsec)&quot;</span>
    <span class="p">)</span>
    <span class="n">one_shot_pitch</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;One shot attitude update pitch (arcsec)&quot;</span>
    <span class="p">)</span>
    <span class="n">one_shot_yaw</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;One shot attitude update yaw (arcsec)&quot;</span><span class="p">)</span>

    <span class="n">one_shot</span><span class="o">.</span><span class="n">_kadi_format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:.1f}</span><span class="s2">&quot;</span>
    <span class="n">one_shot_roll</span><span class="o">.</span><span class="n">_kadi_format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:.1f}</span><span class="s2">&quot;</span>
    <span class="n">one_shot_pitch</span><span class="o">.</span><span class="n">_kadi_format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:.1f}</span><span class="s2">&quot;</span>
    <span class="n">one_shot_yaw</span><span class="o">.</span><span class="n">_kadi_format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:.1f}</span><span class="s2">&quot;</span>
    <span class="n">angle</span><span class="o">.</span><span class="n">_kadi_format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span>
    <span class="n">start_ra</span><span class="o">.</span><span class="n">_kadi_format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:.5f}</span><span class="s2">&quot;</span>
    <span class="n">start_dec</span><span class="o">.</span><span class="n">_kadi_format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:.5f}</span><span class="s2">&quot;</span>
    <span class="n">start_roll</span><span class="o">.</span><span class="n">_kadi_format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:.5f}</span><span class="s2">&quot;</span>
    <span class="n">stop_ra</span><span class="o">.</span><span class="n">_kadi_format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:.5f}</span><span class="s2">&quot;</span>
    <span class="n">stop_dec</span><span class="o">.</span><span class="n">_kadi_format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:.5f}</span><span class="s2">&quot;</span>
    <span class="n">stop_roll</span><span class="o">.</span><span class="n">_kadi_format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:.5f}</span><span class="s2">&quot;</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;start=</span><span class="si">{}</span><span class="s2"> dur=</span><span class="si">{:.0f}</span><span class="s2"> n_dwell=</span><span class="si">{}</span><span class="s2"> template=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dur</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_dwell</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span>
        <span class="p">)</span>

<div class="viewcode-block" id="Manvr.get_dwells"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.Manvr.get_dwells">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_dwells</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">changes</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the Kalman dwells associated with a maneuver event.</span>

<span class="sd">        A Kalman dwell is the contiguous interval of AOACASEQ = KALM between::</span>

<span class="sd">          Start: AOACASEQ ==&gt; KALM  (transition from any state to KALM)</span>
<span class="sd">          Stop:  AOACASEQ ==&gt; not KALM (transition to any state other than KALM)</span>
<span class="sd">                        **or**</span>
<span class="sd">                 AOPCADMD ==&gt; NMAN</span>

<span class="sd">        Short Kalman dwells that are less than 400 seconds long are *ignored* and</span>
<span class="sd">        are not recorded in the database.  These are typically associated with monitor</span>
<span class="sd">        window commanding or multiple acquisition attempts).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dwells</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">state</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">changes</span><span class="p">[</span><span class="s2">&quot;dt&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">ZERO_DT</span>
        <span class="n">dwell</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">change</span> <span class="ow">in</span> <span class="n">changes</span><span class="p">[</span><span class="n">ok</span><span class="p">]:</span>
            <span class="c1"># Not in a dwell and ACA sequence is KALMAN =&gt; start dwell.</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">state</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="n">change</span><span class="p">[</span><span class="s2">&quot;msid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;aoacaseq&quot;</span>
                <span class="ow">and</span> <span class="n">change</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;KALM&quot;</span>
            <span class="p">):</span>
                <span class="n">t0</span> <span class="o">=</span> <span class="n">change</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>
                <span class="n">dwell</span><span class="p">[</span><span class="s2">&quot;rel_tstart&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">change</span><span class="p">[</span><span class="s2">&quot;dt&quot;</span><span class="p">]</span>
                <span class="n">dwell</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">change</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>
                <span class="n">dwell</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">change</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span>
                <span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;dwell&quot;</span>

            <span class="c1"># Another KALMAN within 400 secs of previous KALMAN in dwell.</span>
            <span class="c1"># This is another acquisition sequence and moves the dwell start back.</span>
            <span class="k">elif</span> <span class="p">(</span>
                <span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;dwell&quot;</span>
                <span class="ow">and</span> <span class="n">change</span><span class="p">[</span><span class="s2">&quot;msid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;aoacaseq&quot;</span>
                <span class="ow">and</span> <span class="n">change</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;KALM&quot;</span>
                <span class="ow">and</span> <span class="n">change</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">t0</span> <span class="o">&lt;</span> <span class="mi">400</span>
            <span class="p">):</span>
                <span class="n">t0</span> <span class="o">=</span> <span class="n">change</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>
                <span class="n">dwell</span><span class="p">[</span><span class="s2">&quot;rel_tstart&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">change</span><span class="p">[</span><span class="s2">&quot;dt&quot;</span><span class="p">]</span>
                <span class="n">dwell</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">change</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>
                <span class="n">dwell</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">change</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span>

            <span class="c1"># End of dwell because of NPNT =&gt; NMAN transition OR another acquisition</span>
            <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;dwell&quot;</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">change</span><span class="p">[</span><span class="s2">&quot;msid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;aopcadmd&quot;</span> <span class="ow">and</span> <span class="n">change</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;NMAN&quot;</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="n">change</span><span class="p">[</span><span class="s2">&quot;msid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;aoacaseq&quot;</span> <span class="ow">and</span> <span class="n">change</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">t0</span> <span class="o">&gt;</span> <span class="mi">400</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">dwell</span><span class="p">[</span><span class="s2">&quot;tstop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">change</span><span class="p">[</span><span class="s2">&quot;prev_time&quot;</span><span class="p">]</span>
                <span class="n">dwell</span><span class="p">[</span><span class="s2">&quot;stop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">change</span><span class="p">[</span><span class="s2">&quot;prev_date&quot;</span><span class="p">]</span>
                <span class="n">dwell</span><span class="p">[</span><span class="s2">&quot;dur&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dwell</span><span class="p">[</span><span class="s2">&quot;tstop&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">dwell</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span>
                <span class="n">dwells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dwell</span><span class="p">)</span>
                <span class="n">dwell</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">state</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">dwell</span> <span class="ow">in</span> <span class="n">dwells</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">att</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;ra&quot;</span><span class="p">,</span> <span class="s2">&quot;dec&quot;</span><span class="p">,</span> <span class="s2">&quot;roll&quot;</span><span class="p">):</span>
                <span class="n">dwell</span><span class="p">[</span><span class="n">att</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;stop_&quot;</span> <span class="o">+</span> <span class="n">att</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">dwells</span></div>

<div class="viewcode-block" id="Manvr.get_manvr_attrs"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.Manvr.get_manvr_attrs">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_manvr_attrs</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">changes</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get attributes of the maneuver event and possible dwells based on</span>
<span class="sd">        the MSID `changes`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="n">msid</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Find a match for the given `msid` and `val`.  The `filter` can</span>
<span class="sd">            be either &#39;before&#39; or &#39;after&#39; to select changes before or after</span>
<span class="sd">            the maneuver end.  The `idx` value then selects form the matching</span>
<span class="sd">            changes.  If the desired match is not available then None is returned.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="n">changes</span><span class="p">[</span><span class="s2">&quot;msid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">msid</span>
            <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;!&quot;</span><span class="p">):</span>
                <span class="n">ok</span> <span class="o">&amp;=</span> <span class="n">changes</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ok</span> <span class="o">&amp;=</span> <span class="n">changes</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">val</span>
            <span class="k">if</span> <span class="nb">filter</span> <span class="o">==</span> <span class="s2">&quot;before&quot;</span><span class="p">:</span>
                <span class="n">ok</span> <span class="o">&amp;=</span> <span class="n">changes</span><span class="p">[</span><span class="s2">&quot;dt&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ZERO_DT</span>
            <span class="k">elif</span> <span class="nb">filter</span> <span class="o">==</span> <span class="s2">&quot;after&quot;</span><span class="p">:</span>
                <span class="n">ok</span> <span class="o">&amp;=</span> <span class="n">changes</span><span class="p">[</span><span class="s2">&quot;dt&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">ZERO_DT</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">changes</span><span class="p">[</span><span class="n">ok</span><span class="p">][</span><span class="s2">&quot;date&quot;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">changes</span><span class="p">[</span><span class="n">ok</span><span class="p">][</span><span class="n">idx</span><span class="p">][</span><span class="s2">&quot;date&quot;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Check for any telemetry values that are off-nominal</span>
        <span class="n">nom_vals</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;aopcadmd&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;NPNT&quot;</span><span class="p">,</span> <span class="s2">&quot;NMAN&quot;</span><span class="p">),</span>
            <span class="s2">&quot;aoacaseq&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;GUID&quot;</span><span class="p">,</span> <span class="s2">&quot;KALM&quot;</span><span class="p">,</span> <span class="s2">&quot;AQXN&quot;</span><span class="p">),</span>
            <span class="s2">&quot;aofattmd&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;MNVR&quot;</span><span class="p">,</span> <span class="s2">&quot;STDY&quot;</span><span class="p">),</span>
            <span class="s2">&quot;aopsacpr&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;INIT&quot;</span><span class="p">,</span> <span class="s2">&quot;INAC&quot;</span><span class="p">,</span> <span class="s2">&quot;ACT &quot;</span><span class="p">),</span>
            <span class="s2">&quot;aounload&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;MON &quot;</span><span class="p">,</span> <span class="s2">&quot;GRND&quot;</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">anomalous</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">change</span> <span class="ow">in</span> <span class="n">changes</span><span class="p">[</span><span class="n">changes</span><span class="p">[</span><span class="s2">&quot;dt&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">ZERO_DT</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">change</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nom_vals</span><span class="p">[</span><span class="n">change</span><span class="p">[</span><span class="s2">&quot;msid&quot;</span><span class="p">]]:</span>
                <span class="n">anomalous</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>

        <span class="c1"># Templates of previously seen maneuver sequences. These cover sequences seen at</span>
        <span class="c1"># least twice as of ~Mar 2012.</span>
        <span class="n">manvr_templates</span> <span class="o">=</span> <span class="n">get_manvr_templates</span><span class="p">()</span>
        <span class="n">seqs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s2">&quot;msid&quot;</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="s2">&quot;prev_val&quot;</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">changes</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">c</span><span class="p">[</span><span class="s2">&quot;msid&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;aopcadmd&quot;</span><span class="p">,</span> <span class="s2">&quot;aofattmd&quot;</span><span class="p">,</span> <span class="s2">&quot;aoacaseq&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">c</span><span class="p">[</span><span class="s2">&quot;dt&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">ZERO_DT</span>
            <span class="p">)</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">manvr_template</span> <span class="ow">in</span> <span class="n">manvr_templates</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">seqs</span> <span class="o">==</span> <span class="n">manvr_template</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
            <span class="p">):</span>  <span class="c1"># skip first two which are STDY-MNVR and MNVR-STDY</span>
                <span class="n">template</span> <span class="o">=</span> <span class="n">name</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span>

        <span class="n">manvr_attrs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">prev_manvr_stop</span><span class="o">=</span><span class="n">match</span><span class="p">(</span>
                <span class="s2">&quot;aofattmd&quot;</span><span class="p">,</span> <span class="s2">&quot;!MNVR&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;before&quot;</span>
            <span class="p">),</span>  <span class="c1"># Last STDY before this manvr</span>
            <span class="n">prev_npnt_start</span><span class="o">=</span><span class="n">match</span><span class="p">(</span>
                <span class="s2">&quot;aopcadmd&quot;</span><span class="p">,</span> <span class="s2">&quot;NPNT&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;before&quot;</span>
            <span class="p">),</span>  <span class="c1"># Last NPNT before this manvr</span>
            <span class="n">nman_start</span><span class="o">=</span><span class="n">match</span><span class="p">(</span>
                <span class="s2">&quot;aopcadmd&quot;</span><span class="p">,</span> <span class="s2">&quot;NMAN&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;before&quot;</span>
            <span class="p">),</span>  <span class="c1"># NMAN that precedes this manvr</span>
            <span class="n">manvr_start</span><span class="o">=</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;aofattmd&quot;</span><span class="p">,</span> <span class="s2">&quot;MNVR&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;before&quot;</span><span class="p">),</span>  <span class="c1"># start of this manvr</span>
            <span class="n">manvr_stop</span><span class="o">=</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;aofattmd&quot;</span><span class="p">,</span> <span class="s2">&quot;!MNVR&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;after&quot;</span><span class="p">),</span>
            <span class="n">npnt_start</span><span class="o">=</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;aopcadmd&quot;</span><span class="p">,</span> <span class="s2">&quot;NPNT&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;after&quot;</span><span class="p">),</span>
            <span class="n">acq_start</span><span class="o">=</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;aoacaseq&quot;</span><span class="p">,</span> <span class="s2">&quot;AQXN&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;after&quot;</span><span class="p">),</span>
            <span class="n">guide_start</span><span class="o">=</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;aoacaseq&quot;</span><span class="p">,</span> <span class="s2">&quot;GUID&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;after&quot;</span><span class="p">),</span>
            <span class="n">kalman_start</span><span class="o">=</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;aoacaseq&quot;</span><span class="p">,</span> <span class="s2">&quot;KALM&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;after&quot;</span><span class="p">),</span>
            <span class="n">aca_proc_act_start</span><span class="o">=</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;aopsacpr&quot;</span><span class="p">,</span> <span class="s2">&quot;ACT &quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;after&quot;</span><span class="p">),</span>
            <span class="n">npnt_stop</span><span class="o">=</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;aopcadmd&quot;</span><span class="p">,</span> <span class="s2">&quot;!NPNT&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;after&quot;</span><span class="p">),</span>
            <span class="n">next_nman_start</span><span class="o">=</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;aopcadmd&quot;</span><span class="p">,</span> <span class="s2">&quot;NMAN&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;after&quot;</span><span class="p">),</span>
            <span class="n">next_manvr_start</span><span class="o">=</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;aofattmd&quot;</span><span class="p">,</span> <span class="s2">&quot;MNVR&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;after&quot;</span><span class="p">),</span>
            <span class="n">n_acq</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;aoacaseq&quot;</span><span class="p">,</span> <span class="s2">&quot;AQXN&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;after&quot;</span><span class="p">)),</span>
            <span class="n">n_guide</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;aoacaseq&quot;</span><span class="p">,</span> <span class="s2">&quot;GUID&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;after&quot;</span><span class="p">)),</span>
            <span class="n">n_kalman</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;aoacaseq&quot;</span><span class="p">,</span> <span class="s2">&quot;KALM&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;after&quot;</span><span class="p">)),</span>
            <span class="n">anomalous</span><span class="o">=</span><span class="n">anomalous</span><span class="p">,</span>
            <span class="n">template</span><span class="o">=</span><span class="n">template</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">manvr_attrs</span></div>

<div class="viewcode-block" id="Manvr.get_target_attitudes"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.Manvr.get_target_attitudes">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_target_attitudes</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">msidset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define start/stop_aotarqt&lt;1..4&gt; and start/stop_ra,dec,roll</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">quats</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">dt</span> <span class="ow">in</span> <span class="p">((</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">60</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;stop&quot;</span><span class="p">,</span> <span class="mi">60</span><span class="p">)):</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dt</span>
            <span class="n">q123</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;aotarqt</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">msid</span> <span class="o">=</span> <span class="n">msidset</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="n">q123</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">interpolate</span><span class="p">(</span><span class="n">msid</span><span class="o">.</span><span class="n">vals</span><span class="p">,</span> <span class="n">msid</span><span class="o">.</span><span class="n">times</span><span class="p">,</span> <span class="p">[</span><span class="n">time</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="n">q123</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">q123</span><span class="p">)</span>
            <span class="n">sum_q123_sq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">q123</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">q4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">sum_q123_sq</span><span class="p">))</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sum_q123_sq</span> <span class="o">+</span> <span class="n">q4</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">quat</span> <span class="o">=</span> <span class="n">Quat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">q123</span><span class="p">,</span> <span class="p">[</span><span class="n">q4</span><span class="p">]])</span> <span class="o">/</span> <span class="n">norm</span><span class="p">)</span>
            <span class="n">quats</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">quat</span>
            <span class="n">out</span><span class="p">[</span><span class="n">label</span> <span class="o">+</span> <span class="s2">&quot;_aotarqt1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">quat</span><span class="o">.</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">out</span><span class="p">[</span><span class="n">label</span> <span class="o">+</span> <span class="s2">&quot;_aotarqt2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">quat</span><span class="o">.</span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">out</span><span class="p">[</span><span class="n">label</span> <span class="o">+</span> <span class="s2">&quot;_aotarqt3&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">quat</span><span class="o">.</span><span class="n">q</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">out</span><span class="p">[</span><span class="n">label</span> <span class="o">+</span> <span class="s2">&quot;_aotarqt4&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">quat</span><span class="o">.</span><span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">out</span><span class="p">[</span><span class="n">label</span> <span class="o">+</span> <span class="s2">&quot;_ra&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">quat</span><span class="o">.</span><span class="n">ra</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="n">label</span> <span class="o">+</span> <span class="s2">&quot;_dec&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">quat</span><span class="o">.</span><span class="n">dec</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="n">label</span> <span class="o">+</span> <span class="s2">&quot;_roll&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">quat</span><span class="o">.</span><span class="n">roll</span><span class="p">)</span>

        <span class="n">dq</span> <span class="o">=</span> <span class="n">quats</span><span class="p">[</span><span class="s2">&quot;stop&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">quats</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span>  <span class="c1"># = (wx * sa2, wy * sa2, wz * sa2, ca2)</span>
        <span class="n">q3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dq</span><span class="o">.</span><span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">q3</span> <span class="o">&gt;=</span> <span class="mf">1.0</span><span class="p">:</span>  <span class="c1"># Floating point error possible</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;angle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;angle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">q3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="Manvr.get_one_shot"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.Manvr.get_one_shot">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_one_shot</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">guide_start</span><span class="p">,</span> <span class="n">aux_msidset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define one_shot attribute (one-shot attitude update following maneuver)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># No acq =&gt; guide transition so no one-shot defined.  Use -99.0 as a convenience for</span>
        <span class="c1"># the one shot length, -999.0 for the axis values.</span>
        <span class="k">if</span> <span class="n">guide_start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;one_shot&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">99.0</span><span class="p">,</span>
                <span class="s2">&quot;one_shot_roll&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">999.0</span><span class="p">,</span>
                <span class="s2">&quot;one_shot_pitch&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">999.0</span><span class="p">,</span>
                <span class="s2">&quot;one_shot_yaw&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">999.0</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="c1"># Save the first post maneuver / post ACQ attitude error sample for each AOATTER axis</span>
        <span class="n">pm_att_err</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]:</span>
            <span class="n">msid</span> <span class="o">=</span> <span class="n">aux_msidset</span><span class="p">[</span><span class="s2">&quot;aoatter</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ax</span><span class="p">)]</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">msid</span><span class="o">.</span><span class="n">times</span> <span class="o">&gt;=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">guide_start</span><span class="p">)</span><span class="o">.</span><span class="n">secs</span> <span class="o">+</span> <span class="mf">1.1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
                <span class="n">msid</span><span class="o">.</span><span class="n">times</span> <span class="o">&lt;</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">guide_start</span><span class="p">)</span><span class="o">.</span><span class="n">secs</span> <span class="o">+</span> <span class="mi">30</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">ok</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;No AOATTER</span><span class="si">{}</span><span class="s2"> times for guide transition at </span><span class="si">{}</span><span class="s2"> for one shot&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">ax</span><span class="p">,</span> <span class="n">guide_start</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="n">pm_att_err</span><span class="p">[</span><span class="n">ax</span><span class="p">]</span> <span class="o">=</span> <span class="n">msid</span><span class="o">.</span><span class="n">vals</span><span class="p">[</span><span class="n">ok</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">R2A</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;one_shot&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pm_att_err</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pm_att_err</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s2">&quot;one_shot_roll&quot;</span><span class="p">:</span> <span class="n">pm_att_err</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s2">&quot;one_shot_pitch&quot;</span><span class="p">:</span> <span class="n">pm_att_err</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="s2">&quot;one_shot_yaw&quot;</span><span class="p">:</span> <span class="n">pm_att_err</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="Manvr.get_events"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.Manvr.get_events">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_events</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get maneuver events from telemetry.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">events</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Auxiliary information</span>
        <span class="n">aux_msidset</span> <span class="o">=</span> <span class="n">fetch</span><span class="o">.</span><span class="n">Msidset</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;aotarqt1&quot;</span><span class="p">,</span> <span class="s2">&quot;aotarqt2&quot;</span><span class="p">,</span> <span class="s2">&quot;aotarqt3&quot;</span><span class="p">,</span> <span class="s2">&quot;aoatter1&quot;</span><span class="p">,</span> <span class="s2">&quot;aoatter2&quot;</span><span class="p">,</span> <span class="s2">&quot;aoatter3&quot;</span><span class="p">],</span>
            <span class="n">start</span><span class="p">,</span>
            <span class="n">stop</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Need at least 2 samples to get states. Having no samples typically</span>
        <span class="c1"># happens when building the event tables and telemetry queries are just</span>
        <span class="c1"># before telemetry starts.</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aux_msid</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">aux_msid</span> <span class="ow">in</span> <span class="n">aux_msidset</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="k">return</span> <span class="n">events</span>

        <span class="n">states</span><span class="p">,</span> <span class="n">event_msidset</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_msids_states</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)</span>
        <span class="n">changes</span> <span class="o">=</span> <span class="n">_get_msid_changes</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">event_msidset</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="n">sortmsids</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;aofattmd&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;aopcadmd&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;aoacaseq&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;aopsacpr&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">manvr_prev</span><span class="p">,</span> <span class="n">manvr</span><span class="p">,</span> <span class="n">manvr_next</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">states</span><span class="p">,</span> <span class="n">states</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">states</span><span class="p">[</span><span class="mi">2</span><span class="p">:]):</span>
            <span class="n">tstart</span> <span class="o">=</span> <span class="n">manvr</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span>
            <span class="n">tstop</span> <span class="o">=</span> <span class="n">manvr</span><span class="p">[</span><span class="s2">&quot;tstop&quot;</span><span class="p">]</span>

            <span class="c1"># Make sure the aux_msidset (used for stop/stop target attitudes and one shot)</span>
            <span class="c1"># is complete through the end of maneuver + one hour.  Finish event processing</span>
            <span class="c1"># if that is not the case.</span>
            <span class="n">min_aux_tstop</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">aux_msid</span><span class="o">.</span><span class="n">times</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">aux_msid</span> <span class="ow">in</span> <span class="n">aux_msidset</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">min_aux_tstop</span> <span class="o">&lt;</span> <span class="n">tstop</span> <span class="o">+</span> <span class="mi">3600</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Breaking out of maneuver processing at manvr start=</span><span class="si">{}</span><span class="s2"> because &quot;</span>
                    <span class="s2">&quot;min_aux_stop=</span><span class="si">{}</span><span class="s2"> &lt; manvr stop + 1hr=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">DateTime</span><span class="p">(</span><span class="n">tstart</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                        <span class="n">DateTime</span><span class="p">(</span><span class="n">min_aux_tstop</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                        <span class="n">DateTime</span><span class="p">(</span><span class="n">tstop</span> <span class="o">+</span> <span class="mi">3600</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">break</span>

            <span class="n">i0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">changes</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">manvr_prev</span><span class="p">[</span><span class="s2">&quot;tstop&quot;</span><span class="p">])</span>
            <span class="n">i1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">changes</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">manvr_next</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">])</span>
            <span class="n">sequence</span> <span class="o">=</span> <span class="n">changes</span><span class="p">[</span><span class="n">i0</span> <span class="p">:</span> <span class="n">i1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">sequence</span><span class="p">[</span><span class="s2">&quot;dt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sequence</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">sequence</span><span class="p">[</span><span class="s2">&quot;prev_time&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="n">manvr</span><span class="p">[</span>
                <span class="s2">&quot;tstop&quot;</span>
            <span class="p">]</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">sequence</span><span class="p">[</span><span class="s2">&quot;dt&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">ZERO_DT</span><span class="p">)</span>
                <span class="o">|</span> <span class="p">(</span><span class="n">sequence</span><span class="p">[</span><span class="s2">&quot;msid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;aofattmd&quot;</span><span class="p">)</span>
                <span class="o">|</span> <span class="p">(</span><span class="n">sequence</span><span class="p">[</span><span class="s2">&quot;msid&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;aopcadmd&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">sequence</span> <span class="o">=</span> <span class="n">sequence</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span>
            <span class="n">manvr_attrs</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_manvr_attrs</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span>

            <span class="n">event</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">tstart</span><span class="o">=</span><span class="n">tstart</span><span class="p">,</span>
                <span class="n">tstop</span><span class="o">=</span><span class="n">tstop</span><span class="p">,</span>
                <span class="n">dur</span><span class="o">=</span><span class="n">tstop</span> <span class="o">-</span> <span class="n">tstart</span><span class="p">,</span>
                <span class="n">start</span><span class="o">=</span><span class="n">DateTime</span><span class="p">(</span><span class="n">tstart</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                <span class="n">stop</span><span class="o">=</span><span class="n">DateTime</span><span class="p">(</span><span class="n">tstop</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                <span class="n">foreign</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;ManvrSeq&quot;</span><span class="p">:</span> <span class="n">sequence</span><span class="p">},</span>
            <span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">manvr_attrs</span><span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">get_target_attitudes</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">aux_msidset</span><span class="p">))</span>
            <span class="n">one_shot</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_one_shot</span><span class="p">(</span><span class="n">manvr_attrs</span><span class="p">[</span><span class="s2">&quot;guide_start&quot;</span><span class="p">],</span> <span class="n">aux_msidset</span><span class="p">)</span>
            <span class="n">event</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">one_shot</span><span class="p">)</span>
            <span class="n">dwells</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_dwells</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">sequence</span><span class="p">)</span>
            <span class="n">event</span><span class="p">[</span><span class="s2">&quot;foreign&quot;</span><span class="p">][</span><span class="s2">&quot;Dwell&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dwells</span>
            <span class="n">event</span><span class="p">[</span><span class="s2">&quot;n_dwell&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dwells</span><span class="p">)</span>

            <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">events</span></div></div>


<div class="viewcode-block" id="Dwell"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.Dwell">[docs]</a><span class="k">class</span> <span class="nc">Dwell</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dwell in Kalman mode</span>

<span class="sd">    **Event definition**: contiguous interval of AOACASEQ = KALM between::</span>

<span class="sd">      Start: AOACASEQ ==&gt; KALM  (transition from any state to KALM)</span>
<span class="sd">      Stop:  AOACASEQ ==&gt; not KALM (transition to any state other than KALM)</span>
<span class="sd">                    **or**</span>
<span class="sd">             AOPCADMD ==&gt; NMAN</span>

<span class="sd">    Short Kalman dwells that are less than 400 seconds long are *ignored* and</span>
<span class="sd">    are not recorded in the database.  These are typically associated with monitor</span>
<span class="sd">    window commanding or multiple acquisition attempts).</span>

<span class="sd">    **Fields**</span>

<span class="sd">    ============ ============ ========================================</span>
<span class="sd">       Field         Type                   Description</span>
<span class="sd">    ============ ============ ========================================</span>
<span class="sd">          start     Char(21)           Start time (YYYY:DDD:HH:MM:SS)</span>
<span class="sd">           stop     Char(21)            Stop time (YYYY:DDD:HH:MM:SS)</span>
<span class="sd">         tstart        Float                    Start time (CXC secs)</span>
<span class="sd">          tstop        Float                     Stop time (CXC secs)</span>
<span class="sd">            dur        Float                          Duration (secs)</span>
<span class="sd">     rel_tstart        Float   Start time relative to manvr end (sec)</span>
<span class="sd">          manvr   ForeignKey        Maneuver that contains this dwell</span>
<span class="sd">             ra        Float                    Right ascension (deg)</span>
<span class="sd">            dec        Float                        Declination (deg)</span>
<span class="sd">           roll        Float                         Roll angle (deg)</span>
<span class="sd">    ============ ============ ========================================</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">rel_tstart</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Start time relative to manvr end (sec)&quot;</span><span class="p">)</span>
    <span class="n">manvr</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="n">Manvr</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Maneuver that contains this dwell&quot;</span>
    <span class="p">)</span>
    <span class="n">ra</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Right ascension (deg)&quot;</span><span class="p">)</span>
    <span class="n">dec</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Declination (deg)&quot;</span><span class="p">)</span>
    <span class="n">roll</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Roll angle (deg)&quot;</span><span class="p">)</span>
    <span class="n">rel_tstart</span><span class="o">.</span><span class="n">_kadi_format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span>
    <span class="n">ra</span><span class="o">.</span><span class="n">_kadi_format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:.5f}</span><span class="s2">&quot;</span>
    <span class="n">dec</span><span class="o">.</span><span class="n">_kadi_format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:.5f}</span><span class="s2">&quot;</span>
    <span class="n">roll</span><span class="o">.</span><span class="n">_kadi_format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:.5f}</span><span class="s2">&quot;</span>

    <span class="c1"># To do: add ra dec roll quaternion</span>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO add ra, dec, roll</span>
        <span class="k">return</span> <span class="s2">&quot;start=</span><span class="si">{}</span><span class="s2"> dur=</span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dur</span><span class="p">)</span></div>


<div class="viewcode-block" id="ManvrSeq"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.ManvrSeq">[docs]</a><span class="k">class</span> <span class="nc">ManvrSeq</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Maneuver sequence event</span>

<span class="sd">    Each entry in this table corresponds to a state transition for an MSID</span>
<span class="sd">    that is relevant to the sequence of events comprising a maneuver event.</span>

<span class="sd">    **Fields**</span>

<span class="sd">    =========== ============ ===========</span>
<span class="sd">       Field        Type     Description</span>
<span class="sd">    =========== ============ ===========</span>
<span class="sd">         manvr   ForeignKey</span>
<span class="sd">          msid      Char(8)</span>
<span class="sd">      prev_val      Char(4)</span>
<span class="sd">           val      Char(4)</span>
<span class="sd">          date     Char(21)</span>
<span class="sd">            dt        Float</span>
<span class="sd">          time        Float</span>
<span class="sd">     prev_date     Char(21)</span>
<span class="sd">     prev_time        Float</span>
<span class="sd">    =========== ============ ===========</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">manvr</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Manvr</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="n">msid</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">prev_val</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">21</span><span class="p">)</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">()</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">()</span>
    <span class="n">prev_date</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">21</span><span class="p">)</span>
    <span class="n">prev_time</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;manvr&quot;</span><span class="p">,</span> <span class="s2">&quot;date&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2"> =&gt; </span><span class="si">{}</span><span class="s2"> at </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msid</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">prev_val</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">val</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="SafeSun"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.SafeSun">[docs]</a><span class="k">class</span> <span class="nc">SafeSun</span><span class="p">(</span><span class="n">TlmEvent</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Safe sun event</span>

<span class="sd">    **Event definition**: interval from safe mode entry to recovery to OBC control.</span>

<span class="sd">    Specifically, it is considered part of the safe mode condition if any of the</span>
<span class="sd">    following are True::</span>

<span class="sd">       CONLOFP != &#39;NRML&#39;  # OFP state</span>
<span class="sd">       CTUFMTSL = &#39;FMT5&#39;  # CTU telemetry format</span>
<span class="sd">       C1SQAX != &#39;ENAB&#39;   # Sequencer A enable/disable</span>

<span class="sd">    **Fields**</span>

<span class="sd">    ======== ========== ================================</span>
<span class="sd">     Field      Type              Description</span>
<span class="sd">    ======== ========== ================================</span>
<span class="sd">      start   Char(21)   Start time (YYYY:DDD:HH:MM:SS)</span>
<span class="sd">       stop   Char(21)    Stop time (YYYY:DDD:HH:MM:SS)</span>
<span class="sd">     tstart      Float            Start time (CXC secs)</span>
<span class="sd">      tstop      Float             Stop time (CXC secs)</span>
<span class="sd">        dur      Float                  Duration (secs)</span>
<span class="sd">      obsid    Integer        Observation ID (COBSRQID)</span>
<span class="sd">      notes       Text</span>
<span class="sd">    ======== ========== ================================</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">notes</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
    <span class="n">event_msids</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;conlofp&quot;</span><span class="p">,</span> <span class="s2">&quot;ctufmtsl&quot;</span><span class="p">,</span> <span class="s2">&quot;c1sqax&quot;</span><span class="p">]</span>
    <span class="n">event_filter_bad</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">event_time_fuzz</span> <span class="o">=</span> <span class="mi">86400</span>  <span class="c1"># One full day of fuzz / pad</span>
    <span class="n">event_min_dur</span> <span class="o">=</span> <span class="mi">36000</span>

    <span class="n">fetch_event_pad</span> <span class="o">=</span> <span class="mi">86400</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">fetch_event_msids</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;conlofp&quot;</span><span class="p">,</span> <span class="s2">&quot;ctufmtsl&quot;</span><span class="p">,</span> <span class="s2">&quot;c1sqax&quot;</span><span class="p">,</span> <span class="s2">&quot;aopcadmd&quot;</span><span class="p">,</span> <span class="s2">&quot;61psts02&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="SafeSun.get_state_times_bools"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.SafeSun.get_state_times_bools">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_state_times_bools</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">msidset</span><span class="p">):</span>
        <span class="c1"># Second safemode has bad telemetry for the entire event so the standard</span>
        <span class="c1"># detection algorithm fails.  Just hardwire safemode #1 and fix up the</span>
        <span class="c1"># telemetry within this range so that the standard detection works.</span>
        <span class="n">safemode2_tstart</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="s2">&quot;1999:269:20:22:45&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">secs</span>
        <span class="n">safemode2_tstop</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="s2">&quot;1999:270:08:22:30&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">secs</span>
        <span class="k">if</span> <span class="n">msidset</span><span class="o">.</span><span class="n">tstart</span> <span class="o">&lt;</span> <span class="n">safemode2_tstop</span> <span class="ow">and</span> <span class="n">msidset</span><span class="o">.</span><span class="n">tstop</span> <span class="o">&gt;</span> <span class="n">safemode2_tstart</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">msid</span> <span class="ow">in</span> <span class="n">msidset</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">msid</span><span class="o">.</span><span class="n">times</span> <span class="o">&gt;</span> <span class="n">safemode2_tstart</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">msid</span><span class="o">.</span><span class="n">times</span> <span class="o">&lt;</span> <span class="n">safemode2_tstop</span><span class="p">)</span>
                <span class="n">msid</span><span class="o">.</span><span class="n">bads</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">force_val</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;conlofp&quot;</span><span class="p">:</span> <span class="s2">&quot;NRML&quot;</span><span class="p">,</span> <span class="s2">&quot;ctufmtsl&quot;</span><span class="p">:</span> <span class="s2">&quot;FMT5&quot;</span><span class="p">,</span> <span class="s2">&quot;c1sqax&quot;</span><span class="p">:</span> <span class="s2">&quot;ENAB&quot;</span><span class="p">}[</span>
                    <span class="n">msid</span><span class="o">.</span><span class="n">msid</span>
                <span class="p">]</span>
                <span class="n">msid</span><span class="o">.</span><span class="n">vals</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span> <span class="o">=</span> <span class="n">force_val</span>

        <span class="c1"># Interpolate all MSIDs to a common time.  Sync to the start of CTUFMTSL which is</span>
        <span class="c1"># sampled at 32.8 seconds</span>
        <span class="n">msidset_interpolate</span><span class="p">(</span><span class="n">msidset</span><span class="p">,</span> <span class="mf">32.8</span><span class="p">,</span> <span class="n">msidset</span><span class="p">[</span><span class="s2">&quot;ctufmtsl&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Define intervals when in safe mode ~(A &amp; B &amp; C) == (~A | ~B | ~C)</span>
        <span class="n">safe_mode</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">msidset</span><span class="p">[</span><span class="s2">&quot;conlofp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">!=</span> <span class="s2">&quot;NRML&quot;</span><span class="p">)</span>
            <span class="o">|</span> <span class="p">(</span><span class="n">msidset</span><span class="p">[</span><span class="s2">&quot;ctufmtsl&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">==</span> <span class="s2">&quot;FMT5&quot;</span><span class="p">)</span>
            <span class="o">|</span> <span class="p">(</span><span class="n">msidset</span><span class="p">[</span><span class="s2">&quot;c1sqax&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">vals</span> <span class="o">!=</span> <span class="s2">&quot;ENAB&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Telemetry indicates a safemode around 1999:221 which isn&#39;t real</span>
        <span class="n">bogus_tstart</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="s2">&quot;1999:225:12:00:00&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">secs</span>
        <span class="k">if</span> <span class="n">msidset</span><span class="o">.</span><span class="n">tstart</span> <span class="o">&lt;</span> <span class="n">bogus_tstart</span><span class="p">:</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="n">msidset</span><span class="o">.</span><span class="n">times</span> <span class="o">&lt;</span> <span class="n">bogus_tstart</span>
            <span class="n">safe_mode</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">msidset</span><span class="o">.</span><span class="n">times</span><span class="p">,</span> <span class="n">safe_mode</span></div></div>


<div class="viewcode-block" id="NormalSun"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.NormalSun">[docs]</a><span class="k">class</span> <span class="nc">NormalSun</span><span class="p">(</span><span class="n">TlmEvent</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normal sun mode event</span>

<span class="sd">    **Event definition**: interval when PCAD mode ``AOPCADMD = NSUN``</span>

<span class="sd">    During a safing event and recovery this MSID can toggle to different values,</span>
<span class="sd">    so NormalSun events within 4 hours of each other are merged.</span>

<span class="sd">    **Fields**</span>

<span class="sd">    ======== ========== ================================</span>
<span class="sd">     Field      Type              Description</span>
<span class="sd">    ======== ========== ================================</span>
<span class="sd">      start   Char(21)   Start time (YYYY:DDD:HH:MM:SS)</span>
<span class="sd">       stop   Char(21)    Stop time (YYYY:DDD:HH:MM:SS)</span>
<span class="sd">     tstart      Float            Start time (CXC secs)</span>
<span class="sd">      tstop      Float             Stop time (CXC secs)</span>
<span class="sd">        dur      Float                  Duration (secs)</span>
<span class="sd">      obsid    Integer        Observation ID (COBSRQID)</span>
<span class="sd">    ======== ========== ================================</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">event_msids</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;aopcadmd&quot;</span><span class="p">]</span>
    <span class="n">event_val</span> <span class="o">=</span> <span class="s2">&quot;NSUN&quot;</span>
    <span class="n">event_time_fuzz</span> <span class="o">=</span> <span class="mi">86400</span>  <span class="c1"># One full day of fuzz</span></div>


<div class="viewcode-block" id="MajorEvent"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.MajorEvent">[docs]</a><span class="k">class</span> <span class="nc">MajorEvent</span><span class="p">(</span><span class="n">BaseEvent</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Major event</span>

<span class="sd">    **Event definition**: events from the two lists maintained by the FOT and</span>
<span class="sd">      the FDB (systems engineering).</span>

<span class="sd">    Two lists of major event related to Chandra are available on OCCweb:</span>

<span class="sd">    - http://occweb.cfa.harvard.edu/occweb/web/fot_web/eng/reports/Chandra_major_events.htm</span>
<span class="sd">    - http://occweb.cfa.harvard.edu/occweb/web/fdb_web/Major_Events.html</span>

<span class="sd">    These two event lists are scraped from OCCweb and merged into a single list with a</span>
<span class="sd">    common structure.  Unlike most kadi event types, the MajorEvent class does not</span>
<span class="sd">    represent an interval of time (``start`` and ``stop``) but only has ``start``</span>
<span class="sd">    (YYYY:DOY) and ``date`` (YYYY-Mon-DD) attributes to indicate the time.</span>

<span class="sd">    **Fields**</span>

<span class="sd">    ======== ========== =============================================</span>
<span class="sd">     Field      Type                     Description</span>
<span class="sd">    ======== ========== =============================================</span>
<span class="sd">        key   Char(24)                     Unique key for this event</span>
<span class="sd">      start    Char(8)      Event time to the nearest day (YYYY:DOY)</span>
<span class="sd">       date   Char(11)   Event time to the nearest day (YYYY-Mon-DD)</span>
<span class="sd">     tstart      Float       Event time to the nearest day (CXC sec)</span>
<span class="sd">      descr       Text                             Event description</span>
<span class="sd">       note       Text          Note (comments or CAP # or FSW PR #)</span>
<span class="sd">     source    Char(3)                     Event source (FDB or FOT)</span>
<span class="sd">    ======== ========== =============================================</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">key</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Unique key for this event&quot;</span>
    <span class="p">)</span>
    <span class="n">key</span><span class="o">.</span><span class="n">_kadi_hidden</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
        <span class="n">db_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Event time to the nearest day (YYYY:DOY)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Event time to the nearest day (YYYY-Mon-DD)&quot;</span>
    <span class="p">)</span>
    <span class="n">tstart</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span>
        <span class="n">db_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Event time to the nearest day (CXC sec)&quot;</span>
    <span class="p">)</span>
    <span class="n">descr</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Event description&quot;</span><span class="p">)</span>
    <span class="n">note</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Note (comments or CAP # or FSW PR #)&quot;</span><span class="p">)</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Event source (FDB or FOT)&quot;</span><span class="p">)</span>

    <span class="c1"># Allow for hand-edits of the source HTML tables back about two years. Make</span>
    <span class="c1"># sure the lookback for getting new events is a bit further back than delete</span>
    <span class="c1"># lookback.</span>
    <span class="n">lookback</span> <span class="o">=</span> <span class="mi">365</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">10</span>
    <span class="n">lookback_delete</span> <span class="o">=</span> <span class="mi">365</span> <span class="o">*</span> <span class="mi">2</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">descr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">descr</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">descr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">:</span>
            <span class="n">descr</span> <span class="o">=</span> <span class="n">descr</span><span class="p">[:</span><span class="mi">27</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span>
        <span class="n">note</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">note</span>
        <span class="k">if</span> <span class="n">note</span><span class="p">:</span>
            <span class="n">descr</span> <span class="o">+=</span> <span class="s2">&quot; (&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="n">note</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">note</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">30</span> <span class="k">else</span> <span class="n">note</span><span class="p">[:</span><span class="mi">27</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">) </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="p">[</span><span class="mi">5</span><span class="p">:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">descr</span><span class="p">)</span>

<div class="viewcode-block" id="MajorEvent.get_events"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.MajorEvent.get_events">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_events</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get Major Events from FDB and FOT tables on the OCCweb</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">hashlib</span>

        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">scrape</span>

        <span class="n">tstart</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">secs</span>
        <span class="n">tstop</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span><span class="o">.</span><span class="n">secs</span>

        <span class="n">events</span> <span class="o">=</span> <span class="n">scrape</span><span class="o">.</span><span class="n">get_fot_major_events</span><span class="p">()</span> <span class="o">+</span> <span class="n">scrape</span><span class="o">.</span><span class="n">get_fdb_major_events</span><span class="p">()</span>

        <span class="c1"># Select events within time range and sort by tstart key</span>
        <span class="n">events</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">events</span> <span class="k">if</span> <span class="n">tstart</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">tstop</span><span class="p">),</span>
            <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># Manually generate a unique key for event since date is not unique</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;descr&quot;</span><span class="p">,</span> <span class="s2">&quot;note&quot;</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">))</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span>
                <span class="s2">&quot;ascii&quot;</span><span class="p">,</span> <span class="s2">&quot;replace&quot;</span>
            <span class="p">)</span>  <span class="c1"># Should already be clean ASCII but make sure</span>
            <span class="n">event</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">6</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">events</span></div></div>


<div class="viewcode-block" id="IFotEvent"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.IFotEvent">[docs]</a><span class="k">class</span> <span class="nc">IFotEvent</span><span class="p">(</span><span class="n">BaseEvent</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for events from the iFOT database</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ifot_id</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;iFOT identifier&quot;</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">db_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Start time (date)&quot;</span>
    <span class="p">)</span>
    <span class="n">stop</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Stop time (date)&quot;</span><span class="p">)</span>
    <span class="n">tstart</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">db_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Start time (CXC secs)&quot;</span><span class="p">)</span>
    <span class="n">tstop</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Stop time (CXC secs)&quot;</span><span class="p">)</span>
    <span class="n">dur</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Duration (secs)&quot;</span><span class="p">)</span>
    <span class="n">dur</span><span class="o">.</span><span class="n">_kadi_format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:.1f}</span><span class="s2">&quot;</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">abstract</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span>

    <span class="n">ifot_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;tstart&quot;</span><span class="p">,</span> <span class="s2">&quot;tstop&quot;</span><span class="p">]</span>
    <span class="n">ifot_props</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ifot_types</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Override automatic type inference for properties or columns</span>

<div class="viewcode-block" id="IFotEvent.get_events"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.IFotEvent.get_events">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_events</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get events from iFOT web interface</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">kadi</span> <span class="kn">import</span> <span class="n">occweb</span>

        <span class="n">datestart</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">date</span>
        <span class="n">datestop</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span><span class="o">.</span><span class="n">date</span>

        <span class="c1"># def get_ifot(event_type, start=None, stop=None, props=[], columns=[], timeout=TIMEOUT):</span>
        <span class="n">ifot_evts</span> <span class="o">=</span> <span class="n">occweb</span><span class="o">.</span><span class="n">get_ifot</span><span class="p">(</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">ifot_type_desc</span><span class="p">,</span>
            <span class="n">start</span><span class="o">=</span><span class="n">datestart</span><span class="p">,</span>
            <span class="n">stop</span><span class="o">=</span><span class="n">datestop</span><span class="p">,</span>
            <span class="n">props</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">ifot_props</span><span class="p">,</span>
            <span class="n">columns</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">ifot_columns</span><span class="p">,</span>
            <span class="n">types</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">ifot_types</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">events</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ifot_evt</span> <span class="ow">in</span> <span class="n">ifot_evts</span><span class="p">:</span>
            <span class="n">event</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="n">ifot_evt</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">ifot_type_desc</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">ifot_props</span>
            <span class="p">}</span>
            <span class="c1"># Prefer start or stop from props, but if not there use column tstart/tstop</span>
            <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;stop&quot;</span><span class="p">):</span>
                <span class="n">tst</span> <span class="o">=</span> <span class="s2">&quot;t</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">st</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">event</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">event</span><span class="p">[</span><span class="n">st</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                    <span class="n">event</span><span class="p">[</span><span class="n">st</span><span class="p">]</span> <span class="o">=</span> <span class="n">ifot_evt</span><span class="p">[</span><span class="n">tst</span><span class="p">]</span>
                <span class="c1"># The above still might not be OK because sometimes what is in the</span>
                <span class="c1"># &lt;prop&gt;.START/STOP values is not a valid date.</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">DateTime</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="n">st</span><span class="p">])</span><span class="o">.</span><span class="n">date</span>  <span class="c1"># noqa: B018</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="c1"># Fail, roll back to the tstart/tstop version</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s1">&#39;WARNING: Bad value of ifot_evt[</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">] = &quot;</span><span class="si">{}</span><span class="s1">&quot; at </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="bp">cls</span><span class="o">.</span><span class="n">ifot_type_desc</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">event</span><span class="p">[</span><span class="n">st</span><span class="p">],</span> <span class="n">ifot_evt</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">event</span><span class="p">[</span><span class="n">st</span><span class="p">]</span> <span class="o">=</span> <span class="n">ifot_evt</span><span class="p">[</span><span class="n">tst</span><span class="p">]</span>

            <span class="n">event</span><span class="p">[</span><span class="s2">&quot;ifot_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ifot_evt</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
            <span class="n">event</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">secs</span>
            <span class="n">event</span><span class="p">[</span><span class="s2">&quot;tstop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s2">&quot;stop&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">secs</span>
            <span class="n">event</span><span class="p">[</span><span class="s2">&quot;dur&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;tstop&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">]</span>

            <span class="c1"># Custom processing defined by subclasses to add more attrs to event</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;get_extras&quot;</span><span class="p">):</span>
                <span class="n">event</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">get_extras</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

            <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">events</span></div>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ifot_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">[:</span><span class="mi">17</span><span class="p">])</span></div>


<div class="viewcode-block" id="CAP"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.CAP">[docs]</a><span class="k">class</span> <span class="nc">CAP</span><span class="p">(</span><span class="n">IFotEvent</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CAP from iFOT database</span>

<span class="sd">    **Event definition**: CAP from iFOT database</span>

<span class="sd">    **Fields**</span>

<span class="sd">    ========= =========== =======================</span>
<span class="sd">      Field       Type          Description</span>
<span class="sd">    ========= =========== =======================</span>
<span class="sd">     ifot_id     Integer         iFOT identifier</span>
<span class="sd">       start    Char(21)       Start time (date)</span>
<span class="sd">        stop    Char(21)        Stop time (date)</span>
<span class="sd">      tstart       Float   Start time (CXC secs)</span>
<span class="sd">       tstop       Float    Stop time (CXC secs)</span>
<span class="sd">         dur       Float         Duration (secs)</span>
<span class="sd">         num    Char(15)              CAP number</span>
<span class="sd">       title        Text               CAP title</span>
<span class="sd">       descr        Text         CAP description</span>
<span class="sd">       notes        Text               CAP notes</span>
<span class="sd">        link   Char(250)                CAP link</span>
<span class="sd">    ========= =========== =======================</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">num</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;CAP number&quot;</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;CAP title&quot;</span><span class="p">)</span>
    <span class="n">descr</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;CAP description&quot;</span><span class="p">)</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;CAP notes&quot;</span><span class="p">)</span>
    <span class="n">link</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;CAP link&quot;</span><span class="p">)</span>

    <span class="n">ifot_type_desc</span> <span class="o">=</span> <span class="s2">&quot;CAP&quot;</span>
    <span class="n">ifot_props</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;NUM&quot;</span><span class="p">,</span> <span class="s2">&quot;START&quot;</span><span class="p">,</span> <span class="s2">&quot;STOP&quot;</span><span class="p">,</span> <span class="s2">&quot;TITLE&quot;</span><span class="p">,</span> <span class="s2">&quot;LINK&quot;</span><span class="p">,</span> <span class="s2">&quot;DESC&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">[:</span><span class="mi">17</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">)</span></div>


<div class="viewcode-block" id="LoadSegment"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.LoadSegment">[docs]</a><span class="k">class</span> <span class="nc">LoadSegment</span><span class="p">(</span><span class="n">IFotEvent</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load segment</span>

<span class="sd">    **Event definition**: Load segment from iFOT database</span>

<span class="sd">    **Fields**</span>

<span class="sd">    =========== ========== =======================</span>
<span class="sd">       Field       Type          Description</span>
<span class="sd">    =========== ========== =======================</span>
<span class="sd">       ifot_id    Integer         iFOT identifier</span>
<span class="sd">         start   Char(21)       Start time (date)</span>
<span class="sd">          stop   Char(21)        Stop time (date)</span>
<span class="sd">        tstart      Float   Start time (CXC secs)</span>
<span class="sd">         tstop      Float    Stop time (CXC secs)</span>
<span class="sd">           dur      Float         Duration (secs)</span>
<span class="sd">          name   Char(12)       Load segment name</span>
<span class="sd">           scs    Integer                SCS slot</span>
<span class="sd">     load_name   Char(10)               Load name</span>
<span class="sd">       comment       Text                 Comment</span>
<span class="sd">    =========== ========== =======================</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Load segment name&quot;</span><span class="p">)</span>
    <span class="n">scs</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;SCS slot&quot;</span><span class="p">)</span>
    <span class="n">load_name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Load name&quot;</span><span class="p">)</span>
    <span class="n">comment</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Comment&quot;</span><span class="p">)</span>

    <span class="n">ifot_type_desc</span> <span class="o">=</span> <span class="s2">&quot;LOADSEG&quot;</span>
    <span class="n">ifot_props</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;SCS&quot;</span><span class="p">,</span> <span class="s2">&quot;LOAD_NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;COMMENT&quot;</span><span class="p">]</span>

    <span class="n">lookback</span> <span class="o">=</span> <span class="mi">40</span>  <span class="c1"># days of lookback</span>
    <span class="n">lookback_delete</span> <span class="o">=</span> <span class="mi">20</span>  <span class="c1"># Remove load segments in database prior to 20 days ago</span>
    <span class="c1"># to account for potential load changes.</span>
    <span class="n">lookforward</span> <span class="o">=</span> <span class="mi">28</span>  <span class="c1"># Accept load segments planned up to 28 days in advance</span>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> scs=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">[:</span><span class="mi">17</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scs</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="PassPlan"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.PassPlan">[docs]</a><span class="k">class</span> <span class="nc">PassPlan</span><span class="p">(</span><span class="n">IFotEvent</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pass plan</span>

<span class="sd">    **Event definition**: Pass plan from iFOT</span>

<span class="sd">    **Fields**</span>

<span class="sd">    ==================== ========== =======================</span>
<span class="sd">           Field            Type          Description</span>
<span class="sd">    ==================== ========== =======================</span>
<span class="sd">                ifot_id    Integer         iFOT identifier</span>
<span class="sd">                  start   Char(21)       Start time (date)</span>
<span class="sd">                   stop   Char(21)        Stop time (date)</span>
<span class="sd">                 tstart      Float   Start time (CXC secs)</span>
<span class="sd">                  tstop      Float    Stop time (CXC secs)</span>
<span class="sd">                    dur      Float         Duration (secs)</span>
<span class="sd">                     oc   Char(30)                 OC crew</span>
<span class="sd">                     cc   Char(30)                 CC crew</span>
<span class="sd">                    got   Char(30)                GOT crew</span>
<span class="sd">                station    Char(6)             DSN station</span>
<span class="sd">           est_datetime   Char(20)              Date local</span>
<span class="sd">     sched_support_time   Char(13)            Support time</span>
<span class="sd">               activity   Char(20)                Activity</span>
<span class="sd">                    bot    Char(4)      Beginning of track</span>
<span class="sd">                    eot    Char(4)            End of track</span>
<span class="sd">              data_rate   Char(10)               Data rate</span>
<span class="sd">                 config    Char(8)           Configuration</span>
<span class="sd">                    lga    Char(1)                     LGA</span>
<span class="sd">                  power    Char(6)                   Power</span>
<span class="sd">                rxa_rsl   Char(10)                Rx-A RSL</span>
<span class="sd">                rxb_rsl   Char(10)                Rx-B RSL</span>
<span class="sd">                err_log   Char(10)               Error log</span>
<span class="sd">              cmd_count   Char(15)           Command count</span>
<span class="sd">    ==================== ========== =======================</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">oc</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;OC crew&quot;</span><span class="p">)</span>
    <span class="n">cc</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;CC crew&quot;</span><span class="p">)</span>
    <span class="n">got</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;GOT crew&quot;</span><span class="p">)</span>
    <span class="n">station</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;DSN station&quot;</span><span class="p">)</span>
    <span class="n">est_datetime</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Date local&quot;</span><span class="p">)</span>
    <span class="n">sched_support_time</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Support time&quot;</span><span class="p">)</span>
    <span class="n">activity</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Activity&quot;</span><span class="p">)</span>
    <span class="n">bot</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Beginning of track&quot;</span><span class="p">)</span>
    <span class="n">eot</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;End of track&quot;</span><span class="p">)</span>
    <span class="n">data_rate</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Data rate&quot;</span><span class="p">)</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Configuration&quot;</span><span class="p">)</span>
    <span class="n">lga</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;LGA&quot;</span><span class="p">)</span>
    <span class="n">power</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Power&quot;</span><span class="p">)</span>
    <span class="n">rxa_rsl</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Rx-A RSL&quot;</span><span class="p">)</span>
    <span class="n">rxb_rsl</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Rx-B RSL&quot;</span><span class="p">)</span>
    <span class="n">err_log</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Error log&quot;</span><span class="p">)</span>
    <span class="n">cmd_count</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Command count&quot;</span><span class="p">)</span>

    <span class="n">ifot_type_desc</span> <span class="o">=</span> <span class="s2">&quot;PASSPLAN&quot;</span>
    <span class="n">ifot_props</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;oc cc got station EST_datetime sched_support_time activity bot eot &quot;</span>
        <span class="s2">&quot;data_rate config lga power rxa_rsl rxb_rsl &quot;</span>
        <span class="s2">&quot;err_log cmd_count&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

    <span class="n">lookback</span> <span class="o">=</span> <span class="mi">21</span>  <span class="c1"># days of lookback</span>
    <span class="n">lookback_delete</span> <span class="o">=</span> <span class="mi">7</span>  <span class="c1"># Remove all comms in database prior to 7 days ago to account</span>
    <span class="c1"># for potential schedule changes.</span>
    <span class="n">lookforward</span> <span class="o">=</span> <span class="mi">28</span>  <span class="c1"># Accept comms scheduled up to 28 days in advance</span>

    <span class="n">update_priority</span> <span class="o">=</span> <span class="mi">500</span>  <span class="c1"># Must be before DsnComm</span>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> OC:</span><span class="si">{}</span><span class="s2"> CC:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">station</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">[:</span><span class="mi">17</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">est_datetime</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">oc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="DsnComm"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.DsnComm">[docs]</a><span class="k">class</span> <span class="nc">DsnComm</span><span class="p">(</span><span class="n">IFotEvent</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    DSN comm period</span>

<span class="sd">    **Event definition**: DSN comm pass beginning of support to end of support (not</span>
<span class="sd">      beginning / end of track).</span>

<span class="sd">    **Fields**</span>

<span class="sd">    =========== ========== ========================</span>
<span class="sd">       Field       Type          Description</span>
<span class="sd">    =========== ========== ========================</span>
<span class="sd">       ifot_id    Integer          iFOT identifier</span>
<span class="sd">         start   Char(21)        Start time (date)</span>
<span class="sd">          stop   Char(21)         Stop time (date)</span>
<span class="sd">        tstart      Float    Start time (CXC secs)</span>
<span class="sd">         tstop      Float     Stop time (CXC secs)</span>
<span class="sd">           dur      Float          Duration (secs)</span>
<span class="sd">           bot    Char(4)       Beginning of track</span>
<span class="sd">           eot    Char(4)             End of track</span>
<span class="sd">      activity   Char(30)     Activity description</span>
<span class="sd">        config   Char(10)            Configuration</span>
<span class="sd">     data_rate    Char(9)                Data rate</span>
<span class="sd">          site   Char(12)                 DSN site</span>
<span class="sd">           soe    Char(4)   DSN Sequence Of Events</span>
<span class="sd">       station    Char(6)              DSN station</span>
<span class="sd">            oc   Char(30)                  OC crew</span>
<span class="sd">            cc   Char(30)                  CC crew</span>
<span class="sd">     pass_plan   OneToOne                Pass plan</span>
<span class="sd">    =========== ========== ========================</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">bot</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Beginning of track&quot;</span><span class="p">)</span>
    <span class="n">eot</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;End of track&quot;</span><span class="p">)</span>
    <span class="n">activity</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Activity description&quot;</span><span class="p">)</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Configuration&quot;</span><span class="p">)</span>
    <span class="n">data_rate</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Data rate&quot;</span><span class="p">)</span>
    <span class="n">site</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;DSN site&quot;</span><span class="p">)</span>
    <span class="n">soe</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;DSN Sequence Of Events&quot;</span><span class="p">)</span>
    <span class="n">station</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;DSN station&quot;</span><span class="p">)</span>
    <span class="n">oc</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;OC crew&quot;</span><span class="p">)</span>
    <span class="n">cc</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;CC crew&quot;</span><span class="p">)</span>
    <span class="n">pass_plan</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">OneToOneField</span><span class="p">(</span>
        <span class="n">PassPlan</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Pass plan&quot;</span><span class="p">,</span>
        <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">related_name</span><span class="o">=</span><span class="s2">&quot;dsn_comm&quot;</span><span class="p">,</span>
        <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">ifot_type_desc</span> <span class="o">=</span> <span class="s2">&quot;DSN_COMM&quot;</span>
    <span class="n">ifot_props</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;bot&quot;</span><span class="p">,</span>
        <span class="s2">&quot;eot&quot;</span><span class="p">,</span>
        <span class="s2">&quot;activity&quot;</span><span class="p">,</span>
        <span class="s2">&quot;config&quot;</span><span class="p">,</span>
        <span class="s2">&quot;data_rate&quot;</span><span class="p">,</span>
        <span class="s2">&quot;site&quot;</span><span class="p">,</span>
        <span class="s2">&quot;soe&quot;</span><span class="p">,</span>
        <span class="s2">&quot;station&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">ifot_types</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;DSN_COMM.bot&quot;</span><span class="p">:</span> <span class="s2">&quot;str&quot;</span><span class="p">,</span> <span class="s2">&quot;DSN_COMM.eot&quot;</span><span class="p">:</span> <span class="s2">&quot;str&quot;</span><span class="p">}</span>

    <span class="n">lookback</span> <span class="o">=</span> <span class="mi">21</span>  <span class="c1"># days of lookback</span>
    <span class="n">lookback_delete</span> <span class="o">=</span> <span class="mi">7</span>  <span class="c1"># Remove all comms in database prior to 7 days ago to account</span>
    <span class="c1"># for potential schedule changes.</span>
    <span class="n">lookforward</span> <span class="o">=</span> <span class="mi">28</span>  <span class="c1"># Accept comms scheduled up to 28 days in advance</span>

<div class="viewcode-block" id="DsnComm.get_extras"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.DsnComm.get_extras">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_extras</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">event_msidset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define OC, CC and pass_plan if available</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">pass_plans</span> <span class="o">=</span> <span class="n">PassPlan</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">event</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pass_plans</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Multiple pass plans possible (e.g. two stations), just take first</span>
            <span class="n">pass_plan</span> <span class="o">=</span> <span class="n">pass_plans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;oc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pass_plan</span><span class="o">.</span><span class="n">oc</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;cc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pass_plan</span><span class="o">.</span><span class="n">cc</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;pass_plan&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pass_plan</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pass_plans</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Multiple pass plans found at </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">],</span> <span class="n">pass_plans</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span></div>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">station</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">[:</span><span class="mi">17</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">bot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">activity</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Orbit"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.Orbit">[docs]</a><span class="k">class</span> <span class="nc">Orbit</span><span class="p">(</span><span class="n">BaseEvent</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Orbit</span>

<span class="sd">    **Event definition**: single Chandra orbit starting from ascending node crossing</span>

<span class="sd">    Full orbit, with dates corresponding to start (ORBIT ASCENDING NODE CROSSING), stop,</span>
<span class="sd">    apogee, perigee, radzone start and radzone stop.  Radzone is defined as the time</span>
<span class="sd">    covering perigee when radmon is disabled by command.  This corresponds to the planned</span>
<span class="sd">    values and may differ from actual in the case of events that run SCS107 and</span>
<span class="sd">    prematurely disable RADMON.</span>

<span class="sd">    **Fields**</span>

<span class="sd">    ================== ========== ==================================================</span>
<span class="sd">          Field           Type                       Description</span>
<span class="sd">    ================== ========== ==================================================</span>
<span class="sd">                start   Char(21)         Start time (orbit ascending node crossing)</span>
<span class="sd">                 stop   Char(21)     Stop time (next orbit ascending node crossing)</span>
<span class="sd">               tstart      Float         Start time (orbit ascending node crossing)</span>
<span class="sd">                tstop      Float     Stop time (next orbit ascending node crossing)</span>
<span class="sd">                  dur      Float                               Orbit duration (sec)</span>
<span class="sd">            orbit_num    Integer                                       Orbit number</span>
<span class="sd">              perigee   Char(21)                                       Perigee time</span>
<span class="sd">               apogee   Char(21)                                        Apogee time</span>
<span class="sd">            t_perigee      Float                             Perigee time (CXC sec)</span>
<span class="sd">        start_radzone   Char(21)                             Start time of rad zone</span>
<span class="sd">         stop_radzone   Char(21)                              Stop time of rad zone</span>
<span class="sd">     dt_start_radzone      Float   Start time of rad zone relative to perigee (sec)</span>
<span class="sd">      dt_stop_radzone      Float    Stop time of rad zone relative to perigee (sec)</span>
<span class="sd">    ================== ========== ==================================================</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Start time (orbit ascending node crossing)&quot;</span>
    <span class="p">)</span>
    <span class="n">stop</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Stop time (next orbit ascending node crossing)&quot;</span>
    <span class="p">)</span>
    <span class="n">tstart</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span>
        <span class="n">db_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Start time (orbit ascending node crossing)&quot;</span>
    <span class="p">)</span>
    <span class="n">tstop</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Stop time (next orbit ascending node crossing)&quot;</span>
    <span class="p">)</span>
    <span class="n">dur</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Orbit duration (sec)&quot;</span><span class="p">)</span>
    <span class="n">orbit_num</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Orbit number&quot;</span><span class="p">)</span>
    <span class="n">perigee</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Perigee time&quot;</span><span class="p">)</span>
    <span class="n">apogee</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Apogee time&quot;</span><span class="p">)</span>
    <span class="n">t_perigee</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Perigee time (CXC sec)&quot;</span><span class="p">)</span>
    <span class="n">start_radzone</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Start time of rad zone&quot;</span><span class="p">)</span>
    <span class="n">stop_radzone</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Stop time of rad zone&quot;</span><span class="p">)</span>
    <span class="n">dt_start_radzone</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Start time of rad zone relative to perigee (sec)&quot;</span>
    <span class="p">)</span>
    <span class="n">dt_stop_radzone</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Stop time of rad zone relative to perigee (sec)&quot;</span>
    <span class="p">)</span>
    <span class="n">dur</span><span class="o">.</span><span class="n">_kadi_format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:.1f}</span><span class="s2">&quot;</span>
    <span class="n">t_perigee</span><span class="o">.</span><span class="n">_kadi_format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:.1f}</span><span class="s2">&quot;</span>
    <span class="n">dt_start_radzone</span><span class="o">.</span><span class="n">_kadi_format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:.1f}</span><span class="s2">&quot;</span>
    <span class="n">dt_stop_radzone</span><span class="o">.</span><span class="n">_kadi_format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:.1f}</span><span class="s2">&quot;</span>

    <span class="n">lookforward</span> <span class="o">=</span> <span class="mi">28</span>  <span class="c1"># Accept orbits planned up to 28 days in advance</span>

<div class="viewcode-block" id="Orbit.get_events"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.Orbit.get_events">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_events</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get Orbit Events from timeline reports.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">orbit_funcs</span>

        <span class="n">datestart</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">date</span>
        <span class="n">datestop</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span><span class="o">.</span><span class="n">date</span>
        <span class="n">years</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="n">datestart</span><span class="p">,</span> <span class="n">datestop</span><span class="p">)))</span>
        <span class="n">file_dates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">years</span><span class="p">:</span>
            <span class="n">file_dates</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">orbit_funcs</span><span class="o">.</span><span class="n">get_tlr_files</span><span class="p">(</span><span class="n">year</span><span class="p">))</span>
        <span class="n">tlr_files</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">x</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">file_dates</span> <span class="k">if</span> <span class="n">datestart</span> <span class="o">&lt;=</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">datestop</span>
        <span class="p">]</span>

        <span class="c1"># Get all orbit points from the tlr files as a list of tuples</span>
        <span class="n">orbit_points</span> <span class="o">=</span> <span class="n">orbit_funcs</span><span class="o">.</span><span class="n">get_orbit_points</span><span class="p">(</span><span class="n">tlr_files</span><span class="p">)</span>

        <span class="c1"># Process the points, doing various cleanup and return as a np.array</span>
        <span class="n">orbit_points</span> <span class="o">=</span> <span class="n">orbit_funcs</span><span class="o">.</span><span class="n">process_orbit_points</span><span class="p">(</span><span class="n">orbit_points</span><span class="p">)</span>

        <span class="c1"># Get the orbits from the orbit points</span>
        <span class="n">orbits</span> <span class="o">=</span> <span class="n">orbit_funcs</span><span class="o">.</span><span class="n">get_orbits</span><span class="p">(</span><span class="n">orbit_points</span><span class="p">)</span>

        <span class="n">events</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">orbit</span> <span class="ow">in</span> <span class="n">orbits</span><span class="p">:</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="n">orbit_points</span><span class="p">[</span><span class="s2">&quot;orbit_num&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">orbit</span><span class="p">[</span><span class="s2">&quot;orbit_num&quot;</span><span class="p">]</span>
            <span class="n">event</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">orbit</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">orbit</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">}</span>
            <span class="n">event</span><span class="p">[</span><span class="s2">&quot;foreign&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;OrbitPoint&quot;</span><span class="p">:</span> <span class="n">orbit_points</span><span class="p">[</span><span class="n">ok</span><span class="p">],</span>
                <span class="s2">&quot;RadZone&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">orbit_funcs</span><span class="o">.</span><span class="n">get_radzone_from_orbit</span><span class="p">(</span><span class="n">orbit</span><span class="p">)],</span>
            <span class="p">}</span>
            <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">events</span></div>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> dur=</span><span class="si">{:.1f}</span><span class="s2"> radzone=</span><span class="si">{:.1f}</span><span class="s2"> to </span><span class="si">{:.1f}</span><span class="s2"> ksec&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">orbit_num</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">[:</span><span class="mi">17</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dur</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dt_start_radzone</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dt_stop_radzone</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="OrbitPoint"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.OrbitPoint">[docs]</a><span class="k">class</span> <span class="nc">OrbitPoint</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Orbit point</span>

<span class="sd">    **Fields**</span>

<span class="sd">    =========== ============ ===========</span>
<span class="sd">       Field        Type     Description</span>
<span class="sd">    =========== ============ ===========</span>
<span class="sd">         orbit   ForeignKey</span>
<span class="sd">          date     Char(21)</span>
<span class="sd">          name      Char(9)</span>
<span class="sd">     orbit_num      Integer</span>
<span class="sd">         descr     Char(50)</span>
<span class="sd">    =========== ============ ===========</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">orbit</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Orbit</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">21</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">9</span><span class="p">)</span>
    <span class="n">orbit_num</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">()</span>
    <span class="n">descr</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> (orbit </span><span class="si">{}</span><span class="s2">) </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">date</span><span class="p">[:</span><span class="mi">17</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbit_num</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">descr</span><span class="p">[:</span><span class="mi">30</span><span class="p">]</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="RadZone"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.RadZone">[docs]</a><span class="k">class</span> <span class="nc">RadZone</span><span class="p">(</span><span class="n">Event</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Radiation zone</span>

<span class="sd">    **Fields**</span>

<span class="sd">    =========== ============ ================================</span>
<span class="sd">       Field        Type               Description</span>
<span class="sd">    =========== ============ ================================</span>
<span class="sd">         start     Char(21)   Start time (YYYY:DDD:HH:MM:SS)</span>
<span class="sd">          stop     Char(21)    Stop time (YYYY:DDD:HH:MM:SS)</span>
<span class="sd">        tstart        Float            Start time (CXC secs)</span>
<span class="sd">         tstop        Float             Stop time (CXC secs)</span>
<span class="sd">           dur        Float                  Duration (secs)</span>
<span class="sd">         orbit   ForeignKey</span>
<span class="sd">     orbit_num      Integer</span>
<span class="sd">       perigee     Char(21)</span>
<span class="sd">    =========== ============ ================================</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">orbit</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Orbit</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="n">orbit_num</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">()</span>
    <span class="n">perigee</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">21</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> dur=</span><span class="si">{:.1f}</span><span class="s2"> ksec&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">orbit_num</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">[:</span><span class="mi">17</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">[:</span><span class="mi">17</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dur</span> <span class="o">/</span> <span class="mi">1000</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="AsciiTableEvent"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.AsciiTableEvent">[docs]</a><span class="k">class</span> <span class="nc">AsciiTableEvent</span><span class="p">(</span><span class="n">BaseEvent</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for events defined by a simple quasi-static text table file.</span>
<span class="sd">    Subclasses need to define the file name (lives in DATA_DIR()/&lt;filename&gt;)</span>
<span class="sd">    and the start and stop column names.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">abstract</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="AsciiTableEvent.get_extras"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.AsciiTableEvent.get_extras">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_extras</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">interval</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get extra stuff for the event based on fields in the interval.  This is a hook</span>
<span class="sd">        within get_events() that should be overridden in individual classes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="AsciiTableEvent.get_events"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.AsciiTableEvent.get_events">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_events</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get events from telemetry defined by a simple rule that the value of</span>
<span class="sd">        `event_msids[0]` == `event_val`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">kadi.paths</span> <span class="kn">import</span> <span class="n">DATA_DIR</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">date</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span><span class="o">.</span><span class="n">date</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">intervals_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">absolute</span><span class="p">():</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">(),</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">intervals</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="o">**</span><span class="bp">cls</span><span class="o">.</span><span class="n">table_read_kwargs</span><span class="p">)</span>  <span class="c1"># noqa</span>

        <span class="c1"># Custom in-place processing of raw intervals</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">process_intervals</span><span class="p">(</span><span class="n">intervals</span><span class="p">)</span>

        <span class="n">ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">DateTime</span><span class="p">(</span><span class="n">intervals</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">start_column</span><span class="p">])</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;</span> <span class="n">start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
            <span class="n">DateTime</span><span class="p">(</span><span class="n">intervals</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">stop_column</span><span class="p">])</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;</span> <span class="n">stop</span>
        <span class="p">)</span>

        <span class="c1"># Assemble a list of dicts corresponding to events in this tlm interval</span>
        <span class="n">events</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">interval</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">[</span><span class="n">ok</span><span class="p">]:</span>
            <span class="n">tstart</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">interval</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">start_column</span><span class="p">])</span><span class="o">.</span><span class="n">secs</span>
            <span class="n">tstop</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">interval</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">stop_column</span><span class="p">])</span><span class="o">.</span><span class="n">secs</span>
            <span class="n">event</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">tstart</span><span class="o">=</span><span class="n">tstart</span><span class="p">,</span>
                <span class="n">tstop</span><span class="o">=</span><span class="n">tstop</span><span class="p">,</span>
                <span class="n">dur</span><span class="o">=</span><span class="n">tstop</span> <span class="o">-</span> <span class="n">tstart</span><span class="p">,</span>
                <span class="n">start</span><span class="o">=</span><span class="n">DateTime</span><span class="p">(</span><span class="n">tstart</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                <span class="n">stop</span><span class="o">=</span><span class="n">DateTime</span><span class="p">(</span><span class="n">tstop</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Reject events that are shorter than the minimum duration</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;event_min_dur&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;dur&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">cls</span><span class="o">.</span><span class="n">event_min_dur</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Custom processing defined by subclasses to add more attrs to event</span>
            <span class="n">event</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">get_extras</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">interval</span><span class="p">))</span>

            <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">events</span></div></div>


<div class="viewcode-block" id="LttBad"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.LttBad">[docs]</a><span class="k">class</span> <span class="nc">LttBad</span><span class="p">(</span><span class="n">AsciiTableEvent</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    LTT bad intervals</span>

<span class="sd">    **Fields**</span>

<span class="sd">    ======== ========== ================================</span>
<span class="sd">     Field      Type              Description</span>
<span class="sd">    ======== ========== ================================</span>
<span class="sd">        key   Char(38)        Unique key for this event</span>
<span class="sd">      start   Char(21)   Start time (YYYY:DDD:HH:MM:SS)</span>
<span class="sd">       stop   Char(21)    Stop time (YYYY:DDD:HH:MM:SS)</span>
<span class="sd">     tstart      Float            Start time (CXC secs)</span>
<span class="sd">      tstop      Float             Stop time (CXC secs)</span>
<span class="sd">        dur      Float                  Duration (secs)</span>
<span class="sd">       msid   Char(20)                             MSID</span>
<span class="sd">       flag    Char(2)                             Flag</span>
<span class="sd">    ======== ========== ================================</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">key</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">38</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Unique key for this event&quot;</span>
    <span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Start time (YYYY:DDD:HH:MM:SS)&quot;</span><span class="p">)</span>
    <span class="n">stop</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Stop time (YYYY:DDD:HH:MM:SS)&quot;</span><span class="p">)</span>
    <span class="n">tstart</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">db_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Start time (CXC secs)&quot;</span><span class="p">)</span>
    <span class="n">tstop</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Stop time (CXC secs)&quot;</span><span class="p">)</span>
    <span class="n">dur</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Duration (secs)&quot;</span><span class="p">)</span>
    <span class="n">msid</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;MSID&quot;</span><span class="p">)</span>
    <span class="n">flag</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Flag&quot;</span><span class="p">)</span>

    <span class="n">key</span><span class="o">.</span><span class="n">_kadi_hidden</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">dur</span><span class="o">.</span><span class="n">_kadi_format</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:.1f}</span><span class="s2">&quot;</span>

    <span class="n">intervals_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;share&quot;</span> <span class="o">/</span> <span class="s2">&quot;kadi&quot;</span> <span class="o">/</span> <span class="s2">&quot;ltt_bads.dat&quot;</span>
    <span class="c1"># Table.read keyword args</span>
    <span class="n">table_read_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;ascii&quot;</span><span class="p">,</span> <span class="n">data_start</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;|&quot;</span><span class="p">,</span> <span class="n">guess</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_values</span><span class="o">=</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="n">start_column</span> <span class="o">=</span> <span class="s2">&quot;start&quot;</span>
    <span class="n">stop_column</span> <span class="o">=</span> <span class="s2">&quot;stop&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">process_intervals</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">intervals</span><span class="p">):</span>
        <span class="n">intervals</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">intervals</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">date</span>
        <span class="n">intervals</span><span class="p">[</span><span class="s2">&quot;stop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">DateTime</span><span class="p">(</span><span class="n">intervals</span><span class="p">[</span><span class="s2">&quot;tstart&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">date</span>
        <span class="n">intervals</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="LttBad.get_extras"><a class="viewcode-back" href="../../../api_events.html#kadi.events.models.LttBad.get_extras">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_extras</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">interval</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;msid&quot;</span><span class="p">,</span> <span class="s2">&quot;flag&quot;</span><span class="p">):</span>
            <span class="n">out</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">interval</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">][:</span><span class="mi">17</span><span class="p">]</span> <span class="o">+</span> <span class="n">out</span><span class="p">[</span><span class="s2">&quot;msid&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">out</span></div>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;start=</span><span class="si">{}</span><span class="s2"> msid=</span><span class="si">{}</span><span class="s2"> flag=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">msid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flag</span><span class="p">)</span></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/ska.png" alt="Logo"/>
            </a></p><h3>Page Contents</h3>


<form action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2013, Tom Aldcroft.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 6.1.3. &nbsp;
  </p>
</footer>
  </body>
</html>